<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Test - Ready to Go</title>

    <!-- API Configuration (create config.js with your API keys) -->
    <script src="config.js"></script>

    <!-- Fabric.js 5.3.0 for advanced canvas text rendering with better gradients and effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- Google Fonts for professional typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            height: 100vh;
            display: grid;
            grid-template-columns: 500px 1fr;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }

        /* Photo Upload - In Sidebar */
        .photo-upload-section {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(184,134,11,0.03);
        }

        .photo-upload-label {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: block;
        }

        .photo-upload-btn {
            width: 100%;
            padding: 12px;
            background: rgba(184,134,11,0.15);
            border: 1px dashed rgba(184,134,11,0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #DAA520;
            font-size: 0.9rem;
        }

        .photo-upload-btn:hover {
            background: rgba(184,134,11,0.25);
            border-color: #B8860B;
            border-style: solid;
        }

        .photo-preview-container {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(184,134,11,0.1);
            border: 1px solid rgba(184,134,11,0.3);
            border-radius: 8px;
        }

        .photo-preview-container.active {
            display: flex;
        }

        .photo-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #B8860B;
            object-fit: cover;
        }

        .photo-info {
            flex: 1;
            min-width: 0;
        }

        .photo-filename {
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-size {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
        }

        .photo-remove {
            width: 32px;
            height: 32px;
            background: rgba(220,53,69,0.2);
            border: 1px solid rgba(220,53,69,0.4);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #dc3545;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .photo-remove:hover {
            background: #dc3545;
            color: white;
            transform: scale(1.05);
        }

        #imageUpload {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, rgba(184,134,11,0.08) 0%, rgba(218,165,32,0.05) 100%);
            padding: 25px 30px;
            border-bottom: 1px solid rgba(184,134,11,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            grid-column: 1 / -1;
            position: relative;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            color: #DAA520;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1::after {
            content: 'MARKETING';
            font-size: 0.65rem;
            font-weight: 700;
            padding: 4px 10px;
            background: linear-gradient(135deg, #ff073a 0%, #e63946 100%);
            color: white;
            border-radius: 6px;
            letter-spacing: 1px;
            box-shadow: 0 2px 10px rgba(255,7,58,0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(184,134,11,0.1);
            border: 1px solid rgba(184,134,11,0.3);
            border-radius: 20px;
            color: #F5F5DC;
            font-size: 0.9rem;
        }

        .settings-btn {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(184,134,11,0.2);
            border-color: #DAA520;
            color: #DAA520;
            transform: rotate(90deg);
        }

        .sidebar {
            background: rgba(10,10,10,0.8);
            border-right: 1px solid rgba(184,134,11,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            color: #DAA520;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 0 15px rgba(218,165,32,0.3);
        }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .search-box:focus {
            outline: none;
            border-color: rgba(184,134,11,0.5);
            background: rgba(255,255,255,0.08);
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .template-library {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .template-category {
            margin-bottom: 5px;
        }

        .category-header {
            padding: 12px 20px;
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .category-header:hover {
            color: #DAA520;
            background: rgba(184,134,11,0.05);
        }

        .category-icon {
            font-size: 1rem;
        }

        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .template-category.active .category-items {
            max-height: 500px;
        }

        .template-item {
            padding: 10px 20px 10px 48px;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .template-item:hover {
            background: rgba(184,134,11,0.1);
            color: white;
            border-left-color: #DAA520;
            transform: translateX(5px);
        }

        .template-item.active {
            background: rgba(184,134,11,0.2);
            color: #DAA520;
            border-left-color: #DAA520;
            box-shadow: 0 0 15px rgba(218,165,32,0.3);
        }

        .preview-area {
            background: linear-gradient(180deg, rgba(15,15,15,1) 0%, rgba(10,10,10,1) 100%);
            display: flex;
            flex-direction: column;
            padding: 40px 40px 160px 40px;
            overflow-y: auto;
            position: relative;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .preview-area.empty {
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.3);
            font-size: 1.5rem;
            text-align: center;
        }

        .preview-header {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .image-gallery {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            width: 100%;
        }

        .image-item {
            background: rgba(15,15,15,0.6);
            border: 2px solid rgba(184,134,11,0.2);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.4s ease;
            cursor: pointer;
            max-width: 700px;
            width: 100%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease;
        }

        .image-item:hover {
            border-color: #DAA520;
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(218,165,32,0.4);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .image-item.selected {
            border-color: #20c997;
            box-shadow: 0 8px 30px rgba(32,201,151,0.4);
        }

        .image-item img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .image-item img:hover {
            opacity: 0.9;
        }

        .image-item-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .image-item-prompt {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            flex: 1;
            line-height: 1.4;
        }

        .image-item-actions {
            display: flex;
            gap: 8px;
        }

        .image-item-actions button {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .image-item-actions button:hover {
            background: #DAA520;
            border-color: #DAA520;
        }

        .preview-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .preview-controls button {
            padding: 10px 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .preview-controls button:hover {
            background: rgba(218,165,32,0.8);
            border-color: #DAA520;
        }

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
            color: white;
            max-width: 85%;
        }

        .message.assistant {
            align-self: flex-start;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            max-width: 85%;
        }

        .message strong {
            font-size: 0.9rem;
            display: block;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message .loading {
            display: inline-block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .input-container {
            padding: 20px;
            background: #1a1a1a;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #messageInput {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(184,134,11,0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
        }

        #messageInput::placeholder {
            color: rgba(255,255,255,0.5);
        }

        #messageInput:focus {
            outline: none;
            border-color: #DAA520;
            background: rgba(255,255,255,0.1);
        }

        #sendBtn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            width: 100%;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(218,165,32,0.5);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .examples {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255,215,0,0.05);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 6px;
        }

        .examples strong {
            color: #FFD700;
            font-size: 0.9rem;
        }

        .examples .example {
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 6px;
            margin: 4px 0;
            border-radius: 4px;
            transition: all 0.2s;
            display: block;
            font-size: 0.85rem;
        }

        .examples .example:hover {
            background: rgba(184,134,11,0.1);
            color: white;
        }

        .download-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .download-btn:hover {
            background: #218838;
        }

        /* Platform Export Buttons */
        .platform-export-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .platform-export-label {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .platform-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .platform-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.05);
            border: 1.5px solid rgba(184,134,11,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            position: relative;
        }

        .platform-btn:hover {
            background: rgba(184,134,11,0.15);
            border-color: #DAA520;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(218,165,32,0.3);
        }

        .platform-btn .icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .platform-btn .icon svg {
            width: 20px;
            height: 20px;
        }

        .platform-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(184,134,11,0.4);
            border-radius: 8px;
            padding: 8px;
            min-width: 180px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }

        .platform-btn:hover .platform-dropdown,
        .platform-dropdown:hover {
            display: block;
        }

        .platform-format-option {
            padding: 10px 12px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .platform-format-option:hover {
            background: rgba(184,134,11,0.2);
            color: #DAA520;
        }

        .platform-format-option .dimensions {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-left: 8px;
        }

        .platform-format-option.default::after {
            content: '‚úì';
            color: #DAA520;
            font-weight: bold;
            margin-left: 8px;
        }

        .platform-generating {
            opacity: 0.6;
            pointer-events: none;
        }

        .platform-generating::after {
            content: '‚è≥';
            margin-left: 6px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Chat Overlay - Minimal at bottom of preview */
        .chat-overlay {
            position: fixed;
            bottom: 0;
            left: 500px;
            right: 0;
            background: linear-gradient(to top, rgba(10,10,10,0.98) 0%, rgba(10,10,10,0.95) 80%, transparent 100%);
            padding: 25px 40px;
            border-top: 1px solid rgba(184,134,11,0.3);
            backdrop-filter: blur(20px);
            z-index: 100;
            box-shadow: 0 -5px 30px rgba(218,165,32,0.2);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Owl Container with Particles (Reduced 30% from 140px to 98px) */
        .owl-container {
            position: relative;
            width: 98px;
            height: 98px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Glow background effect */
        .wisr-glow {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 200, 81, 0.4) 0%, transparent 70%);
            filter: blur(40px);
            animation: pulse-glow 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        /* Circular video container with border */
        .wisr-video-circle {
            width: 98px;
            height: 98px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            background: black;
            box-shadow:
                0 14px 42px rgba(251, 191, 36, 0.6),
                0 0 70px rgba(0, 200, 81, 0.3);
            border: 2px solid transparent;
            background-image: linear-gradient(#000, #000),
                              linear-gradient(135deg, rgba(251, 191, 36, 0.8), rgba(0, 200, 81, 0.8));
            background-origin: border-box;
            background-clip: padding-box, border-box;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .wisr-video-circle video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            filter: saturate(1.3) contrast(1.2) brightness(1.1);
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 50%;
            opacity: 0.95;
        }

        /* Video mask overlay for vignette effect */
        .video-mask-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center,
                transparent 40%,
                rgba(0, 0, 0, 0.3) 70%,
                rgba(0, 0, 0, 0.8) 100%);
            pointer-events: none;
            border-radius: 50%;
            z-index: 2;
        }

        /* Working state - enhanced glow and rotation */
        .owl-container.working .wisr-video-circle {
            transform: scale(1.05);
            box-shadow:
                0 18px 56px rgba(251, 191, 36, 0.8),
                0 0 84px rgba(0, 200, 81, 0.5);
            animation: border-rotate 3s linear infinite;
        }

        @keyframes border-rotate {
            0% {
                filter: hue-rotate(0deg);
            }
            100% {
                filter: hue-rotate(360deg);
            }
        }

        .owl-container.working .wisr-glow {
            animation: pulse-glow-intense 1.5s ease-in-out infinite;
        }

        @keyframes pulse-glow-intense {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1.1);
            }
            50% {
                opacity: 1;
                transform: scale(1.3);
            }
        }

        /* Particle canvas overlay - matches owl circle size */
        .particle-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 98px;
            height: 98px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2; /* Between video circle (1) and mask (2) - particles around owl */
            overflow: hidden;
        }

        .particle-canvas.active {
            opacity: 1;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(184,134,11,0.3);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
            border-color: #DAA520;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(218,165,32,0.2);
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .chat-send-btn {
            min-width: 140px;
            padding: 16px 28px;
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(218,165,32,0.3);
        }

        .chat-send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(218,165,32,0.5);
            background: linear-gradient(135deg, #B8860B 0%, #DAA520 100%);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <!-- Hidden file input for photo upload -->
    <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">

    <div class="header">
        <div class="header-left">
            <h1>ü¶â WISR AI Marketing Generator</h1>
        </div>
        <div class="header-right">
            <div class="user-badge">
                <span>üë§</span>
                <span id="userNameDisplay">David Young</span>
            </div>
            <div class="settings-btn" title="Settings">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üìö Template Library</h2>
            <input type="text" class="search-box" id="templateSearch" placeholder="Search templates...">
        </div>

        <!-- Photo Upload Section -->
        <div class="photo-upload-section">
            <label class="photo-upload-label">üì∑ Your Photo (Optional)</label>

            <div class="photo-upload-btn" id="photoUploadBtn" onclick="document.getElementById('imageUpload').click()">
                <span>üì∏</span>
                <span>Upload Photo</span>
            </div>

            <div class="photo-preview-container" id="photoPreviewContainer">
                <img id="photoAvatar" class="photo-avatar" src="" alt="Your photo">
                <div class="photo-info">
                    <div class="photo-filename" id="photoFilename">photo.jpg</div>
                    <div class="photo-size">Click to change</div>
                </div>
                <div class="photo-remove" onclick="removeImage()" title="Remove photo">
                    ‚úï
                </div>
            </div>
        </div>

        <div class="template-library" id="templateLibrary">
            <!-- Templates will be dynamically loaded here -->
        </div>
    </div>

    <div class="preview-area empty" id="previewArea">
        <!-- Hero Section (shown when empty) -->
        <div id="emptyMessage" style="text-align: center; max-width: 700px;">
            <h1 style="color: #DAA520; font-size: 3rem; font-weight: 700; margin-bottom: 20px; text-shadow: 0 0 30px rgba(218,165,32,0.5);">
                AI Marketing Generator
            </h1>
            <p style="color: rgba(255,255,255,0.7); font-size: 1.2rem; margin-bottom: 40px; line-height: 1.6;">
                Content Gallery ¬∑ Template Showcase ¬∑ Marketing Resources
            </p>
            <p style="color: rgba(255,255,255,0.5); font-size: 1rem; line-height: 1.8;">
                Create professional mortgage marketing materials in seconds. Select a template from the left sidebar to generate stunning visuals for social media, emails, and client communications.
            </p>
            <div style="margin-top: 40px; padding: 25px; background: rgba(184,134,11,0.1); border: 1px solid rgba(184,134,11,0.3); border-radius: 12px;">
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                    ‚ú® <strong style="color: #DAA520;">Powered by AI</strong><br>
                    Sophisticated templates designed for loan officers
                </p>
            </div>
        </div>

        <div class="image-gallery" id="imageGallery"></div>

        <!-- Chat overlay at bottom -->
        <div class="chat-overlay">
            <div class="chat-input-wrapper">
                <!-- Animated WISR Owl with Particles (Matches Landing Page) -->
                <div class="owl-container" id="owlContainer">
                    <div class="wisr-glow"></div>
                    <div class="wisr-video-circle">
                        <video id="owlVideo" autoplay loop muted playsinline>
                            <source src="wisr-owl.mp4" type="video/mp4">
                        </video>
                        <div class="video-mask-overlay"></div>
                    </div>
                    <canvas id="particleCanvas" class="particle-canvas"></canvas>
                </div>

                <textarea id="chatInput" class="chat-input" rows="6" placeholder="Select a template or describe what you want to create..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button id="chatSendBtn" class="chat-send-btn" onclick="initializeGeneration()" style="flex: 1;">
                        <span>‚ö°</span>
                        <span>Initialize</span>
                    </button>
                    <button id="autoLearnBtn" class="chat-send-btn" onclick="startAutonomousLearning()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <span>ü§ñ</span>
                        <span>Auto-Learn (10x)</span>
                    </button>
                </div>
                <div id="learningProgress" style="display: none; margin-top: 10px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="font-weight: 600; margin-bottom: 8px;" id="learningStatus">ü§ñ Autonomous Learning Mode Active...</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;" id="learningDetails">Preparing first generation...</div>
                    <div style="margin-top: 10px; background: rgba(0,0,0,0.2); height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="learningProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Keys - loaded from config.js (see config.example.js for template)
        const API_KEY = window.API_KEYS?.GEMINI || 'YOUR_GEMINI_API_KEY_HERE';
        const IDEOGRAM_API_KEY = window.API_KEYS?.IDEOGRAM || 'YOUR_IDEOGRAM_API_KEY_HERE';
        const OPENAI_API_KEY = window.API_KEYS?.OPENAI || 'YOUR_OPENAI_API_KEY_HERE';
        let isGenerating = false;
        let uploadedImageData = null;
        let lastGeneratedPrompt = null;
        let conversationHistory = [];
        let imageHistory = [];
        let selectedImageIndex = null;
        let brandLogoData = null;
        let cachedMarketData = null;
        let marketDataTimestamp = null;
        // Default user info (will be editable via settings later)
        let userInfo = {
            name: 'David Young',
            email: 'david@lendwisemortgage.com',
            nmls: '62043',
            license: '',
            phone: '310-954-7771'
        };

        // Particle System for Owl Working State Animation
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.animationFrame = null;
                this.isActive = false;

                // Set canvas size to match owl circle (98px)
                this.canvas.width = 98;
                this.canvas.height = 98;
                this.centerX = this.canvas.width / 2;
                this.centerY = this.canvas.height / 2;
                this.maxRadius = 49; // Half of 98px = circle radius
            }

            createParticle() {
                const angle = Math.random() * Math.PI * 2;
                // Create particles in a carousel ring around the owl
                const distance = 35 + Math.random() * 8; // 35-43px from center (carousel ring)
                return {
                    x: this.centerX + Math.cos(angle) * distance,
                    y: this.centerY + Math.sin(angle) * distance,
                    angle: angle,
                    speed: 0.02, // Same speed for all particles = synchronized carousel motion
                    radius: 0.8 + Math.random() * 1.7, // Tiny particles (0.8-2.5px) with variation
                    opacity: 0.4 + Math.random() * 0.5,
                    color: this.getColorVariant(),
                    distance: distance
                };
            }

            getColorVariant() {
                // Mix of gold and green particles for WISR branding
                const colors = [
                    '#FFD700', // Gold
                    '#DAA520', // Goldenrod
                    '#B8860B', // Dark goldenrod
                    '#FFC107', // Amber
                    '#00C851', // WISR green
                    'rgba(0, 200, 81, 0.8)' // WISR green with transparency
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            start() {
                this.isActive = true;
                this.particles = [];

                // Create many tiny particles distributed throughout circle
                for (let i = 0; i < 60; i++) {
                    this.particles.push(this.createParticle());
                }

                // Add working class to owl container
                const owlContainer = document.getElementById('owlContainer');
                if (owlContainer) {
                    owlContainer.classList.add('working');
                }

                this.canvas.classList.add('active');
                this.animate();
                console.log('‚ú® Particle system started - tiny particles swirling around owl');
            }

            stop() {
                this.isActive = false;
                this.canvas.classList.remove('active');

                // Remove working class from owl container
                const owlContainer = document.getElementById('owlContainer');
                if (owlContainer) {
                    owlContainer.classList.remove('working');
                }

                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                console.log('‚ú® Particle system stopped');
            }

            animate() {
                if (!this.isActive) return;

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.particles.forEach(particle => {
                    // Carousel motion - all particles rotate together around the owl
                    particle.angle += particle.speed;
                    particle.x = this.centerX + Math.cos(particle.angle) * particle.distance;
                    particle.y = this.centerY + Math.sin(particle.angle) * particle.distance;

                    // Draw tiny particle with subtle glow
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = particle.color;
                    this.ctx.globalAlpha = particle.opacity;
                    this.ctx.shadowBlur = 6;
                    this.ctx.shadowColor = particle.color;
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                });

                this.ctx.globalAlpha = 1;
                this.animationFrame = requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize particle system on page load
        let particleSystem = null;
        window.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('particleCanvas');
            if (canvas) {
                particleSystem = new ParticleSystem(canvas);
                console.log('ü¶â Owl particle system initialized');
            }
        });

        // Platform-Specific Export Specifications (2025 Standards)
        const PLATFORM_SPECS = {
            instagram: {
                name: 'Instagram',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>`,
                color: '#E4405F',
                formats: [
                    { name: 'Portrait Post', width: 1080, height: 1350, ratio: '4:5', default: true },
                    { name: 'Square Post', width: 1080, height: 1080, ratio: '1:1' },
                    { name: 'Story', width: 1080, height: 1920, ratio: '9:16' }
                ]
            },
            facebook: {
                name: 'Facebook',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`,
                color: '#1877F2',
                formats: [
                    { name: 'Feed Post', width: 1200, height: 630, ratio: '1.91:1', default: true },
                    { name: 'Square Post', width: 1200, height: 1200, ratio: '1:1' },
                    { name: 'Story', width: 1080, height: 1920, ratio: '9:16' }
                ]
            },
            linkedin: {
                name: 'LinkedIn',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>`,
                color: '#0A66C2',
                formats: [
                    { name: 'Post', width: 1200, height: 628, ratio: '1.91:1', default: true },
                    { name: 'Square Post', width: 1200, height: 1200, ratio: '1:1' }
                ]
            },
            twitter: {
                name: 'X',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`,
                color: '#000000',
                formats: [
                    { name: 'Post', width: 1200, height: 675, ratio: '16:9', default: true },
                    { name: 'Card', width: 800, height: 418, ratio: '1.91:1' }
                ]
            },
            tiktok: {
                name: 'TikTok',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>`,
                color: '#000000',
                formats: [
                    { name: 'Video Post', width: 1080, height: 1920, ratio: '9:16', default: true },
                    { name: 'Profile Photo', width: 400, height: 400, ratio: '1:1' }
                ]
            },
            youtube: {
                name: 'YouTube',
                logo: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>`,
                color: '#FF0000',
                formats: [
                    { name: 'Thumbnail', width: 1280, height: 720, ratio: '16:9', default: true },
                    { name: 'Channel Art', width: 2560, height: 1440, ratio: '16:9' }
                ]
            }
        };

        // Template Library Data with Synopsis
        const TEMPLATE_LIBRARY = {
            'market-intel': {
                name: 'Market Intelligence',
                icon: 'üìä',
                templates: [
                    {
                        id: 'daily-rate-update',
                        name: 'Daily Rate Update',
                        prompt: 'daily_rate_update',
                        synopsis: 'Create a professional daily rate update focusing on economic factors. {{PHOTO_INSTRUCTION}}Include LendWise logo. Forest green gradient background with metallic gold accents. Display current 30-year rate prominently, economic factors driving rates today, and lock strategy recommendation. Contact: David Young NMLS 62043 Phone 310-954-7771. Portrait 1080x1350.'
                    },
                    {
                        id: 'market-update',
                        name: 'Market Report',
                        prompt: 'market_update',
                        synopsis: 'Create a professional mortgage market update showing current rates. {{PHOTO_INSTRUCTION}}Include LendWise logo. Forest green gradient background with metallic gold accents. Display current mortgage rates for 30-year, 15-year, Jumbo, ARM, FHA, and VA loans. Contact: David Young NMLS 62043 Phone 310-954-7771. Portrait 1080x1350.'
                    },
                    {
                        id: 'rate-trends',
                        name: 'Rate Trend Analysis',
                        prompt: 'rate_trends',
                        synopsis: 'Create a professional mortgage rate trends chart. {{PHOTO_INSTRUCTION}}Include LendWise logo. Forest green gradient background with metallic gold accents. Use thin horizontal gold lines to separate sections. Display rate trends chart in center section. Contact info in bottom section: David Young NMLS 62043 Phone 310-954-7771. Portrait 1080x1350.'
                    },
                    {
                        id: 'economic-outlook',
                        name: 'Economic Outlook',
                        prompt: 'economic_outlook',
                        synopsis: 'Create a professional economic outlook. {{PHOTO_INSTRUCTION}}Include LendWise logo. Forest green gradient background with metallic gold accents. Use thin horizontal gold lines to separate sections. Top section: Current 30-year rate. Middle section: Key economic factors like Fed policy and inflation. Bottom section: Contact David Young NMLS 62043 Phone 310-954-7771. Portrait 1080x1350.'
                    }
                ]
            },
            'alerts': {
                name: 'Time-Sensitive Alerts',
                icon: 'üö®',
                templates: [
                    {
                        id: 'rate-drop',
                        name: 'Rate Drop Alert',
                        prompt: 'rate_drop_alert',
                        synopsis: 'Create an urgent, eye-catching alert announcing a significant rate drop. Perfect for prompting immediate action from clients.'
                    },
                    {
                        id: 'rate-increase',
                        name: 'Rate Increase Warning',
                        prompt: 'rate_increase_warning',
                        synopsis: 'Generate a professional warning about upcoming rate increases with a clear call-to-action to lock rates now.'
                    },
                    {
                        id: 'program-ending',
                        name: 'Program Ending Soon',
                        prompt: 'program_ending',
                        synopsis: 'Alert clients about expiring loan programs or limited-time offers with urgency and professionalism.'
                    }
                ]
            },
            'text-stress-tests': {
                name: 'Text Quality Tests',
                icon: 'üß™',
                templates: [
                    {
                        id: 'test-single-block-30',
                        name: '30 Words (Sweet Spot)',
                        prompt: 'test_single_block_30',
                        synopsis: 'Create a simple mortgage image with forest green gradient background and metallic gold text. Display in large gold text: "The Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Today". Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-40words',
                        name: 'TEST: 40 Words in Containers',
                        prompt: 'test_containers_40words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design THREE beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. TOP CONTAINER (12 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now". MIDDLE CONTAINER (16 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office Today". BOTTOM CONTAINER (12 words): "We Help You Find The Right Loan Program Monday Through Friday Open Hours". All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-50words',
                        name: 'TEST: 50 Words in Containers',
                        prompt: 'test_containers_50words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design FOUR beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. TOP CONTAINER (10 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options". SECOND CONTAINER (15 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Visit Our Office Today". THIRD CONTAINER (15 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals Available Now". BOTTOM CONTAINER (10 words): "Open Monday Through Friday Get Your Free Rate Quote Today". All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-60words',
                        name: 'TEST: 60 Words in Containers',
                        prompt: 'test_containers_60words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design FIVE beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. CONTAINER 1 (12 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team". CONTAINER 2 (12 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Today". CONTAINER 3 (12 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals". CONTAINER 4 (12 words): "Whether You Want To Purchase A Home Or Refinance Your Current Mortgage We Can Help". CONTAINER 5 (12 words): "Open Monday Through Friday Get Your Free Rate Quote Today Call Now For Expert Guidance". All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-70words',
                        name: 'TEST: 70 Words in Containers',
                        prompt: 'test_containers_70words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design SIX beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. CONTAINER 1 (12 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team". CONTAINER 2 (12 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office". CONTAINER 3 (12 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals Today". CONTAINER 4 (11 words): "Whether You Want To Purchase A Home Or Refinance Your Current Mortgage We Provide Solutions". CONTAINER 5 (12 words): "Expert Guidance For First Time Buyers Veterans And Those Looking To Lower Monthly Payments Available Now". CONTAINER 6 (11 words): "Open Monday Through Friday Get Your Free Rate Quote Today Call For Personal Consultation". All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-80words',
                        name: 'TEST: 80 Words in Containers',
                        prompt: 'test_containers_80words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design SEVEN beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. CONTAINER 1: "Current Mortgage Rate Market Shows Notable Change For Home Loan Options" (11 words). CONTAINER 2: "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response" (10 words). CONTAINER 3: "We Help You Find The Right Loan Program That Fits Your Budget" (12 words). CONTAINER 4: "Purchase A Home Or Refinance Your Current Mortgage With Expert Guidance" (11 words). CONTAINER 5: "First Time Buyers Veterans And Those Looking To Lower Monthly Payments" (11 words). CONTAINER 6: "Conventional FHA VA And Jumbo Loan Programs Available Through Our Team" (11 words). CONTAINER 7: "Open Monday Through Friday Get Your Free Rate Quote Today Call Now" (12 words). All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-containers-100words',
                        name: 'TEST: 100 Words in Containers',
                        prompt: 'test_containers_100words',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design NINE beautiful rectangular containers with metallic gold borders and 3D depth shadow effects. CONTAINER 1: "Current Mortgage Rate Market Shows Notable Change" (7 words). CONTAINER 2: "Contact David Young NMLS 62043 Phone 310-954-7771" (7 words). CONTAINER 3: "Expert Mortgage Solutions For Your Home Purchase Goals" (8 words). CONTAINER 4: "We Help First Time Buyers Navigate The Home Buying Process" (10 words). CONTAINER 5: "Refinance Your Current Mortgage To Lower Monthly Payments Today" (9 words). CONTAINER 6: "Conventional FHA VA Jumbo And ARM Loan Programs Available" (9 words). CONTAINER 7: "Veterans Receive Special Benefits Through Our VA Loan Programs" (9 words). CONTAINER 8: "Free Rate Quotes And Personal Consultations Available Every Day" (9 words). CONTAINER 9: "Visit Our Office Monday Through Friday Or Call Now For Quick Response Get Started Today With Your Mortgage Journey Through Our Team Of Experts Who Are Ready To Help You Find The Perfect Loan" (35 words). All text in metallic gold inside containers. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-15',
                        name: 'SINGLE CONTAINER: 15 Words',
                        prompt: 'test_single_container_15',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team Contact". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-20',
                        name: 'SINGLE CONTAINER: 20 Words',
                        prompt: 'test_single_container_20',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-25',
                        name: 'SINGLE CONTAINER: 25 Words',
                        prompt: 'test_single_container_25',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Today". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-30',
                        name: 'SINGLE CONTAINER: 30 Words',
                        prompt: 'test_single_container_30',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office During Open Hours Monday Through Friday". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-35',
                        name: 'SINGLE CONTAINER: 35 Words',
                        prompt: 'test_single_container_35',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Visit Our Office Monday Through Friday Or Call Now For Quick Response Get Started Today With Your Mortgage Journey Through Our Team Of Experts Who Are Ready To Help You Find The Perfect Loan Program That Fits Your Needs". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'test-single-container-40',
                        name: 'SINGLE CONTAINER: 40 Words',
                        prompt: 'test_single_container_40',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Design ONE large beautiful rectangular container with metallic gold border and 3D depth shadow effect in the center. Inside this container display in metallic gold text: "Visit Our Office Monday Through Friday Or Call Now For Quick Response Get Started Today With Your Mortgage Journey Through Our Team Of Experts Who Are Ready To Help You Find The Perfect Loan Program That Fits Your Needs And Budget Goals Available Right Now Today". All text must fit in ONE container. Portrait 1080x1350.'
                    },
                    {
                        id: 'design-test-bold-containers',
                        name: 'DESIGN: Bold Containers + Photo + Logo',
                        prompt: 'design_test_bold_containers',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Seamlessly integrate my photo into the design - remove background and blend naturally. Place LendWise logo in header area. Design THREE beautiful rectangular containers with metallic gold borders and 3D depth shadows. CONTAINER 1 (15 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team". CONTAINER 2 (15 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office Today". CONTAINER 3 (15 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals Available". Modern sleek luxury financial editorial style. Portrait 1080x1350.'
                    },
                    {
                        id: 'design-test-subtle-containers',
                        name: 'DESIGN: Subtle Contours + Photo + Logo',
                        prompt: 'design_test_subtle_containers',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Seamlessly integrate my photo into the design - remove background and blend naturally. Place LendWise logo in header area. Design THREE text sections with SUBTLE soft contour lines or gentle glowing outlines in metallic gold - not bold borders, just soft elegant separation. SECTION 1 (15 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team". SECTION 2 (15 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office Today". SECTION 3 (15 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals Available". Modern sleek luxury style. Portrait 1080x1350.'
                    },
                    {
                        id: 'design-test-no-containers',
                        name: 'DESIGN: No Borders + Photo + Logo',
                        prompt: 'design_test_no_containers',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Seamlessly integrate my photo into the design - remove background and blend naturally. Place LendWise logo in header area. Organize text into THREE distinct visual zones using spacing and layout only - NO borders, NO containers, NO outlines. Just clean organized sections. ZONE 1 (15 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now Through Our Team". ZONE 2 (15 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Now Or Visit Our Office Today". ZONE 3 (15 words): "We Help You Find The Right Loan Program That Fits Your Needs And Budget Goals Available". All text in metallic gold. Modern sleek luxury style. Portrait 1080x1350.'
                    },
                    {
                        id: 'design-test-complex-graphics',
                        name: 'DESIGN: Charts + Icons + Photo + Logo',
                        prompt: 'design_test_complex_graphics',
                        synopsis: 'Create a professional mortgage marketing image with forest green gradient background. Seamlessly integrate my photo into the design with creative placement. Place LendWise logo prominently. Add visual elements: rate chart showing upward trend, house icon, percentage symbols. Design THREE containers with gold borders and 3D shadows containing text. CONTAINER 1 (12 words): "Current Mortgage Rate Market Shows Notable Change For Home Loan Options Available Now". CONTAINER 2 (12 words): "Contact David Young NMLS 62043 Phone 310-954-7771 For Quick Response Call Today". CONTAINER 3 (12 words): "Expert Guidance For Purchase Or Refinance Find Your Perfect Loan Program Now". Modern Forbes/Bloomberg magazine style with data visualization. Portrait 1080x1350.'
                    }
                ]
            },
            'loan-journey': {
                name: 'Loan Journey Updates',
                icon: 'üìç',
                templates: [
                    {
                        id: 'app-submitted',
                        name: 'Application Submitted',
                        prompt: 'loan_status_submitted',
                        synopsis: 'Celebrate the first milestone: application submitted. Reassure clients about next steps and timeline.'
                    },
                    {
                        id: 'in-processing',
                        name: 'Processing Complete',
                        prompt: 'loan_status_processing',
                        synopsis: 'Update clients that processing is complete and their file is moving to underwriting. Build excitement and confidence.'
                    },
                    {
                        id: 'approved',
                        name: 'Conditional Approval',
                        prompt: 'loan_status_approved',
                        synopsis: 'Announce the big win: conditional approval received! Explain remaining conditions in an encouraging way.'
                    },
                    {
                        id: 'clear-to-close',
                        name: 'Clear to Close',
                        prompt: 'loan_status_ctc',
                        synopsis: 'The finish line is in sight! Let clients know they are clear to close and prepare for their closing appointment.'
                    },
                    {
                        id: 'funded',
                        name: 'Loan Funded!',
                        prompt: 'loan_status_funded',
                        synopsis: 'Celebrate the big moment: loan funded! Congratulate clients on their new home and thank them for their trust.'
                    },
                    {
                        id: 'thank-you',
                        name: 'Thank You Message',
                        prompt: 'loan_status_thankyou',
                        synopsis: 'Send a heartfelt thank you after closing with your contact info for future needs and referral requests.'
                    }
                ]
            },
            'celebrations': {
                name: 'Milestone Celebrations',
                icon: 'üéâ',
                templates: [
                    {
                        id: 'new-keys',
                        name: 'New Home Keys',
                        prompt: 'celebration_keys',
                        synopsis: 'Celebrate the moment clients get their keys! Perfect for social media sharing and building your brand.'
                    },
                    {
                        id: 'move-in',
                        name: 'Move-In Day',
                        prompt: 'celebration_movein',
                        synopsis: 'Welcome clients to their new home with a warm, celebratory graphic marking their move-in day.'
                    },
                    {
                        id: 'referral-request',
                        name: 'Referral Request',
                        prompt: 'celebration_referral',
                        synopsis: 'Politely ask satisfied clients for referrals with a professional, non-pushy graphic highlighting your success together.'
                    }
                ]
            },
            'branding': {
                name: 'Personal Branding',
                icon: 'üíº',
                templates: [
                    {
                        id: 'about-me',
                        name: 'About Me / Bio Card',
                        prompt: 'branding_about',
                        synopsis: 'Create a professional bio card introducing yourself, your experience, and what makes you different. Perfect for social media profiles.'
                    },
                    {
                        id: 'testimonial',
                        name: 'Testimonial Showcase',
                        prompt: 'branding_testimonial',
                        synopsis: 'Showcase a glowing client testimonial with professional design. Build trust and credibility with social proof.'
                    },
                    {
                        id: 'why-choose',
                        name: 'Why Choose Me',
                        prompt: 'branding_why',
                        synopsis: 'Highlight your unique value proposition and why clients should choose you over other loan officers.'
                    }
                ]
            },
            'educational': {
                name: 'Educational Content',
                icon: 'üéì',
                templates: [
                    {
                        id: 'credit-tips',
                        name: 'Credit Score Tips',
                        prompt: 'edu_credit',
                        synopsis: 'Share actionable tips for improving credit scores. Position yourself as a helpful advisor, not just a loan officer.'
                    },
                    {
                        id: 'down-payment',
                        name: 'Down Payment Myths',
                        prompt: 'edu_downpayment',
                        synopsis: 'Bust common myths about down payments (like the 20% myth). Educate potential clients about low down payment options.'
                    },
                    {
                        id: 'pre-approval',
                        name: 'Pre-Approval Guide',
                        prompt: 'edu_preapproval',
                        synopsis: 'Explain the difference between pre-qualification and pre-approval. Encourage clients to get pre-approved before house hunting.'
                    }
                ]
            },
            'reverse-mortgage': {
                name: 'Reverse Mortgages',
                icon: 'üè°',
                templates: [
                    {
                        id: 'reverse-intro',
                        name: 'What is a Reverse Mortgage?',
                        prompt: 'reverse_mortgage_intro',
                        synopsis: 'Introduce reverse mortgages with clear, simple explanation. Perfect for educating seniors about how they can access home equity without monthly payments.'
                    },
                    {
                        id: 'reverse-benefits',
                        name: 'Reverse Mortgage Benefits',
                        prompt: 'reverse_mortgage_benefits',
                        synopsis: 'Highlight key benefits: stay in your home, eliminate monthly mortgage payments, access tax-free cash, and maintain ownership. Build trust with seniors.'
                    },
                    {
                        id: 'reverse-qualify',
                        name: 'Who Qualifies?',
                        prompt: 'reverse_mortgage_qualify',
                        synopsis: 'Explain reverse mortgage eligibility: age 62+, primary residence, sufficient equity. Make the qualification process clear and approachable.'
                    },
                    {
                        id: 'reverse-myths',
                        name: 'Reverse Mortgage Myths',
                        prompt: 'reverse_mortgage_myths',
                        synopsis: 'Bust common reverse mortgage myths: the bank does not own your home, heirs can keep the property, you cannot be forced out. Address concerns head-on.'
                    },
                    {
                        id: 'reverse-uses',
                        name: 'How to Use Funds',
                        prompt: 'reverse_mortgage_uses',
                        synopsis: 'Show popular uses: pay off existing mortgage, medical expenses, home improvements, supplement retirement income, travel. Inspire possibilities.'
                    },
                    {
                        id: 'reverse-cta',
                        name: 'Free Consultation',
                        prompt: 'reverse_mortgage_consultation',
                        synopsis: 'Invite seniors to a no-obligation consultation. Emphasize free analysis, personalized advice, and helping them make informed decisions.'
                    }
                ]
            }
        };

        // Track currently selected template
        let selectedTemplate = null;

        // Initialize template library on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadTemplateLibrary();
            loadBrandLogo();

            // Pre-fetch market data in background for zero-delay generation
            console.log('üöÄ Pre-fetching live market data in background...');
            fetchMarketData().then(() => {
                console.log('‚úÖ Market data pre-fetch complete - ready for instant generation!');
            }).catch(err => {
                console.warn('‚ö†Ô∏è Market data pre-fetch failed:', err.message);
            });
        });

        // LendWise Design Theme Specification
        const LENDWISE_THEME = {
            name: 'Executive Gold',
            colors: {
                background: {
                    primary: '#1B4D3E',
                    secondary: '#2D5F4F',
                    gradient: 'Rich gradient from deep forest green #1B4D3E to #2D5F4F with depth and dimension'
                },
                gold: {
                    metallic: '#B8860B',
                    bright: '#DAA520',
                    bronze: '#8B6914'
                },
                green: {
                    forest: '#1B4D3E',
                    deep: '#2D5F4F'
                },
                text: {
                    primary: '#F5F5DC',
                    light: '#FAFAF0'
                }
            },
            typography: {
                headline: 'Montserrat Bold, 32pt, gold #DAA520',
                rateNumbers: 'Montserrat ExtraBold, 60pt, metallic gold #B8860B',
                sectionHeaders: 'Montserrat SemiBold, 28pt, gold #B8860B',
                body: 'Open Sans Regular, 16pt, cream #F5F5DC',
                labels: 'Open Sans SemiBold, 18pt, cream #F5F5DC',
                contact: 'Open Sans Medium, 14pt, gold #B8860B'
            },
            layout: {
                aspectRatio: '1080x1350 (Instagram portrait format)',
                logoPosition: 'Top-left, 120px width, with subtle gold glow',
                spacing: 'Professional padding, 20px margins between sections'
            },
            logo: {
                brandName: 'LENDWISE MORTGAGE',
                sizingRule: 'MORTGAGE text must be exactly 50% smaller than LENDWISE text',
                alignmentRule: 'MORTGAGE text must be CENTERED below LENDWISE (default, unless user requests different alignment)',
                textHierarchy: {
                    lendwise: '100% size (reference)',
                    mortgage: '50% size (half of LENDWISE), centered below'
                },
                goldColor: {
                    style: 'BRIGHT, VIBRANT, LUMINOUS metallic gold',
                    reference: 'Polished 24k gold jewelry, luxury watch, championship trophy',
                    colors: ['#FFD700 (bright gold)', '#FFF8DC (cream highlights)', '#FFC107 (warm gold)', '#FFEB3B (vibrant gold)'],
                    avoid: 'Dark bronze, dull gold, muted tones - must be BRIGHT and eye-catching'
                },
                composition: 'Golden owl on left, LENDWISE large text, MORTGAGE smaller text centered below',
                background: 'Transparent PNG with no black background'
            }
        };

        // Load the brand logo on startup
        async function loadBrandLogo() {
            try {
                console.log('üîÑ Loading brand logo from lendwise-logo.png...');
                const response = await fetch('lendwise-logo.png?v=' + Date.now());
                console.log('üì° Logo fetch response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Failed to fetch logo: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                console.log('üì¶ Logo blob size:', blob.size, 'bytes, type:', blob.type);

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result.split(',')[1];
                    brandLogoData = {
                        data: base64String,
                        mimeType: 'image/png'
                    };
                    console.log('‚úÖ Brand logo loaded successfully! Base64 length:', base64String.length);
                    console.log('üé® Logo will be included in all generations');
                };
                reader.onerror = function(e) {
                    console.error('‚ùå FileReader error:', e);
                };
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error('‚ùå Could not load brand logo:', error);
                console.warn('‚ö†Ô∏è Will rely on text description instead');
            }
        }

        // PROMPT ARCHITECT - Review and enhance all prompts before sending to Gemini
        function reviewPrompt(originalPrompt, context = {}) {
            console.log('üèóÔ∏è Prompt Architect: Reviewing prompt for brand consistency...');

            const {
                hasLogo = brandLogoData !== null,
                hasPhoto = uploadedImageData !== null,
                isRefinement = imageHistory.length > 0,
                template = selectedTemplate,
                userRequest = null,
                dimensions = { width: 1080, height: 1350, ratio: '4:5', name: 'Instagram portrait' }
            } = context;

            let enhancedPrompt = originalPrompt;
            let enhancements = [];

            // 1. LOGO SPECIFICATIONS CHECK
            if (hasLogo && !originalPrompt.includes('LENDWISE LOGO')) {
                const logoSpec = `\n\nüìê LOGO SPECIFICATIONS (CRITICAL):
- The first image is the LendWise Mortgages brand logo (golden owl with "LENDWISE MORTGAGE" text)
- USE THE EXACT LOGO from the image - place it prominently
- LENDWISE text: 100% size (large)
- MORTGAGE text: 50% size (exactly half of LENDWISE), CENTERED below LENDWISE
- Both use BRIGHT, VIBRANT metallic gold (#FFD700, #FFF8DC, #FFC107)
- Transparent background - no black`;
                enhancedPrompt += logoSpec;
                enhancements.push('Added logo specifications');
            }

            // 2. BRAND COLORS CHECK
            if (!originalPrompt.includes('DEFAULT BRAND COLORS') && !originalPrompt.includes('BASE COLOR PALETTE')) {
                const colorSpec = `\n\nüé® DEFAULT BRAND COLORS (Use unless user requests different):
- Background: Rich GRADIENT forest green from ${LENDWISE_THEME.colors.green.forest} to ${LENDWISE_THEME.colors.green.deep}
  (NOT flat - smooth, dimensional gradient with depth)
- Accent: METALLIC, HYPER-REALISTIC gold ${LENDWISE_THEME.colors.gold.metallic}
  (Add reflections, shine, 3D depth - real polished gold with highlights ${LENDWISE_THEME.colors.gold.bright} and shadows ${LENDWISE_THEME.colors.gold.bronze})

NOTE: If user specifically requests different colors, honor their request.`;
                enhancedPrompt += colorSpec;
                enhancements.push('Added brand color standards');
            }

            // 3. CRITICAL REQUIREMENTS CHECK
            if (!originalPrompt.includes('CRITICAL REQUIREMENTS')) {
                const criticalSpec = `\n\nCRITICAL REQUIREMENTS:
- Make ALL text crystal clear and perfectly readable
- Professional, high-quality design
- ${dimensions.name} format (${dimensions.width}x${dimensions.height}, ${dimensions.ratio} aspect ratio)
${hasPhoto ? `
üö® PHOTO REQUIREMENTS - EXTREMELY IMPORTANT:
- The uploaded image contains a REAL PERSON\'s photo
- You MUST use this EXACT person in the generated image
- Do NOT generate a different person, AI person, or generic face
- Do NOT change the person\'s facial features, skin tone, hair, or identity
- Keep the person\'s face, features, and likeness 100% IDENTICAL
- The person should be clearly visible and recognizable in the final image
- Place the person prominently in the design (not hidden or tiny)
- This is the actual loan officer whose photo was uploaded - use their real face\n` : ''}${hasLogo ? '- Place logo prominently (top-left, 120px width)\n' : ''}`;
                enhancedPrompt += criticalSpec;
                enhancements.push('Added critical requirements checklist');
            }

            // 4. TRANSPARENT BACKGROUND CHECK (if not mentioned and applicable)
            if (!originalPrompt.includes('transparent') && !originalPrompt.includes('Transparent')) {
                // Only add if this seems to be a logo or standalone graphic request
                if (template && (template.id.includes('branding') || template.id.includes('logo'))) {
                    enhancedPrompt += '\n\n‚ö†Ô∏è IMPORTANT: Use transparent background (PNG with alpha channel)';
                    enhancements.push('Added transparent background requirement');
                }
            }

            // 5. CONTACT INFORMATION CHECK
            if (originalPrompt.includes(userInfo.name) && !originalPrompt.includes(userInfo.nmls)) {
                enhancedPrompt += `\n\nüìû CONTACT INFORMATION:
- Name: ${userInfo.name}
- NMLS: #${userInfo.nmls}
- Phone: ${userInfo.phone}
- Make all contact info clearly visible and legible`;
                enhancements.push('Added complete contact information');
            }

            // 6. TYPOGRAPHY SPECIFICATIONS CHECK
            if (!originalPrompt.includes('TYPOGRAPHY') && !originalPrompt.includes('typography')) {
                const typoSpec = `\n\nüî§ TYPOGRAPHY SPECIFICATIONS:
- Headlines: ${LENDWISE_THEME.typography.headline}
- Rate Numbers: ${LENDWISE_THEME.typography.rateNumbers} (large, prominent)
- Section Headers: ${LENDWISE_THEME.typography.sectionHeaders}
- Body Text: ${LENDWISE_THEME.typography.body}
- Labels: ${LENDWISE_THEME.typography.labels}
- Contact Info: ${LENDWISE_THEME.typography.contact}
- Create clear hierarchy: Large headlines ‚Üí medium headers ‚Üí readable body
- All text must be crystal clear and perfectly legible`;
                enhancedPrompt += typoSpec;
                enhancements.push('Added typography specifications');
            }

            // 7. LAYOUT & SPACING STANDARDS CHECK
            if (!originalPrompt.includes('LAYOUT') && !originalPrompt.includes('spacing')) {
                const layoutSpec = `\n\nüìê LAYOUT & SPACING STANDARDS:
- Format: ${dimensions.width}x${dimensions.height} (${dimensions.ratio} ${dimensions.name})
- Logo Position: ${LENDWISE_THEME.layout.logoPosition}
- Spacing: ${LENDWISE_THEME.layout.spacing}
- Section Structure: TOP 30% (Hero/Header) ‚Üí MIDDLE 40% (Main Content) ‚Üí BOTTOM 30% (Info/Contact)
- Use LOTS of whitespace - don't cram elements together
- Generous padding around all sections (20-30px minimum)
- Breathing room between text elements
- NO cramped layouts - elegance requires space`;
                enhancedPrompt += layoutSpec;
                enhancements.push('Added layout & spacing standards');
            }

            // 8. VISUAL ENHANCEMENT STANDARDS CHECK
            if (!originalPrompt.includes('VISUAL ENHANCEMENTS') && !originalPrompt.includes('visual effects')) {
                const visualSpec = `\n\n‚ú® VISUAL ENHANCEMENTS FOR SOPHISTICATION:
- Subtle geometric patterns in background (5-10% opacity)
- Soft gold glow effects behind major elements
- Professional drop shadows (very subtle, not harsh)
- Metallic gold with gradients: Use highlights (${LENDWISE_THEME.colors.gold.bright}), base (${LENDWISE_THEME.colors.gold.metallic}), shadows (${LENDWISE_THEME.colors.gold.bronze})
- Create 3D depth: Reflections, shine, dimensional effects
- Thin accent lines in gold to guide the eye
- Background gradient must have depth (NOT flat)`;
                enhancedPrompt += visualSpec;
                enhancements.push('Added visual enhancement standards');
            }

            // 9. DESIGN PRINCIPLES CHECK
            if (!originalPrompt.includes('DESIGN PRINCIPLES') && !originalPrompt.includes('aesthetic')) {
                const principlesSpec = `\n\nüéØ CRITICAL DESIGN PRINCIPLES:
‚úì SIMPLICITY: Clean, uncluttered - highlight what matters most
‚úì CLARITY: All text perfectly legible, easy to read at a glance
‚úì ELEGANCE: Magazine quality, NOT corporate or spreadsheet quality
‚úì HIERARCHY: Clear visual flow - most important = largest/boldest
‚úì BREATHING ROOM: Generous spacing, never cramped
‚úì TRUST: Professional, authoritative, sophisticated aesthetic
‚úì STORYTELLING: Create visual narrative, engage emotionally
‚úì LUXURY AESTHETIC: Think Forbes, Bloomberg, Apple - premium brands`;
                enhancedPrompt += principlesSpec;
                enhancements.push('Added design principles');
            }

            // 10. "AVOID" LIST CHECK
            if (!originalPrompt.includes('AVOID') && !originalPrompt.includes('NOT')) {
                const avoidSpec = `\n\nüö´ CRITICAL MISTAKES TO AVOID:
‚úó NO rate tables or grids (use elegant typography instead)
‚úó NO cluttered layouts with too much information
‚úó NO heavy borders or boxes around everything
‚úó NO boring, corporate spreadsheet look
‚úó NO small, hard-to-read text (readability is paramount)
‚úó NO overwhelming amount of data (less is more)
‚úó NO flat colors (use gradients and depth)
‚úó NO harsh shadows or effects (keep it sophisticated)`;
                enhancedPrompt += avoidSpec;
                enhancements.push('Added "avoid" list');
            }

            // 11. TEMPLATE-SPECIFIC ENHANCEMENTS CHECK
            if (template && !originalPrompt.includes('AESTHETIC:')) {
                let templateSpec = '';

                // Market Intelligence templates
                if (template.id.includes('market') || template.id.includes('rate') || template.id.includes('economic')) {
                    templateSpec = `\n\nüíº TEMPLATE-SPECIFIC GUIDANCE (Market Intelligence):
- Think: High-end financial magazine (Forbes, Bloomberg, Fortune)
- Sophisticated data visualization - NOT a rate sheet
- Feature the most important rate prominently (80pt+ gold numbers)
- Secondary rates smaller but still elegant (30-40pt)
- Market insight in simple, clear language (2-3 sentences)
- Use whitespace and typography to separate (NO boxes)
- Professional confidence and authority`;
                }

                // Alert templates
                else if (template.id.includes('alert') || template.id.includes('drop') || template.id.includes('increase') || template.id.includes('program')) {
                    templateSpec = `\n\nüö® TEMPLATE-SPECIFIC GUIDANCE (Time-Sensitive Alert):
- URGENCY: Eye-catching but professional (not gimmicky)
- Bold headline with clear call-to-action
- Use color psychology: Warm tones for opportunities, cool for cautions
- Large, readable text - must grab attention instantly
- Contact info prominent for immediate response
- Elegant urgency - sophisticated, not desperate`;
                }

                // Loan Journey templates
                else if (template.id.includes('loan') || template.id.includes('app') || template.id.includes('processing') || template.id.includes('approved') || template.id.includes('funded') || template.id.includes('thank')) {
                    templateSpec = `\n\nüìç TEMPLATE-SPECIFIC GUIDANCE (Loan Journey):
- EMOTIONAL CONNECTION: Celebrate milestones with warmth
- Encouraging, positive tone (build excitement)
- Progress indicators or journey metaphors
- Personal touch - make client feel valued
- Next steps clearly communicated
- Professional but personable aesthetic`;
                }

                // Celebration templates
                else if (template.id.includes('celebration') || template.id.includes('keys') || template.id.includes('movein') || template.id.includes('referral')) {
                    templateSpec = `\n\nüéâ TEMPLATE-SPECIFIC GUIDANCE (Celebration):
- JOY & WARMTH: Happy, celebratory but still professional
- Bright, positive colors (while maintaining brand palette)
- Emotional storytelling - this is a life milestone
- Shareable design (perfect for social media)
- Your branding subtle but present
- Elegant celebration - sophisticated happiness`;
                }

                // Branding templates
                else if (template.id.includes('branding') || template.id.includes('about') || template.id.includes('testimonial') || template.id.includes('why')) {
                    templateSpec = `\n\nüíº TEMPLATE-SPECIFIC GUIDANCE (Personal Branding):
- PROFESSIONAL AUTHORITY: Expert, trustworthy, accomplished
- Clean headshot or professional photo integration
- Credentials prominent but not overwhelming
- Value proposition clear and compelling
- LinkedIn-quality professional aesthetic
- Build trust and credibility through design
- Elegant sophistication that inspires confidence`;
                }

                // Educational templates
                else if (template.id.includes('edu') || template.id.includes('credit') || template.id.includes('down') || template.id.includes('approval')) {
                    templateSpec = `\n\nüéì TEMPLATE-SPECIFIC GUIDANCE (Educational):
- HELPFUL ADVISOR: Approachable expert, not salesperson
- Clear, simple explanations (avoid jargon)
- Visual aids or icons for key points
- Friendly but professional tone
- Position as trusted resource
- Easy to understand at a glance
- Educational elegance - make learning feel premium`;
                }

                if (templateSpec) {
                    enhancedPrompt += templateSpec;
                    enhancements.push('Added template-specific enhancements');
                }
            }

            // 12. TEXT ACCURACY & READABILITY CHECK (CRITICAL - added after seeing garbled text issues)
            if (!originalPrompt.includes('TEXT ACCURACY') && !originalPrompt.includes('spell') && !originalPrompt.includes('accurate text')) {
                const textAccuracySpec = `\n\nüìù TEXT ACCURACY REQUIREMENTS (CRITICAL):
‚ö†Ô∏è ALL TEXT MUST BE ACCURATE, READABLE, AND ERROR-FREE:
- NO gibberish, garbled, or corrupted characters (like "3xtb%" instead of "3.5%")
- NO random symbols, special characters, or encoding errors
- Spell all words correctly - double-check every word
- Numbers must be properly formatted (e.g., "6.5%" NOT "6xtb%" or "6x5%")
- Percentages: Use proper % symbol, not corrupted versions
- All text must be legible at any size
- Use standard characters only - NO unusual Unicode or symbols
- Verify EVERY piece of text before generating
- If showing rates: Format as "X.XX%" (e.g., "6.38%", "0.5%")
- If showing dollar amounts: Format as "$X,XXX" (e.g., "$2,500")
- Contact information must be accurate and readable
- Double-check all phone numbers, NMLS numbers, website URLs

üîç TEXT QUALITY CHECKLIST:
‚úì Every word spelled correctly
‚úì Every number formatted properly
‚úì Every percentage uses correct % symbol
‚úì No corrupted or garbled characters
‚úì All text crystal clear and professional`;
                enhancedPrompt += textAccuracySpec;
                enhancements.push('Added TEXT ACCURACY requirements (CRITICAL)');
            }

            // 13. CRITICAL SPELLING LIST (Added after seeing "Underddiving" and "lendwiemotrgarge.com" errors)
            if (!originalPrompt.includes('CRITICAL SPELLING') && !originalPrompt.includes('spell these exactly')) {
                const criticalSpellingSpec = `\n\nüìã CRITICAL SPELLING LIST - MUST BE EXACT (3-Layer Protection):

üö® LAYER 1: KNOWN PROBLEM WORDS - SPELL EXACTLY:
‚úì "Underwriting" = U-N-D-E-R-W-R-I-T-I-N-G (NOT "Underddiving", "Underriting", "Under writing")
‚úì "lendwisemortgage.com" = l-e-n-d-w-i-s-e-m-o-r-t-g-a-g-e.com (NOT "lendwiemotrgarge", "lendwise-mortgage")
‚úì "Application" = A-P-P-L-I-C-A-T-I-O-N (NOT "Aplication")
‚úì "Appraisal" = A-P-P-R-A-I-S-A-L (NOT "Aprasal", "Appriasal")
‚úì "Processing" = P-R-O-C-E-S-S-I-N-G (NOT "Proccessing")
‚úì "NMLS" = N-M-L-S (capital letters, NOT "NMSL", "NMLs", "nmls")
‚úì "Closing" = C-L-O-S-I-N-G (NOT "Closeing")
‚úì "Mortgage" = M-O-R-T-G-A-G-E (NOT "Morgage", "Mortage")

‚öôÔ∏è LAYER 2: TEXT RENDERING GUIDANCE (Help AI render complex words):
- For "Underwriting": Think "Under" + "Writing" = Underwriting
- For website URLs: Spell letter-by-letter, verify each character
- For "Appraisal": Think "App" + "Praise" + "Al" = Appraisal
- For complex words: Break into syllables, then merge carefully
- Double-check every character before finalizing text

üîç LAYER 3: FINAL VERIFICATION (Before rendering the image):
Before creating the final image, verify these specific words:
1. Check "Underwriting" is NOT "Underddiving" or any variation
2. Check "lendwisemortgage.com" has NO scrambled letters
3. Check "Application" has two P's
4. Check "Appraisal" has two P's
5. Check "Processing" has two S's
6. Check "NMLS" is all capitals
7. Verify website URL character-by-character
8. Scan for ANY gibberish or corrupted text

‚ö†Ô∏è IF IN DOUBT: Use simpler text or skip the problematic word rather than render it incorrectly`;
                enhancedPrompt += criticalSpellingSpec;
                enhancements.push('Added CRITICAL SPELLING LIST (3-Layer Protection)');
            }

            // Log enhancements
            if (enhancements.length > 0) {
                console.log('‚úÖ Prompt Architect: Enhanced prompt with:', enhancements.join(', '));
            } else {
                console.log('‚úÖ Prompt Architect: Prompt passed review - all brand standards present');
            }

            return enhancedPrompt;
        }

        // Load template library into sidebar
        function loadTemplateLibrary() {
            const library = document.getElementById('templateLibrary');
            library.innerHTML = '';

            Object.keys(TEMPLATE_LIBRARY).forEach(categoryId => {
                const category = TEMPLATE_LIBRARY[categoryId];

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'template-category';
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${categoryId}')">
                        <span class="category-icon">${category.icon}</span>
                        <span>${category.name}</span>
                    </div>
                    <div class="category-items" id="cat-${categoryId}">
                        ${category.templates.map(template => `
                            <div class="template-item" onclick="selectTemplate('${categoryId}', '${template.id}')">
                                ${template.name}
                            </div>
                        `).join('')}
                    </div>
                `;

                library.appendChild(categoryDiv);
            });

            // Auto-expand first category
            document.querySelector('.template-category').classList.add('active');
        }

        function toggleCategory(categoryId) {
            const categoryDiv = document.querySelector(`#cat-${categoryId}`).closest('.template-category');
            categoryDiv.classList.toggle('active');
        }

        function selectTemplate(categoryId, templateId) {
            // Remove active class from all items
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to selected item
            event.target.classList.add('active');

            // Find the template
            const template = TEMPLATE_LIBRARY[categoryId].templates.find(t => t.id === templateId);
            if (template) {
                // Store selected template
                selectedTemplate = template;

                // Show synopsis in chat input
                const chatInput = document.getElementById('chatInput');
                chatInput.value = template.synopsis;
                chatInput.focus();

                console.log('üìã Template selected:', template.name);
            }
        }

        async function generateFromTemplate(template, userModifications = '') {
            console.log('üé® Template selected:', template.name);
            console.log('üîç DEBUG - template.id:', template.id);
            console.log('üîç DEBUG - userModifications:', userModifications);

            // Check if userModifications is just the template synopsis (user didn't actually modify anything)
            const hasRealModifications = userModifications &&
                                        userModifications.trim() !== '' &&
                                        userModifications !== template.synopsis &&
                                        !userModifications.includes('{{PHOTO_INSTRUCTION}}'); // Synopsis has placeholder

            console.log('üîç DEBUG - Has real modifications:', hasRealModifications);
            console.log('üîç DEBUG - Checking if market-update:', template.id === 'market-update');

            let message = '';

            // üé® DAILY RATE UPDATE: Use enhanced prompt with live data + economic factors
            if (template.id === 'daily-rate-update' && !hasRealModifications) {
                console.log('‚úÖ DAILY RATE UPDATE! Fetching live market data with economic factors...');
                const marketData = await fetchMarketData();
                message = buildDailyRateUpdatePrompt(marketData);
            }
            // üé® MARKET REPORT: Use enhanced prompt with live data (only if user hasn't modified the prompt)
            else if (template.id === 'market-update' && !hasRealModifications) {
                console.log('‚úÖ MARKET REPORT! Fetching live market data for enhanced prompt...');
                const marketData = await fetchMarketData();
                message = buildMarketUpdatePrompt(marketData);
            }
            // üé® RATE TRENDS: Use enhanced prompt with live data
            else if (template.id === 'rate-trends' && !hasRealModifications) {
                console.log('‚úÖ RATE TRENDS! Fetching live market data for trend analysis...');
                const marketData = await fetchMarketData();
                message = buildRateTrendsPrompt(marketData);
            }
            // üé® ECONOMIC OUTLOOK: Use enhanced prompt with live data
            else if (template.id === 'economic-outlook' && !hasRealModifications) {
                console.log('‚úÖ ECONOMIC OUTLOOK! Fetching live market data for outlook analysis...');
                const marketData = await fetchMarketData();
                message = buildEconomicOutlookPrompt(marketData);
            } else {
                console.log('‚ùå NO MATCH - Using template synopsis/modifications instead');
                console.log('   Reason:', hasRealModifications ? 'User modified prompt' : 'Not market-update template');
                // All other templates: Use synopsis or user modifications
                message = userModifications || template.synopsis;

                // Replace {{PHOTO_INSTRUCTION}} based on whether user uploaded a photo
                if (message.includes('{{PHOTO_INSTRUCTION}}')) {
                    if (uploadedImageData) {
                        message = message.replace('{{PHOTO_INSTRUCTION}}', 'Seamlessly integrate my photo into the design - remove the background and blend me naturally into the composition. ');
                    } else {
                        message = message.replace('{{PHOTO_INSTRUCTION}}', '');
                    }
                }
            }

            console.log('üìù User prompt:', message);

            // Show loading state
            const emptyMessage = document.getElementById('emptyMessage');
            const previewArea = document.getElementById('previewArea');

            emptyMessage.innerHTML = '<div style="color: #DAA520; font-size: 1.2rem;">üé® Generating...</div>';
            previewArea.classList.remove('empty');

            // Generate the image - send user's prompt directly to Gemini
            await generateImage(message, template.name);
        }

        // Fetch live market data from Mortgage News Daily via backend API
        async function fetchMarketData() {
            // Check cache (1 hour expiry)
            const now = Date.now();
            if (cachedMarketData && marketDataTimestamp && (now - marketDataTimestamp) < 3600000) {
                console.log('üìä Using cached market data');
                return cachedMarketData;
            }

            try {
                console.log('üîÑ Fetching LIVE market data from Mortgage News Daily...');

                // Fetch from backend API which scrapes live data (optional - will use fallback if unavailable)
                const response = await fetch('http://localhost:3001/api/market-data').catch(() => null);

                if (!response || !response.ok) {
                    throw new Error('Backend not available');
                }

                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;

                    cachedMarketData = data;
                    marketDataTimestamp = now;

                    console.log('‚úÖ LIVE market data loaded successfully');
                    console.log('üìä Current 30-Year Fixed:', data.rates['30yr'], data.changes['30yr']);
                    console.log('üìÖ Data from:', data.date, data.timestamp);
                    console.log('üíæ Cached:', result.cached ? 'Yes (backend cache)' : 'No (fresh scrape)');

                    return data;
                } else {
                    throw new Error(result.error || 'Failed to fetch market data');
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Backend not available - using fallback market data');
                console.warn('‚ö†Ô∏è Using fallback hardcoded data (backend optional)');

                // Return fallback data if backend is unavailable
                const fallbackData = {
                    rates: {
                        '30yr': '6.38%',
                        '15yr': '5.88%',
                        'jumbo': '6.29%',
                        'arm': '5.85%',
                        'fha': '6.05%',
                        'va': '6.07%'
                    },
                    changes: {
                        '30yr': '+0.02%',
                        '15yr': '-0.01%',
                        'jumbo': '+0.02%',
                        'arm': '+0.02%'
                    },
                    ranges: {
                        '30yr': '6.13% - 7.26%',
                        '15yr': '5.60% - 6.59%',
                        'jumbo': '6.14% - 7.45%',
                        'arm': '5.59% - 7.25%'
                    },
                    treasuries: {
                        '10yr': '4.132',
                        '30yr': '4.721'
                    },
                    trend: 'Rates showing minimal movement',
                    commentary: 'Mortgage rates remain near recent lows providing favorable conditions for borrowers',
                    date: new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                    economicFactors: [
                        { factor: 'Fed rate cuts expected', impact: 'positive' },
                        { factor: 'Inflation rising per Fed data', impact: 'negative' },
                        { factor: 'Markets near lows', impact: 'positive' }
                    ],
                    lockRecommendation: 'Near recent lows - favorable time to lock today'
                };

                return fallbackData;
            }
        }

        // Parse market trend into bullet points (8-10 words each) - MAXIMUM INFO
        function parseMarketTrendBullets(trendText) {
            if (!trendText) return [];

            // Split into sentences
            const sentences = trendText.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 0);
            const bullets = [];

            for (let sentence of sentences) {
                const words = sentence.split(' ').filter(w => w.length > 0);

                // If sentence is short enough (‚â§10 words), use as-is
                if (words.length <= 10) {
                    bullets.push(sentence);
                } else {
                    // Break into 10-word chunks
                    for (let i = 0; i < words.length; i += 10) {
                        const chunk = words.slice(i, i + 10).join(' ');
                        bullets.push(chunk);
                    }
                }
            }

            return bullets;
        }

        // Extract key quote from commentary - COMPLETE THOUGHT (15-20 words for full sentence)
        function parseMarketCommentary(commentaryText) {
            if (!commentaryText) return '';

            // Remove quotes
            let text = commentaryText.replace(/['"]/g, '').trim();

            // Get first sentence
            let firstSentence = text.split(/[.!?]/)[0].trim();

            // Allow up to 20 words to capture complete thought
            let words = firstSentence.split(' ').filter(w => w.length > 0);
            if (words.length > 20) {
                // If still too long, find natural break point
                // Look for comma or conjunction around word 15-18
                let breakPoint = 15;
                for (let i = 15; i < Math.min(18, words.length); i++) {
                    if (words[i].endsWith(',') || words[i] === 'and' || words[i] === 'but') {
                        breakPoint = i + 1;
                        break;
                    }
                }
                return words.slice(0, breakPoint).join(' ') + '...';
            }

            return firstSentence;
        }

        // Format rate data into safe short phrases
        function formatRateData(marketData) {
            const rates = marketData.rates || {};
            const changes = marketData.changes || {};

            // Format as short phrases: "30-Year: 6.38% (+0.02%)"
            // Each rate is exactly 5 words or less
            return {
                primary: `30-Year: ${rates['30yr'] || 'N/A'} (${changes['30yr'] || '‚Äî'})`,
                secondary: [
                    `15-Year: ${rates['15yr'] || 'N/A'}`
                ]
            };
        }

        // Check if message is requesting a market update
        function isMarketUpdateRequest(message) {
            const keywords = ['market update', 'rate update', 'current rates', "today's rates", 'latest rates', 'mortgage rates today'];
            const lowerMessage = message.toLowerCase();
            return keywords.some(keyword => lowerMessage.includes(keyword));
        }

        function addMessage(role, content, imageUrl = null, imageData = null, showPrompt = false, userPrompt = '', isMarketUpdate = false) {
            // This function is not used in template-based mode, but keep it for compatibility
            console.log('Message:', role, content);
        }

        // Generate platform export buttons HTML
        function generatePlatformButtons(imageIndex) {
            let buttonsHTML = '';

            Object.entries(PLATFORM_SPECS).forEach(([platformKey, platform]) => {
                const formatOptions = platform.formats.map(format => {
                    const isDefault = format.default ? 'default' : '';
                    return `
                        <div class="platform-format-option ${isDefault}"
                             onclick="regenerateForPlatform(${imageIndex}, '${platformKey}', ${format.width}, ${format.height}, '${format.name}')">
                            <span>${format.name}</span>
                            <span class="dimensions">${format.width}√ó${format.height}</span>
                        </div>
                    `;
                }).join('');

                buttonsHTML += `
                    <div class="platform-btn" id="platform-${platformKey}-${imageIndex}">
                        <span class="icon">${platform.logo}</span>
                        <span>${platform.name}</span>
                        <div class="platform-dropdown">
                            ${formatOptions}
                        </div>
                    </div>
                `;
            });

            return buttonsHTML;
        }

        function updateImageGallery() {
            const gallery = document.getElementById('imageGallery');
            const emptyMessage = document.getElementById('emptyMessage');
            const previewArea = document.getElementById('previewArea');

            if (imageHistory.length === 0) {
                emptyMessage.style.display = 'block';
                previewArea.classList.add('empty');
                gallery.style.display = 'none';
                return;
            }

            emptyMessage.style.display = 'none';
            previewArea.classList.remove('empty');
            gallery.style.display = 'flex';

            gallery.innerHTML = '';
            imageHistory.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                if (index === selectedImageIndex) {
                    item.classList.add('selected');
                }

                item.innerHTML = `
                    <img src="${img.url}" alt="Generated image" onclick="openImageInNewTab(${index})" title="Click to open full size (right-click to save)">
                    <div class="image-item-info">
                        <div class="image-item-prompt">${img.prompt}</div>
                        <div class="image-item-actions">
                            <button onclick="openImageInNewTab(${index})" title="Open in new tab to save">üíæ Save</button>
                            <button onclick="branchFromImage(${index})">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                    <div class="platform-export-section">
                        <div class="platform-export-label">Export for Social Media</div>
                        <div class="platform-buttons">
                            ${generatePlatformButtons(index)}
                        </div>
                    </div>
                `;

                item.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        selectImage(index);
                    }
                };

                gallery.appendChild(item);
            });

            // Auto-scroll to latest
            gallery.lastChild?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function selectImage(index) {
            selectedImageIndex = index;
            updateImageGallery();
        }

        function openImageInNewTab(index) {
            const img = imageHistory[index];
            if (img && img.data) {
                // Open image in new tab where user can right-click and save
                const newWindow = window.open();
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>wisr-ai-${img.timestamp || Date.now()}.png</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                background: #000;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                min-height: 100vh;
                            }
                            img {
                                max-width: 100%;
                                max-height: 100vh;
                                object-fit: contain;
                            }
                            .instructions {
                                position: fixed;
                                top: 20px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: rgba(255,255,255,0.9);
                                padding: 10px 20px;
                                border-radius: 8px;
                                color: #000;
                                font-family: sans-serif;
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="instructions">Right-click the image and select "Save image as..."</div>
                        <img src="data:image/png;base64,${img.data}" alt="Generated image" />
                    </body>
                    </html>
                `);
            }
        }

        function branchFromImage(index) {
            selectedImageIndex = index;
            const img = imageHistory[index];
            updateImageGallery();

            // Focus input and suggest edit
            const input = document.getElementById('chatInput');
            input.placeholder = `Editing: "${img.prompt}" - What would you like to change?`;
            input.focus();

            // Update context for next generation
            lastGeneratedPrompt = img.prompt;
        }

        // Regenerate image for specific platform and dimensions
        async function regenerateForPlatform(imageIndex, platformKey, width, height, formatName) {
            if (isGenerating) {
                alert('Already generating an image. Please wait...');
                return;
            }

            const originalImage = imageHistory[imageIndex];
            if (!originalImage) return;

            console.log(`üîÑ Regenerating for ${platformKey} - ${formatName} (${width}x${height})`);

            // Show loading state on the platform button
            const btnElement = document.getElementById(`platform-${platformKey}-${imageIndex}`);
            if (btnElement) {
                btnElement.classList.add('platform-generating');
            }

            isGenerating = true;

            try {
                const platform = PLATFORM_SPECS[platformKey];
                const dimensions = {
                    width,
                    height,
                    ratio: `${width}:${height}`,
                    name: `${platform.name} ${formatName}`
                };

                // Build the parts array
                const parts = [];

                // Always add brand logo first if available
                if (brandLogoData) {
                    parts.push({
                        inline_data: {
                            mime_type: brandLogoData.mimeType,
                            data: brandLogoData.data
                        }
                    });
                }

                // Add uploaded image if available
                if (uploadedImageData) {
                    console.log('üì∏ Including uploaded person photo in generation request');
                    parts.push({
                        inline_data: {
                            mime_type: uploadedImageData.mimeType,
                            data: uploadedImageData.data
                        }
                    });
                } else {
                    console.log('‚ÑπÔ∏è No uploaded photo - will generate without person');
                }

                // Determine if this is a vertical video format (TikTok, Stories)
                const isVerticalVideo = height > width && (height / width) > 1.5;
                const isYouTube = platformKey === 'youtube';

                // Create regeneration prompt
                let promptText = `Regenerate the "${originalImage.prompt}" design for ${dimensions.name}.

IMPORTANT: Keep the EXACT SAME design, layout, colors, and content as the original.
ONLY change the aspect ratio and dimensions to fit ${width}x${height} pixels (${dimensions.ratio} aspect ratio).

Adapt the layout intelligently for the new dimensions:
- If wider (landscape): Spread content horizontally, use side-by-side layouts
- If taller (portrait): Stack content vertically, use top-to-bottom flow
- If square: Balance elements evenly in all directions
${isVerticalVideo ? '\n- VERTICAL VIDEO FORMAT: Design for mobile viewing, stack elements vertically, use full height, ensure content is readable on small screens' : ''}
${isYouTube ? '\n- YOUTUBE THUMBNAIL: Make text LARGE and BOLD for visibility in small preview, use high contrast, create visual impact that stands out in feed' : ''}

Maintain ALL brand elements:
- Same colors, fonts, and styling
- Same logo placement (adjusted for aspect ratio)
- Same content and text
- Same visual hierarchy and sophistication`;

                // Use prompt architect to enhance with dimension-specific requirements
                promptText = reviewPrompt(promptText, {
                    template: selectedTemplate,
                    dimensions: dimensions
                });

                parts.push({text: promptText});

                // Call Gemini API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutes for quality retries

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            responseModalities: ["image"]
                        }
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await response.json();

                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content;
                    const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                    if (imagePart) {
                        const inlineData = imagePart.inline_data || imagePart.inlineData;
                        let imageData = inlineData.data;
                        const mimeType = inlineData.mimeType || inlineData.mime_type || 'image/png';
                        let imageUrl = `data:${mimeType};base64,${imageData}`;

                        // Add to image history with platform metadata
                        imageHistory.push({
                            url: imageUrl,
                            data: imageData,
                            prompt: `${originalImage.prompt} [${dimensions.name}]`,
                            timestamp: Date.now(),
                            platform: platformKey,
                            dimensions: dimensions,
                            originalIndex: imageIndex
                        });

                        updateImageGallery();
                        console.log(`‚úÖ ${dimensions.name} version generated!`);

                        // Download automatically
                        downloadImageWithPlatformName(imageData, platformKey, formatName);
                    } else {
                        alert('‚ùå No image was generated');
                    }
                } else if (data.error) {
                    alert(`‚ùå API Error: ${data.error.message}`);
                } else {
                    alert('‚ùå Unexpected response');
                }

            } catch (error) {
                console.error('üî¥ Regeneration error:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                isGenerating = false;
                if (btnElement) {
                    btnElement.classList.remove('platform-generating');
                }
            }
        }

        // Download image with platform-specific filename
        function downloadImageWithPlatformName(base64Data, platform, formatName) {
            const link = document.createElement('a');
            link.href = `data:image/png;base64,${base64Data}`;
            const timestamp = Date.now();
            const sanitizedFormat = formatName.replace(/\s+/g, '-').toLowerCase();
            link.download = `wisr-ai-${platform}-${sanitizedFormat}-${timestamp}.png`;
            link.click();
        }

        function toggleExamples() {
            // Not used in template mode
        }

        function useExample(element) {
            // Not used in template mode
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result.split(',')[1];
                uploadedImageData = {
                    data: base64String,
                    mimeType: file.type
                };

                // Show preview container
                const avatar = document.getElementById('photoAvatar');
                const container = document.getElementById('photoPreviewContainer');
                const uploadBtn = document.getElementById('photoUploadBtn');
                const filename = document.getElementById('photoFilename');

                avatar.src = e.target.result;
                filename.textContent = file.name;

                // Toggle visibility
                uploadBtn.style.display = 'none';
                container.classList.add('active');

                console.log('‚úÖ Photo uploaded:', file.name);
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImageData = null;
            document.getElementById('imageUpload').value = '';

            const container = document.getElementById('photoPreviewContainer');
            const uploadBtn = document.getElementById('photoUploadBtn');

            container.classList.remove('active');
            uploadBtn.style.display = 'flex';

            console.log('üóëÔ∏è Photo removed');
        }

        // Format rate change - plain text only, no emojis
        function formatRateChangeWithArrow(changeValue) {
            if (!changeValue || changeValue === '‚Äî' || changeValue === 'unchanged') {
                return '‚Äî'; // No change, use em dash
            }

            // Return the change value as-is (no emojis)
            return changeValue;
        }

        // Build market update prompt - MAXIMUM INFO EDITION (pushing to the edge)
        function buildMarketUpdatePrompt(marketData) {
            // Parse data into safe formats
            const trendBullets = parseMarketTrendBullets(marketData.trend);
            // Use DYNAMIC commentary from live market data
            const commentary = marketData.commentary || marketData.trend || "Rates showing minimal movement this week";

            // Format changes with arrow icons
            const change30yr = formatRateChangeWithArrow(marketData.changes['30yr']);
            const change15yr = formatRateChangeWithArrow(marketData.changes['15yr']);
            const changeJumbo = formatRateChangeWithArrow(marketData.changes['jumbo']);

            console.log('üìä Parsing market data (MAXIMUM INFO):');
            console.log('   Raw trend:', marketData.trend);
            console.log('   Trend bullets:', trendBullets);
            console.log('   Commentary excerpt:', commentary);

            // Check if photo is uploaded
            const photoInstruction = uploadedImageData
                ? 'Seamlessly integrate my photo into the design - remove background and blend naturally. '
                : '';

            // Build trend insights section with bullets (8-10 words each)
            let trendSection = '';
            if (trendBullets.length > 0) {
                trendSection = 'Market Insights:\n';
                trendBullets.forEach(bullet => {
                    trendSection += `‚Ä¢ ${bullet}\n`;
                });
            }

            // Add treasury yields if available
            let treasuryInfo = '';
            if (marketData.treasuries && marketData.treasuries['10yr']) {
                treasuryInfo = `\n10-Year Treasury: ${marketData.treasuries['10yr']}`;
            }

            const logoInstruction = brandLogoData
                ? 'USE THE EXACT LENDWISE LOGO from the first image provided. Place logo in header or footer only. '
                : 'Include LendWise logo. Place logo in header or footer only. ';

            return `Create a PROFESSIONAL MORTGAGE MARKET REPORT.
${photoInstruction}${logoInstruction}

DESIGN: Forest green gradient background with metallic gold text.

Header (5 words):
MORTGAGE MARKET UPDATE ${marketData.date}

Current Rates (15 words max):
30-Year ${marketData.rates['30yr']} ${change30yr} | 15-Year ${marketData.rates['15yr']} ${change15yr} | 10-Year Treasury ${marketData.treasuries['10yr']}%

Market Status (15 words max):
${commentary ? '"' + commentary.toUpperCase() + '"' : '"RATES STABLE NEAR RECENT LOWS"'}

Contact (7 words):
David Young NMLS 62043 Phone 310-954-7771

Portrait 1080x1350.`;
        }

        // Build Daily Rate Update prompt - focuses on WHY rates moved (economic factors)
        function buildDailyRateUpdatePrompt(marketData) {
            // Use DYNAMIC commentary from live market data
            const commentary = marketData.commentary || marketData.trend || "Rates showing minimal movement";

            // Format the 30-year rate change with emoji indicator
            const change30yr = formatRateChangeWithArrow(marketData.changes['30yr']);

            // Get economic factors (3 max for safe zone)
            const economicFactors = marketData.economicFactors || [];
            const topFactors = economicFactors.slice(0, 3); // Limit to 3 (safe zone)

            // Build economic factors bullets - use sophisticated gold lines
            let economicBullets = '';
            topFactors.forEach(item => {
                // Simplify complex phrases for AI text rendering
                let simplified = item.factor
                    .replace('New York Federal Reserve', 'Fed')
                    .replace('Federal Reserve', 'Fed')
                    .replace('according to', 'per')
                    .replace('survey data', 'data');
                economicBullets += `${simplified}\n`;
            });

            // Lock recommendation (avoid word "rate" if possible)
            const lockRec = marketData.lockRecommendation || 'Contact me to discuss your lock timing strategy';

            // Check if photo is uploaded
            const photoInstruction = uploadedImageData
                ? 'Seamlessly integrate my photo into the design - remove background and blend naturally. '
                : '';

            console.log('üìä Building Daily Rate Update with economic factors:');
            console.log('   30-Year Rate:', marketData.rates['30yr'], change30yr);
            console.log('   Economic factors:', topFactors.length);

            const logoInstruction = brandLogoData
                ? 'CRITICAL: USE THE EXACT LENDWISE LOGO from the first image provided. Place logo in header or footer only. '
                : 'CRITICAL: Include LendWise logo (circular badge with wise owl mascot). Place logo in header or footer only. ';

            return `Create a professional daily mortgage market update.
${photoInstruction}${logoInstruction}

DESIGN STYLE: Instagram Story layout - bold visual hierarchy, card-based design, minimal text.

Forest green gradient background. Hyper-realistic metallic gold text for headers and large text.

Header section (4 words):
Daily Rate Update ${marketData.date}

Current Rate (6 words):
30-Year Fixed ${marketData.rates['30yr']} ${change30yr}

Market Drivers Today:
${economicBullets}

Lock Strategy (12 words max):
${lockRec}

Expert Insight - Display quoted text in ALL CAPS with BOTH opening " and closing " marks:
${commentary ? '"' + commentary.toUpperCase() + '"' : ''}

Contact on footer (7 words):
David Young NMLS 62043 Phone 310-954-7771

Portrait 1080x1350.`;
        }

        // Build Rate Trend Analysis prompt with live MND data
        function buildRateTrendsPrompt(marketData) {
            // Use DYNAMIC commentary from live market data
            const commentary = marketData.trend || marketData.commentary || "Rates showing minimal movement with cautious optimism";

            // Calculate 52-week position
            const current30yr = parseFloat(marketData.rates['30yr']);
            const weekHigh = 7.26;
            const weekLow = 6.13;
            const vsHigh = (weekHigh - current30yr).toFixed(2);

            // Determine trend status based on 4-week range
            const fourWeekLow = 6.31;
            const fourWeekHigh = 6.39;
            const rangeDiff = fourWeekHigh - fourWeekLow;
            let trendStatus = rangeDiff < 0.10 ? 'Stable' : 'Volatile';

            // Check if photo is uploaded
            const photoInstruction = uploadedImageData
                ? 'Seamlessly integrate my photo into the design - remove background and blend naturally. '
                : '';

            console.log('üìä Building Rate Trends with live MND data:');
            console.log('   Current 30-Year:', marketData.rates['30yr']);
            console.log('   52-Week Range:', weekLow, '-', weekHigh);
            console.log('   Position vs High:', vsHigh, '% below peak');

            const logoInstruction = brandLogoData
                ? 'USE THE EXACT LENDWISE LOGO from the first image provided. Place logo in header or footer only. '
                : 'Include LendWise logo. Place logo in header or footer only. ';

            return `Create a data visualization design like FiveThirtyEight Data Journalism.
${photoInstruction}${logoInstruction}

DESIGN STYLE: FiveThirtyEight data journalism - chart-first visual storytelling, clean data presentation.

Forest green gradient background. Hyper-realistic metallic gold text for headers and large text.

Header (4 words):
RATE TREND ANALYSIS ${marketData.date}

Current Rate:
${marketData.rates['30yr']} ${trendStatus}

Range Data:
4-Week Range: ${fourWeekLow} - ${fourWeekHigh}
52-Week Range: ${weekLow} - ${weekHigh}

Position:
${vsHigh}% below 52-week high

Forecast with BOTH opening " and closing " marks:
${commentary ? '"' + commentary + '"' : ''}

Contact on footer (7 words):
David Young NMLS 62043 Phone 310-954-7771

Portrait 1080x1350.`;
        }

        // Build Economic Outlook prompt with live MND data
        function buildEconomicOutlookPrompt(marketData) {
            // Use DYNAMIC commentary from live market data - LONGER form for magazine style
            const commentary = marketData.commentary || marketData.trend || "Rates near recent lows with stable economic fundamentals supporting the current market environment";

            // Get economic factors (top 3)
            const economicFactors = marketData.economicFactors || [];
            const topFactors = economicFactors.slice(0, 3);

            // Build factors list - SIMPLIFIED to reduce typos
            let factorsList = '';
            topFactors.forEach((item, index) => {
                const status = item.impact === 'positive' ? 'Improving' : 'Concern';
                // Simplify long economic phrases for AI text rendering
                let simplified = item.factor
                    .replace('Fed Chair Powell suggests potential continued cuts through end of year', 'Fed rate cuts expected')
                    .replace('Inflation expectations rising according to New York Federal Reserve survey data', 'Inflation rising per Fed data')
                    .replace('Markets hovering near multi-week lows showing cautious optimism from investors', 'Markets near lows')
                    .substring(0, 40); // Max 40 chars to prevent wrapping/typos
                factorsList += `${index + 1}. ${simplified}: ${status}\n`;
            });

            // Check if photo is uploaded
            const photoInstruction = uploadedImageData
                ? 'Seamlessly integrate my photo into the design - remove background and blend naturally. '
                : '';

            // Check if logo is provided
            const logoInstruction = brandLogoData
                ? 'USE THE EXACT LENDWISE LOGO from the first image provided. Place logo in header or footer only. '
                : 'Include LendWise logo. Place logo in header or footer only. ';

            console.log('üìä Building Economic Outlook with live MND data:');
            console.log('   Current 30-Year:', marketData.rates['30yr']);
            console.log('   Economic factors:', topFactors.length);
            console.log('   Treasury 10-Year:', marketData.treasuries['10yr']);

            return `Create a magazine editorial design like The Economist.
${photoInstruction}${logoInstruction}

DESIGN STYLE: The Economist feature article - editorial sophistication, narrative-driven, analytical depth.

Forest green gradient background. Hyper-realistic metallic gold text for headers and large text.

Headline (6 words):
ECONOMIC OUTLOOK ${marketData.date}

Subheadline (6 words):
How Conditions Impact Mortgage Rates

Current 30-Year Rate:
${marketData.rates['30yr']}

Key Economic Factors:
${factorsList}

10-Year Treasury Yield:
${marketData.treasuries['10yr']}

Expert Commentary with BOTH opening " and closing " marks:
${commentary ? '"' + commentary + '"' : ''}

Contact on footer (7 words):
David Young NMLS 62043 Phone 310-954-7771

Portrait 1080x1350.`;
        }

        // Build template-specific prompts
        async function buildTemplatePrompt(template) {
            const promptKey = template.prompt;

            // Reverse Mortgage Templates
            if (promptKey === 'reverse_mortgage_intro') {
                return `Create an elegant, educational marketing graphic explaining "What is a Reverse Mortgage?"

HEADLINE: "What is a Reverse Mortgage?"
SUBHEADLINE: "Turn Your Home Equity Into Tax-Free Cash"

KEY POINTS TO INCLUDE (visually organized):
‚úì No monthly mortgage payments required
‚úì Stay in your home as long as you want
‚úì Access your equity without selling
‚úì FHA-insured and government-regulated
‚úì You maintain home ownership

VISUAL ELEMENTS:
- Welcoming, trustworthy design that appeals to seniors (62+)
- Icon of a house with upward arrow or positive symbols
- Clean, readable typography (larger text for senior audience)
- Professional photo-quality imagery

TONE: Educational, reassuring, trustworthy - not salesy

Contact: ${userInfo.name} | NMLS #${userInfo.nmls} | ${userInfo.phone}
Website: lendwisemortgage.com`;
            }

            if (promptKey === 'reverse_mortgage_benefits') {
                return `Create a compelling benefits-focused marketing graphic for reverse mortgages.

HEADLINE: "Reverse Mortgage Benefits"
SUBHEADLINE: "Financial Freedom in Retirement"

KEY BENEFITS (numbered or bullet format):
1. Eliminate Monthly Mortgage Payments - Keep more of your income
2. Tax-Free Cash - No income taxes on proceeds
3. Stay in Your Home - Age in place with dignity
4. Maintain Ownership - Your name stays on the title
5. FHA Protection - Government-insured safety
6. Flexible Payment Options - Lump sum, line of credit, or monthly

VISUAL STYLE:
- Warm, inviting colors with gold accents
- Happy, confident senior imagery (if appropriate)
- Check marks or positive visual indicators
- Professional, Forbes/AARP magazine quality

CALL-TO-ACTION: "Discover Your Options"

Contact: ${userInfo.name} | NMLS #${userInfo.nmls} | ${userInfo.phone}`;
            }

            if (promptKey === 'reverse_mortgage_qualify') {
                return `Create a clear, approachable graphic explaining reverse mortgage eligibility.

HEADLINE: "Do You Qualify?"
SUBHEADLINE: "Simple Requirements for a Reverse Mortgage"

QUALIFICATION CRITERIA (with icons/checkmarks):
‚úì Age 62 or older (all owners)
‚úì Home is your primary residence
‚úì Own your home outright OR have significant equity
‚úì Property is in good condition
‚úì Stay current on property taxes & insurance
‚úì Participate in consumer information session

FRIENDLY NOTE: "Most homeowners 62+ qualify!"

VISUAL STYLE:
- Checklist or step-by-step visual format
- Encouraging, positive imagery
- Large, readable text for senior audience
- Icons for each requirement
- Approachable, friendly tone

CALL-TO-ACTION: "Get Your Free Qualification Analysis"

Contact: ${userInfo.name} | NMLS #${userInfo.nmls} | ${userInfo.phone}`;
            }

            if (promptKey === 'reverse_mortgage_myths') {
                return `Create a myth-busting graphic that addresses common reverse mortgage misconceptions.

HEADLINE: "Reverse Mortgage Myths vs. Facts"
SUBHEADLINE: "Let's Clear Up the Confusion"

MYTHS TO BUST (X vs ‚úì format):
‚ùå MYTH: "The bank owns your home"
‚úì FACT: You retain full ownership and title

‚ùå MYTH: "You can be forced out of your home"
‚úì FACT: You can stay as long as you live there

‚ùå MYTH: "Your heirs lose the home"
‚úì FACT: Heirs can keep it by paying off the loan

‚ùå MYTH: "You can owe more than the home is worth"
‚úì FACT: FHA insurance protects you - never owe more

‚ùå MYTH: "It's too expensive with high fees"
‚úì FACT: Costs are comparable to traditional mortgages

VISUAL STYLE:
- Red X for myths, Green check for facts
- Clear side-by-side comparison layout
- Bold, trustworthy design
- Professional, educational tone

CALL-TO-ACTION: "Get the Real Facts - Free Consultation"

Contact: ${userInfo.name} | NMLS #${userInfo.nmls} | ${userInfo.phone}`;
            }

            if (promptKey === 'reverse_mortgage_uses') {
                return `Create an inspiring graphic showing popular uses for reverse mortgage funds.

HEADLINE: "How Will You Use Your Equity?"
SUBHEADLINE: "Tax-Free Cash for What Matters Most"

POPULAR USES (with icons):
üí∞ Pay Off Existing Mortgage - Eliminate monthly payments
üè• Medical & Healthcare Expenses - Cover costs with dignity
üè† Home Improvements & Repairs - Age-in-place modifications
‚úàÔ∏è Travel & Experiences - Enjoy your retirement dreams
üë®‚Äçüë©‚Äçüëß Help Family - Support children or grandchildren
üìà Supplement Retirement Income - Monthly cash flow
üõ°Ô∏è Emergency Fund - Financial safety net
üí≥ Pay Off Debt - Reduce financial stress

VISUAL STYLE:
- Inspirational, positive imagery
- Lifestyle photos of happy, active seniors
- Warm color palette
- Icons for each use case
- Aspirational, possibility-focused tone

CALL-TO-ACTION: "Explore Your Possibilities"

Contact: ${userInfo.name} | NMLS #${userInfo.nmls} | ${userInfo.phone}`;
            }

            if (promptKey === 'reverse_mortgage_consultation') {
                return `Create a friendly, inviting call-to-action graphic for a free reverse mortgage consultation.

HEADLINE: "Free Reverse Mortgage Consultation"
SUBHEADLINE: "No Obligation ‚Ä¢ No Pressure ‚Ä¢ Just Answers"

WHAT YOU'LL GET:
‚úì Personalized equity analysis for YOUR home
‚úì Clear explanation of how it works
‚úì All your questions answered
‚úì Compare your payment options
‚úì No commitment required

WHY CHOOSE US:
‚Ä¢ ${userInfo.experience || '20+'} Years of Experience
‚Ä¢ Licensed Reverse Mortgage Specialist
‚Ä¢ NMLS #${userInfo.nmls}
‚Ä¢ A+ Rated & Trusted
‚Ä¢ Free, confidential consultation

TESTIMONIAL (if space): "Best decision we made for our retirement!" - Happy Client

VISUAL STYLE:
- Warm, welcoming design
- Photo of ${userInfo.name} (if uploaded) - trustworthy, approachable
- Calendar or consultation imagery
- Gold "FREE" badge or emphasis
- Inviting, non-threatening tone

STRONG CALL-TO-ACTION: "Call Today for Your Free Analysis"

Contact: ${userInfo.name}
Phone: ${userInfo.phone}
NMLS #${userInfo.nmls}
Website: lendwisemortgage.com`;
            }

            // ECONOMIC OUTLOOK
            if (promptKey === 'economic_outlook') {
                return `Create an ELEGANT, SOPHISTICATED economic outlook graphic - think high-end financial magazine analysis.

üé® VISUAL STYLE: ${LENDWISE_THEME.name} - Forbes/Bloomberg/Fortune aesthetic

üìä CONTENT - ECONOMIC OUTLOOK:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Create a professional analysis explaining how current economic conditions impact mortgage rates.

HEADLINE: "ECONOMIC OUTLOOK"
SUBHEADLINE: "How Current Conditions Impact Mortgage Rates"

KEY FACTORS TO VISUALIZE (Choose 3-4 most relevant):
‚Ä¢ Federal Reserve Policy: Current monetary policy stance and impact on rates
‚Ä¢ Inflation Trends: Recent inflation data and trajectory
‚Ä¢ Treasury Yields: 10-year treasury movement and correlation to mortgage rates
‚Ä¢ Employment Data: Job market strength and economic stability
‚Ä¢ Market Volatility: Current market conditions and uncertainty levels
‚Ä¢ Housing Market: Supply/demand dynamics affecting rates

MARKET INSIGHT: Provide 2-3 sentences explaining the current outlook - use simple, clear language that homebuyers can understand.

üìê LAYOUT APPROACH (1080x1350 Instagram portrait):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[TOP SECTION - HERO] (25% of space)
‚Ä¢ LendWise gold owl logo (top-left, subtle)
‚Ä¢ Large headline: "ECONOMIC OUTLOOK" in metallic gold
‚Ä¢ Clean, sophisticated header design

[MIDDLE SECTION - KEY FACTORS] (50% of space)
‚Ä¢ Display 3-4 key economic factors as elegant cards or sections
‚Ä¢ Each factor should have:
  - Clear label (e.g., "INFLATION", "FED POLICY", "TREASURY YIELDS")
  - Brief status or trend indicator
  - Simple icon or visual element
‚Ä¢ Use numbered list or clean grid layout
‚Ä¢ NO busy charts - use simple, elegant visual indicators
‚Ä¢ Generous whitespace between factors

[BOTTOM SECTION - INSIGHT & CONTACT] (25% of space)
‚Ä¢ Market insight summary (2-3 sentences in elegant typography)
‚Ä¢ Contact information:
  - ${userInfo.name}
  - Senior Loan Officer | NMLS #${userInfo.nmls}
  - ${userInfo.phone}

üé® DESIGN REQUIREMENTS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Background: Rich GRADIENT forest green (#1B4D3E to #2D5F4F) with depth
‚Ä¢ Gold: METALLIC gold (#B8860B) with highlights (#DAA520) and shadows (#8B6914)
‚Ä¢ Text: Gold for headlines, cream (#F5F5DC) for body text
‚Ä¢ Visual Style: Forbes/Bloomberg - sophisticated financial analysis
‚Ä¢ Typography: Large headlines, clear hierarchy, readable body text
‚Ä¢ Whitespace: Generous spacing - elegant, not cramped
‚Ä¢ NO complex charts - use simple visual indicators and clean typography

üéØ CRITICAL PRINCIPLES:
‚úì CLARITY: Complex economics explained simply
‚úì VISUAL HIERARCHY: Most important factors largest/boldest
‚úì SOPHISTICATION: Magazine quality, not textbook quality
‚úì TRUST: Professional, authoritative, expert analysis
‚úì ELEGANCE: Clean, sophisticated, high-end financial publication

üö´ AVOID:
‚úó NO complex charts or graphs (keep it simple and elegant)
‚úó NO cluttered layouts with too much data
‚úó NO technical jargon - use clear, accessible language
‚úó NO boring academic look - make it visually engaging

Think: "What would a luxury financial magazine do?" Make it beautiful, insightful, and sophisticated.`;
            }

            // RATE TREND ANALYSIS
            if (promptKey === 'rate_trends') {
                return `Create an ELEGANT, SOPHISTICATED rate trend analysis graphic - visual storytelling with mortgage rate movement.

üé® VISUAL STYLE: ${LENDWISE_THEME.name} - Forbes/Bloomberg data visualization aesthetic

üìä CONTENT - RATE TREND ANALYSIS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Create a visual analysis showing how mortgage rates have moved over recent weeks/months.

HEADLINE: "MORTGAGE RATE TRENDS"
SUBHEADLINE: "Recent Movement & Outlook"

RATE MOVEMENT DATA (Use representative/realistic data):
‚Ä¢ 30-Year Fixed: Show 4-week trend (e.g., 6.45% ‚Üí 6.38% ‚Üí 6.42% ‚Üí 6.38%)
‚Ä¢ Direction indicator: "‚Üì Down 0.07% from peak" or "‚Üë Up 0.04% this week"
‚Ä¢ Trend summary: "Stable" / "Rising" / "Falling" / "Volatile"

OUTLOOK STATEMENT:
Provide 2-3 sentences about where rates are heading based on current trends.
Examples:
- "Rates remain stable with minimal week-to-week movement"
- "Gradual upward trend as Fed maintains current policy"
- "Recent decline creates opportunity for buyers"

üìê LAYOUT APPROACH (1080x1350 Instagram portrait):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[TOP SECTION - HERO] (20% of space)
‚Ä¢ LendWise gold owl logo (top-left)
‚Ä¢ Large headline: "MORTGAGE RATE TRENDS" in metallic gold
‚Ä¢ Subheadline: Date range (e.g., "Past 30 Days")

[MIDDLE SECTION - VISUAL TREND] (55% of space)
‚Ä¢ Feature CURRENT 30-YEAR RATE prominently (huge metallic gold: "6.38%")
‚Ä¢ Below it: "30-Year Fixed Rate" label
‚Ä¢ Simple trend visualization:
  - Option 1: Clean line chart showing 4-week movement (elegant, minimal)
  - Option 2: Large arrow indicator with direction and change amount
  - Option 3: Before/after comparison with elegant typography
‚Ä¢ Trend indicator: "‚Üì DOWN", "‚Üë UP", or "‚Üí STABLE" with change amount
‚Ä¢ Keep it SIMPLE and ELEGANT - not a complex financial chart

[BOTTOM SECTION - OUTLOOK & CONTACT] (25% of space)
‚Ä¢ "OUTLOOK" header in gold
‚Ä¢ 2-3 sentence summary of where rates are heading
‚Ä¢ Thin gold divider
‚Ä¢ Contact information:
  - ${userInfo.name}
  - Senior Loan Officer | NMLS #${userInfo.nmls}
  - ${userInfo.phone}

üé® DESIGN REQUIREMENTS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Background: Rich GRADIENT forest green (#1B4D3E to #2D5F4F) with depth
‚Ä¢ Gold: METALLIC gold (#B8860B) with highlights (#DAA520) and shadows (#8B6914)
‚Ä¢ Chart/Visual: Elegant and minimal - use gold lines on green background
‚Ä¢ Typography: Large rate numbers (80pt+), clear labels, readable outlook text
‚Ä¢ Visual Style: Think Apple product launch or luxury brand - sophisticated simplicity
‚Ä¢ Whitespace: Generous spacing around all elements

üéØ CRITICAL PRINCIPLES:
‚úì SIMPLICITY: One clear story - where are rates going?
‚úì VISUAL IMPACT: Big, bold rate number is the hero
‚úì CLARITY: Trend direction immediately obvious
‚úì SOPHISTICATION: Elegant data visualization, not spreadsheet
‚úì ACTIONABLE: Clear outlook helps buyers make decisions

üö´ AVOID:
‚úó NO complex multi-line charts with dozens of data points
‚úó NO cluttered axis labels and grid lines
‚úó NO technical financial chart look
‚úó NO small, hard-to-read numbers
‚úó NO overwhelming amount of historical data

Think: "How would Apple visualize rate trends?" Make it clean, bold, and beautifully simple.`;
            }

            // DEFAULT: If no specific template prompt exists, use the template's synopsis
            return `Create a professional mortgage marketing graphic for: ${template.name}

üé® BASE LENDWISE BRAND COLORS (Default - Customizable):
- Background: Rich GRADIENT forest green from ${LENDWISE_THEME.colors.green.forest} to ${LENDWISE_THEME.colors.green.deep}
  (NOT flat - add smooth gradient with depth and dimension to make it pop)

- Accent: METALLIC, HYPER-REALISTIC gold ${LENDWISE_THEME.colors.gold.metallic}
  (Add shine, reflections, 3D depth - make it look like real polished gold with highlights ${LENDWISE_THEME.colors.gold.bright} and shadows ${LENDWISE_THEME.colors.gold.bronze})

Include ${userInfo.name}'s contact information:
- NMLS #${userInfo.nmls}
- Phone: ${userInfo.phone}

Design should be elegant, professional, and sophisticated - magazine quality, not corporate.
Make colors rich, dimensional, and eye-catching.

NOTE: These are LendWise standard brand colors. If user requests different colors, honor their request.`;
        }

        // Generate image from prompt
        // LEARNING AGENT - Verifies text accuracy and retries if needed
        async function verifyImageText(imageBase64) {
            console.log('ü§ñ AGENT: Starting text verification...');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: imageBase64 } },
                                { text: `üö® SURGICAL TEXT REPLACEMENT - SPELL CHECK + STYLING ANALYSIS üö®

Your task is to be a RUTHLESS spell checker AND provide detailed styling information for surgical text replacement.

IMAGE DIMENSIONS: 1080px wide x 1350px tall (Instagram portrait format)

PART 1 - SPELL CHECK:
1. Extract ALL visible text from this image
2. Check EVERY single word CHARACTER BY CHARACTER against correct English spelling
3. Flag ANY word that is not spelled PERFECTLY, including:
   - Missing letters (e.g., "APPRECATING" vs "APPRECIATING" - MISSING "I")
   - Wrong letters (e.g., "UNHANGED" vs "UNCHANGED" - WRONG LETTERS)
   - Extra letters, transposed letters, weird symbols, garbled text

4. Common mortgage/finance words to verify EXACTLY:
   - APPRECIATING (NOT "APPRECATING")
   - UNCHANGED (NOT "UNHANGED")
   - INVENTORY, HOMEOWNERSHIP, MORTGAGE, OUTLOOK, FAVORABLE, REFINANCE, ACCESSIBLE, INVESTMENT

PART 2 - DETAILED TEXT BLOCK ANALYSIS:
For EVERY text element in the image, provide:
- Exact text content (with spelling errors as they appear)
- Bounding box coordinates (x, y, width, height in pixels)
- Detailed styling: font family, size, weight, color/gradient, shadows, alignment
- Whether it contains spelling errors
- If errors exist, the corrected version

üö® CRITICAL: Provide bounding boxes for ALL text elements, not just errors!

Respond ONLY with valid JSON (no markdown):
{
  "valid": false,
  "issues": ["Text block 'Market Indicators' contains: word 'APPRECATING' should be 'APPRECIATING'"],
  "confidence": 95,
  "imageSize": {"width": 1080, "height": 1350},
  "textBlocks": [
    {
      "id": "header",
      "content": "ECONOMIC OUTLOOK",
      "correctedContent": "ECONOMIC OUTLOOK",
      "boundingBox": {"x": 150, "y": 60, "width": 780, "height": 60},
      "styling": {
        "fontFamily": "Playfair Display, serif",
        "fontSize": 48,
        "fontWeight": "700",
        "color": {"type": "solid", "value": "#FFD700"},
        "textTransform": "uppercase",
        "shadow": {"blur": 8, "color": "rgba(0,0,0,0.6)", "offsetX": 0, "offsetY": 4},
        "align": "center",
        "letterSpacing": "2px"
      },
      "hasErrors": false,
      "errorDetails": []
    },
    {
      "id": "section_header_1",
      "content": "MARKET VOLATILITY",
      "correctedContent": "MARKET VOLATILITY",
      "boundingBox": {"x": 65, "y": 355, "width": 150, "height": 25},
      "styling": {
        "fontFamily": "Open Sans, sans-serif",
        "fontSize": 16,
        "fontWeight": "700",
        "color": {"type": "solid", "value": "#FFD700"},
        "textTransform": "uppercase",
        "shadow": {"blur": 4, "color": "rgba(0,0,0,0.5)", "offsetX": 0, "offsetY": 2},
        "align": "left"
      },
      "hasErrors": false,
      "errorDetails": []
    },
    {
      "id": "body_text_1",
      "content": "Inflation concerns persist. Economic data showd signals.",
      "correctedContent": "Inflation concerns persist. Economic data showed signals.",
      "boundingBox": {"x": 65, "y": 385, "width": 140, "height": 60},
      "styling": {
        "fontFamily": "Open Sans, sans-serif",
        "fontSize": 12,
        "fontWeight": "400",
        "color": {"type": "solid", "value": "#F5F5DC"},
        "shadow": {"blur": 3, "color": "rgba(0,0,0,0.4)", "offsetX": 0, "offsetY": 2},
        "align": "left",
        "lineHeight": "1.5"
      },
      "hasErrors": true,
      "errorDetails": ["'showd' should be 'showed' (missing 'e')"]
    }
  ]
}

IMPORTANT NOTES:
- Include ALL text elements (headers, body, labels, footer, everything)
- Bounding boxes must be accurate pixel coordinates
- **CRITICAL: Detect GRADIENT vs SOLID colors accurately**
  - SOLID example: {"type": "solid", "value": "#FFD700"}
  - GRADIENT example: {"type": "gradient", "stops": [{"offset": 0, "color": "#B8860B"}, {"offset": 0.5, "color": "#FFD700"}, {"offset": 1, "color": "#B8860B"}], "direction": "vertical"}
  - Metallic gold text typically has gradient (look for shine/dimensional effect)
  - Plain text typically solid color
- If text has glow effect, note it: {"glow": {"color": "#FFD700", "blur": 20}}
- Set "valid": false if ANY text block has errors

Remember:
1. BE RUTHLESS about spelling - Even ONE wrong letter = ERROR
2. ACCURATELY detect gradients - Gemini often uses metallic gold gradients that look 3D/shiny` }
                            ]
                        }]
                    })
                });

                console.log('ü§ñ AGENT: Vision API response status:', response.status);
                const data = await response.json();
                console.log('ü§ñ AGENT: Raw Vision API response:', data);

                if (data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    console.log('ü§ñ AGENT: Raw text from Vision API:', text);

                    const result = JSON.parse(text.replace(/```json|```/g, '').trim());

                    // Count text blocks with errors
                    const blocksWithErrors = result.textBlocks ?
                        result.textBlocks.filter(block => block.hasErrors) : [];

                    // Consolidate all errors from text blocks
                    const allErrors = new Set(result.issues || []);

                    if (blocksWithErrors.length > 0) {
                        blocksWithErrors.forEach(block => {
                            if (block.errorDetails && Array.isArray(block.errorDetails)) {
                                block.errorDetails.forEach(err => allErrors.add(err));
                            }
                        });
                    }

                    // Legacy support: Check errorsByStyle if present
                    if (result.errorsByStyle) {
                        for (const [style, errors] of Object.entries(result.errorsByStyle)) {
                            if (Array.isArray(errors)) {
                                errors.forEach(err => allErrors.add(err));
                            }
                        }
                    }

                    // Update the issues array with ALL errors found
                    result.issues = Array.from(allErrors);

                    // If there are any errors, mark as invalid
                    if (result.issues.length > 0) {
                        result.valid = false;
                    }

                    console.log(`ü§ñ AGENT: Verification complete - ${result.issues.length} errors found in ${blocksWithErrors.length} text blocks`);
                    console.log('ü§ñ AGENT: Text blocks analyzed:', result.textBlocks?.length || 0);
                    console.log('ü§ñ AGENT: Parsed verification result:', result);
                    return result;
                }
            } catch (error) {
                console.error('ü§ñ AGENT ERROR in verification:', error);
            }
            console.warn('ü§ñ AGENT: Verification failed - defaulting to VALID (this means agent is not working!)');
            return { valid: true, confidence: 100 };
        }

        // ============================================
        // POST-PROCESSING: AI Text Correction System
        // ============================================

        // Analyze text regions and their positions in the image
        async function analyzeTextRegions(imageBase64, allText) {
            console.log('üîç POST-PROCESS: Analyzing text regions and styling...');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: imageBase64 } },
                                { text: `Analyze ALL text in this image and provide detailed location and styling info.

For each distinct text element, identify:
1. The exact text content
2. Approximate position (top/middle/bottom, left/center/right)
3. Relative size (tiny/small/medium/large/huge)
4. Color (describe or hex if possible)
5. Style (bold/regular, serif/sans-serif)
6. Text type (heading/body/label/number/name)

Respond with JSON array:
[
  {
    "text": "CURRENT MORTGAGE RATES",
    "position": {"vertical": "top", "horizontal": "center"},
    "size": "large",
    "color": "#DAA520",
    "style": "bold sans-serif",
    "type": "heading"
  },
  ...
]` }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    const regions = JSON.parse(text.replace(/```json|```/g, '').trim());
                    console.log(`üîç POST-PROCESS: Found ${regions.length} text regions`);
                    return regions;
                }
            } catch (error) {
                console.error('üîç POST-PROCESS: Analysis failed:', error);
            }

            return [];
        }

        // Match brand text styles based on type
        function getBrandTextStyle(textType, sizeHint) {
            const styles = {
                heading: {
                    fontFamily: 'Arial Black, sans-serif',
                    fontWeight: 'bold',
                    fontSize: sizeHint === 'huge' ? 56 : sizeHint === 'large' ? 42 : 36,
                    color: '#DAA520',
                    hasGradient: true
                },
                body: {
                    fontFamily: 'Arial, sans-serif',
                    fontWeight: 'normal',
                    fontSize: sizeHint === 'medium' ? 18 : sizeHint === 'small' ? 14 : 16,
                    color: '#FFFFFF',
                    hasGradient: false
                },
                number: {
                    fontFamily: 'Arial Black, sans-serif',
                    fontWeight: 'bold',
                    fontSize: sizeHint === 'huge' ? 72 : sizeHint === 'large' ? 56 : 42,
                    color: '#DAA520',
                    hasGradient: true
                },
                label: {
                    fontFamily: 'Arial, sans-serif',
                    fontWeight: '600',
                    fontSize: sizeHint === 'small' ? 12 : 14,
                    color: '#FFFFFF',
                    hasGradient: false
                }
            };

            return styles[textType] || styles.body;
        }

        // Main post-processing function to fix ALL spelling errors using Gemini inpainting
        async function fixAllTextErrors(imageBase64, verification) {
            if (!verification.issues || verification.issues.length === 0) {
                console.log('‚úÖ POST-PROCESS: No errors to fix');
                return imageBase64;
            }

            console.log(`üîß POST-PROCESS: Fixing ${verification.issues.length} spelling errors using AI inpainting...`);

            try {
                // Build correction list for Gemini
                const corrections = [];
                for (const errorText of verification.issues) {
                    const match = errorText.match(/word '(.+?)' should be '(.+?)'/);
                    if (match) {
                        const [, wrongWord, correctWord] = match;
                        corrections.push({ wrong: wrongWord, correct: correctWord });
                        console.log(`  üìù Will fix: "${wrongWord}" ‚Üí "${correctWord}"`);
                    }
                }

                if (corrections.length === 0) {
                    return imageBase64;
                }

                // Use Gemini to fix the image with perfect style matching
                const prompt = `Fix the spelling errors in this image. The text should maintain EXACT same styling, fonts, colors, sizes, and effects as the original.

SPELLING CORRECTIONS TO MAKE:
${corrections.map(c => `- Change "${c.wrong}" to "${c.correct}"`).join('\n')}

CRITICAL REQUIREMENTS:
- Match the EXACT styling of each word (same font, size, color, gradient, shadow, effects)
- Seamlessly integrate corrections - no one should notice they were changed
- Keep all other text and design elements UNCHANGED
- Maintain the same layout and positioning
- This is a professional marketing image - quality must be perfect

Simply return the corrected image with flawless text.`;

                console.log('üîß Sending to Gemini for AI-powered text correction...');

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: imageBase64 } },
                                { text: prompt }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3, // Low temperature for accuracy
                            topK: 20,
                            topP: 0.8,
                            responseModalities: ["image"]
                        }
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content;
                    const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                    if (imagePart) {
                        const inlineData = imagePart.inline_data || imagePart.inlineData;
                        const correctedBase64 = inlineData.data;
                        console.log(`‚úÖ POST-PROCESS: Gemini successfully fixed all ${corrections.length} errors with perfect style matching!`);
                        return correctedBase64;
                    }
                }

                console.warn('‚ö†Ô∏è POST-PROCESS: Gemini did not return corrected image');
                return imageBase64;

            } catch (error) {
                console.error('üîß POST-PROCESS: Error during text correction:', error);
                return imageBase64; // Return original on error
            }
        }

        // Helper function to get average color from image data
        function getAverageColor(imgData) {
            let r = 0, g = 0, b = 0;
            const pixels = imgData.data.length / 4;

            for (let i = 0; i < imgData.data.length; i += 4) {
                r += imgData.data[i];
                g += imgData.data[i + 1];
                b += imgData.data[i + 2];
            }

            return {
                r: Math.round(r / pixels),
                g: Math.round(g / pixels),
                b: Math.round(b / pixels)
            };
        }

        // Function to view what the agent has learned
        function showAgentMemory() {
            const failures = JSON.parse(localStorage.getItem('agent_failures') || '[]');

            if (failures.length === 0) {
                console.log('üìä AGENT MEMORY: No failures recorded yet');
                return;
            }

            console.log('üìä AGENT MEMORY - Last 20 Failures:');
            console.log('=====================================');

            failures.forEach((failure, index) => {
                console.log(`\nFailure #${index + 1}:`);
                console.log(`  Time: ${new Date(failure.timestamp).toLocaleString()}`);
                console.log(`  Issues: ${failure.issues.join(', ')}`);
                console.log(`  Prompt: ${failure.prompt.substring(0, 100)}...`);
            });

            // Show patterns
            const allIssues = failures.flatMap(f => f.issues);
            const issueCount = {};
            allIssues.forEach(issue => {
                issueCount[issue] = (issueCount[issue] || 0) + 1;
            });

            console.log('\nüîç COMMON ISSUES (patterns the agent has learned):');
            Object.entries(issueCount)
                .sort((a, b) => b[1] - a[1])
                .forEach(([issue, count]) => {
                    console.log(`  - ${issue} (occurred ${count} times)`);
                });

            console.log(`\nüìà TOTAL LEARNING EVENTS: ${failures.length}`);
        }

        // Make it accessible from console
        window.showAgentMemory = showAgentMemory;

        // ============================================
        // TRUE LEARNING AGENT - Advanced Functions
        // ============================================

        // Initialize or get agent memory
        function getAgentMemory() {
            const defaultMemory = {
                globalLessons: {
                    alwaysEmphasize: [], // Words that frequently misspell
                    avoidPatterns: [],   // Patterns that cause errors
                    successfulTechniques: [] // Techniques that work well
                },
                strategies: {
                    standard: { successCount: 0, failCount: 0, totalAttempts: 0 },
                    simplified: { successCount: 0, failCount: 0, totalAttempts: 0 },
                    bulletPoints: { successCount: 0, failCount: 0, totalAttempts: 0 },
                    allCaps: { successCount: 0, failCount: 0, totalAttempts: 0 },
                    minimal: { successCount: 0, failCount: 0, totalAttempts: 0 },
                    visionTypography: { successCount: 0, failCount: 0, totalAttempts: 0, description: 'üé® Background-first with Vision AI font selection' }
                },
                stylingPatterns: {
                    gold_gradient: {
                        totalTextInstances: 0,
                        errorCount: 0,
                        successRate: 100,
                        examples: []
                    },
                    plain_white: {
                        totalTextInstances: 0,
                        errorCount: 0,
                        successRate: 0,
                        examples: []
                    },
                    plain_colored: {
                        totalTextInstances: 0,
                        errorCount: 0,
                        successRate: 0,
                        examples: []
                    }
                },
                stats: {
                    totalGenerations: 0,
                    successfulGenerations: 0,
                    currentSuccessRate: 0
                },
                recentFailures: [] // Last 20 failures
            };

            const stored = localStorage.getItem('agent_learning_memory');
            return stored ? JSON.parse(stored) : defaultMemory;
        }

        function saveAgentMemory(memory) {
            localStorage.setItem('agent_learning_memory', JSON.stringify(memory));
        }

        // Analyze styling patterns from verification results
        function analyzeTextStyling(verification, memory) {
            console.log('üé® AGENT: Analyzing text styling patterns...');

            if (!verification.textByStyle || !verification.errorsByStyle) {
                console.warn('‚ö†Ô∏è AGENT: Verification missing style data');
                return;
            }

            // Ensure stylingPatterns exists in memory (for backwards compatibility)
            if (!memory.stylingPatterns) {
                memory.stylingPatterns = {
                    gold_gradient: { totalTextInstances: 0, errorCount: 0, successRate: 100, examples: [] },
                    plain_white: { totalTextInstances: 0, errorCount: 0, successRate: 0, examples: [] },
                    plain_colored: { totalTextInstances: 0, errorCount: 0, successRate: 0, examples: [] }
                };
            }

            // Update stats for each style
            for (const [style, textArray] of Object.entries(verification.textByStyle)) {
                if (!memory.stylingPatterns[style]) {
                    memory.stylingPatterns[style] = { totalTextInstances: 0, errorCount: 0, successRate: 0, examples: [] };
                }

                const pattern = memory.stylingPatterns[style];
                const textCount = textArray.length;
                const errorCount = verification.errorsByStyle[style] ? verification.errorsByStyle[style].length : 0;

                pattern.totalTextInstances += textCount;
                pattern.errorCount += errorCount;

                // Calculate success rate
                if (pattern.totalTextInstances > 0) {
                    const successInstances = pattern.totalTextInstances - pattern.errorCount;
                    pattern.successRate = (successInstances / pattern.totalTextInstances) * 100;
                }

                // Store examples (keep last 5)
                textArray.slice(0, 3).forEach(text => {
                    if (!pattern.examples.includes(text)) {
                        pattern.examples.push(text);
                    }
                });
                pattern.examples = pattern.examples.slice(-5);

                console.log(`üé® ${style}: ${textCount} instances, ${errorCount} errors, ${pattern.successRate.toFixed(1)}% success rate`);
            }

            saveAgentMemory(memory);

            // Report discoveries
            const goldRate = memory.stylingPatterns.gold_gradient.successRate;
            const plainRate = memory.stylingPatterns.plain_white.successRate;

            if (goldRate > 80 && plainRate < 30) {
                console.log(`üí° AGENT DISCOVERY: Gold gradient text is ${goldRate.toFixed(0)}% accurate vs ${plainRate.toFixed(0)}% for plain text!`);
                return 'gold_gradient_superior';
            }

            return null;
        }

        // Analyze failure to understand root cause
        async function analyzeFailure(imageBase64, errors, attemptNumber) {
            console.log(`üß† AGENT: Analyzing root cause of ${errors.length} errors (Attempt ${attemptNumber})...`);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: imageBase64 } },
                                { text: `This image has spelling errors: ${errors.join(', ')}

Analyze WHY these errors occurred:
1. Is there too much text crammed in?
2. Are the words too complex/difficult?
3. Is the font size too small?
4. Is there poor contrast making text hard to read?
5. Are there spacing/layout issues?

Respond with JSON:
{
  "rootCauses": ["primary cause", "secondary cause"],
  "recommendation": "specific change to make for next attempt",
  "simplifyWords": true/false,
  "reduceDensity": true/false,
  "emphasizeMore": true/false
}` }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    const analysis = JSON.parse(text.replace(/```json|```/g, '').trim());
                    console.log('üß† AGENT ANALYSIS:', analysis);
                    return analysis;
                }
            } catch (error) {
                console.error('üß† AGENT: Analysis failed:', error);
            }

            return {
                rootCauses: ['unknown'],
                recommendation: 'simplify text and increase emphasis',
                simplifyWords: true,
                reduceDensity: false,
                emphasizeMore: true
            };
        }

        // Select prompting strategy based on attempt and past performance
        function selectStrategy(attemptNumber, memory) {
            const strategies = memory.strategies;

            // Calculate success rates
            const strategyScores = {};
            for (const [name, stats] of Object.entries(strategies)) {
                if (stats.totalAttempts > 0) {
                    strategyScores[name] = stats.successCount / stats.totalAttempts;
                } else {
                    strategyScores[name] = 0.5; // Default unknown
                }
            }

            console.log('üìä AGENT: Strategy success rates:', strategyScores);

            // Attempt 1: Use best performing strategy
            if (attemptNumber === 1) {
                const bestStrategy = Object.entries(strategyScores)
                    .sort((a, b) => b[1] - a[1])[0][0];
                console.log(`üéØ AGENT: Using best strategy: ${bestStrategy} (${(strategyScores[bestStrategy] * 100).toFixed(0)}% success rate)`);
                return bestStrategy;
            }

            // Attempt 2: Use different approach
            if (attemptNumber === 2) {
                console.log('üéØ AGENT: Trying different strategy: bulletPoints');
                return 'bulletPoints';
            }

            // Attempt 3: Most aggressive
            console.log('üéØ AGENT: Final attempt - using most aggressive strategy: allCaps');
            return 'allCaps';
        }

        // Get learned lessons to inject into prompts
        function getLearnedLessons(memory) {
            const lessons = [];

            // Add always-emphasize words
            if (memory.globalLessons.alwaysEmphasize.length > 0) {
                lessons.push(`CRITICAL SPELLING (these words often fail - spell EXACTLY):`);
                memory.globalLessons.alwaysEmphasize.forEach(word => {
                    lessons.push(`  - "${word.correct}" (NOT "${word.wrong}")`);
                });
            }

            // Add successful techniques
            if (memory.globalLessons.successfulTechniques.length > 0) {
                lessons.push(`PROVEN TECHNIQUES (these work well):`);
                memory.globalLessons.successfulTechniques.forEach(tech => {
                    lessons.push(`  - ${tech}`);
                });
            }

            // Add patterns to avoid
            if (memory.globalLessons.avoidPatterns.length > 0) {
                lessons.push(`AVOID THESE PATTERNS:`);
                memory.globalLessons.avoidPatterns.forEach(pattern => {
                    lessons.push(`  - ${pattern}`);
                });
            }

            return lessons.join('\n');
        }

        // Build strategy-specific prompt enhancement
        function buildStrategyPrompt(strategy, analysis = null) {
            const prompts = {
                standard: `
TEXT ACCURACY REQUIREMENTS:
- Spell every word correctly
- Use clear, readable fonts
- Ensure proper spacing`,

                simplified: `
üîπ SIMPLIFIED TEXT STRATEGY:
- Use SHORT, SIMPLE words only
- Break complex ideas into simple phrases
- Maximum 5-7 words per line
- Large, bold, clear text`,

                bulletPoints: `
üìã BULLET POINT STRATEGY:
- Format ALL text as bullet points
- One concept per bullet
- Very short bullets (3-5 words each)
- Large bullet icons
- Extra spacing between items`,

                allCaps: `
üö® MAXIMUM EMPHASIS STRATEGY:
- Use ALL CAPS for critical words
- BOLD and LARGE text
- HIGH CONTRAST colors
- Repeat critical information
- Spell out each letter if needed:
  Example: C-R-U-C-I-A-L not "cruciual"`,

                minimal: `
‚ú® MINIMAL TEXT STRATEGY:
- ONLY essential text (3-4 words total)
- HUGE font size
- Maximum readability
- No complex words whatsoever`
            };

            let prompt = prompts[strategy] || prompts.standard;

            // Add analysis-based adjustments
            if (analysis) {
                if (analysis.simplifyWords) {
                    prompt += `\nüî∏ Use simpler vocabulary - complex words are causing errors`;
                }
                if (analysis.reduceDensity) {
                    prompt += `\nüî∏ Reduce text density - too much text is causing errors`;
                }
                if (analysis.emphasizeMore) {
                    prompt += `\nüî∏ Increase emphasis and size - text needs to be more prominent`;
                }
            }

            return prompt;
        }

        // Update agent memory with results
        function updateAgentLearning(memory, strategy, success, errors = []) {
            // Ensure strategy exists in memory (for new strategies like twoPass_*)
            if (!memory.strategies[strategy]) {
                memory.strategies[strategy] = { successCount: 0, failCount: 0, totalAttempts: 0 };
            }

            // Update strategy stats
            memory.strategies[strategy].totalAttempts++;
            if (success) {
                memory.strategies[strategy].successCount++;
            } else {
                memory.strategies[strategy].failCount++;
            }

            // Update global stats
            memory.stats.totalGenerations++;
            if (success) {
                memory.stats.successfulGenerations++;
            }
            memory.stats.currentSuccessRate =
                (memory.stats.successfulGenerations / memory.stats.totalGenerations) * 100;

            // Learn from errors
            if (!success && errors.length > 0) {
                errors.forEach(error => {
                    // Extract word patterns
                    const match = error.match(/word '(.+?)' should be '(.+?)'/);
                    if (match) {
                        const [, wrong, correct] = match;
                        // Add to always-emphasize if it doesn't exist
                        const exists = memory.globalLessons.alwaysEmphasize.find(
                            item => item.correct === correct
                        );
                        if (!exists) {
                            memory.globalLessons.alwaysEmphasize.push({ wrong, correct });
                            console.log(`üìö AGENT LEARNED: Always emphasize "${correct}" (not "${wrong}")`);
                        }
                    }
                });

                // Keep last 20 failures
                memory.recentFailures.push({
                    errors,
                    strategy,
                    timestamp: Date.now()
                });
                memory.recentFailures = memory.recentFailures.slice(-20);
            }

            // Add successful techniques
            if (success && !memory.globalLessons.successfulTechniques.includes(strategy)) {
                memory.globalLessons.successfulTechniques.push(strategy);
                console.log(`‚úÖ AGENT LEARNED: "${strategy}" strategy works well`);
            }

            saveAgentMemory(memory);
            console.log(`üìä AGENT STATS: ${memory.stats.successfulGenerations}/${memory.stats.totalGenerations} success (${memory.stats.currentSuccessRate.toFixed(1)}%)`);
        }

        // Show agent learning dashboard
        function showAgentStats() {
            const memory = getAgentMemory();
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('ü§ñ AGENT LEARNING DASHBOARD');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`\nüìà OVERALL SUCCESS RATE: ${memory.stats.currentSuccessRate.toFixed(1)}%`);
            console.log(`   Total Generations: ${memory.stats.totalGenerations}`);
            console.log(`   Successful: ${memory.stats.successfulGenerations}`);
            console.log(`   Failed: ${memory.stats.totalGenerations - memory.stats.successfulGenerations}`);

            console.log('\nüìä STRATEGY PERFORMANCE:');
            for (const [name, stats] of Object.entries(memory.strategies)) {
                if (stats.totalAttempts > 0) {
                    const rate = (stats.successCount / stats.totalAttempts * 100).toFixed(1);
                    console.log(`   ${name}: ${rate}% (${stats.successCount}/${stats.totalAttempts})`);
                }
            }

            console.log('\nüé® TEXT STYLING PATTERNS:');
            if (memory.stylingPatterns) {
                for (const [style, data] of Object.entries(memory.stylingPatterns)) {
                    if (data.totalTextInstances > 0) {
                        console.log(`   ${style}: ${data.successRate.toFixed(1)}% accuracy (${data.totalTextInstances - data.errorCount}/${data.totalTextInstances} correct)`);
                        if (data.examples.length > 0) {
                            console.log(`      Examples: ${data.examples.slice(0, 3).join(', ')}`);
                        }
                    }
                }
            } else {
                console.log('   (no data yet)');
            }

            console.log('\nüìö LEARNED SPELLING PATTERNS:');
            if (memory.globalLessons.alwaysEmphasize.length > 0) {
                memory.globalLessons.alwaysEmphasize.slice(-10).forEach(item => {
                    console.log(`   ‚ùå "${item.wrong}" ‚Üí ‚úÖ "${item.correct}"`);
                });
                if (memory.globalLessons.alwaysEmphasize.length > 10) {
                    console.log(`   ... and ${memory.globalLessons.alwaysEmphasize.length - 10} more`);
                }
            } else {
                console.log('   (none yet)');
            }

            console.log('\n‚ú® SUCCESSFUL TECHNIQUES:');
            if (memory.globalLessons.successfulTechniques.length > 0) {
                memory.globalLessons.successfulTechniques.forEach(tech => {
                    console.log(`   - ${tech}`);
                });
            } else {
                console.log('   (none yet)');
            }
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        window.showAgentStats = showAgentStats;

        // Get last autonomous learning results (for automation)
        function getLastLearningResults() {
            const data = localStorage.getItem('autonomousLearning_lastResults');
            if (!data) {
                console.log('‚ùå No autonomous learning results found');
                return null;
            }

            const results = JSON.parse(data);

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä LAST AUTONOMOUS LEARNING RESULTS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`\n‚è∞ Timestamp: ${results.timestamp}`);
            console.log(`\nüìà SUCCESS RATE: ${results.summary.successRate}`);
            console.log(`   Total: ${results.summary.total}`);
            console.log(`   ‚úÖ Successful: ${results.summary.successful}`);
            console.log(`   üèÜ Perfect: ${results.summary.perfect}`);
            console.log(`   ‚ùå Failed: ${results.summary.failed}`);

            if (Object.keys(results.stylingPatterns).length > 0) {
                console.log(`\nüé® STYLING PATTERNS:`);
                for (const [style, data] of Object.entries(results.stylingPatterns)) {
                    console.log(`   ${style}: ${data.successRate} (${data.accuracy} correct)`);
                }
            }

            console.log(`\nüìã INDIVIDUAL RESULTS:`);
            results.results.forEach(r => {
                const icon = r.success ? '‚úÖ' : '‚ùå';
                console.log(`   ${icon} Gen ${r.generationNumber}: ${r.errorCount} errors (${r.strategy})`);
                if (r.issues.length > 0 && r.issues.length <= 3) {
                    r.issues.forEach(issue => {
                        console.log(`      - ${issue}`);
                    });
                }
            });

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

            return results;
        }

        window.getLastLearningResults = getLastLearningResults;

        // Show Phase 3 correction statistics
        function showCorrectionStats() {
            const memory = getAgentMemory();
            if (!memory.correctionStats) {
                console.log('‚ùå No Phase 3 correction data yet');
                return;
            }

            const stats = memory.correctionStats;
            const successRate = stats.totalAttempts > 0
                ? (stats.successful / stats.totalAttempts * 100).toFixed(1)
                : 0;

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîß PHASE 3 CORRECTION STATISTICS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`\nüìä SUCCESS RATE: ${successRate}%`);
            console.log(`   Total Correction Attempts: ${stats.totalAttempts}`);
            console.log(`   ‚úÖ Successful: ${stats.successful}`);
            console.log(`   ‚ùå Failed: ${stats.failed}`);
            console.log('\nüí° Phase 3 uses targeted correction to fix specific');
            console.log('   errors without full regeneration, aiming for 100% accuracy.');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        }

        window.showCorrectionStats = showCorrectionStats;

        // ============================================
        // AUTONOMOUS LEARNING MODE
        // ============================================

        let isLearning = false;
        let learningResults = [];

        async function startAutonomousLearning() {
            if (isLearning || isGenerating) {
                alert('‚ö†Ô∏è Already generating or learning. Please wait.');
                return;
            }

            if (!selectedTemplate) {
                alert('‚ö†Ô∏è Please select a template first');
                return;
            }

            const generations = 10;
            const confirmed = confirm(`ü§ñ AUTONOMOUS LEARNING MODE\n\nThe agent will:\n‚Ä¢ Generate ${generations} images automatically\n‚Ä¢ Test different strategies\n‚Ä¢ Learn styling patterns\n‚Ä¢ Show only successful results\n\nThis will take about 2-3 minutes.\n\nProceed?`);

            if (!confirmed) return;

            isLearning = true;
            learningResults = [];

            // Show progress UI
            document.getElementById('learningProgress').style.display = 'block';
            document.getElementById('chatSendBtn').disabled = true;
            document.getElementById('autoLearnBtn').disabled = true;

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('ü§ñ AUTONOMOUS LEARNING MODE ACTIVATED');
            console.log(`üìä Will generate ${generations} images to learn patterns`);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

            try {
                for (let i = 1; i <= generations; i++) {
                    updateLearningProgress(i, generations, 'generating');

                    console.log(`\nüîÑ [${i}/${generations}] Starting generation...`);

                    // Get current template and message
                    const template = selectedTemplate; // selectedTemplate is already the template object
                    let message = '';

                    // Build message based on template type
                    if (template.prompt === 'daily_rate_update') {
                        const marketData = await fetchMarketData();
                        message = buildDailyRateUpdatePrompt(marketData);
                    } else if (template.prompt === 'market_update') {
                        const marketData = await fetchMarketData();
                        message = buildMarketUpdatePrompt(marketData);
                    } else if (template.prompt === 'rate_trends') {
                        const marketData = await fetchMarketData();
                        message = buildRateTrendsPrompt(marketData);
                    } else if (template.prompt === 'economic_outlook') {
                        const marketData = await fetchMarketData();
                        message = buildEconomicOutlookPrompt(marketData);
                    } else {
                        message = await buildTemplatePrompt(template);
                    }

                    // Generate image (silently - don't update gallery yet)
                    const result = await generateImageSilent(message, template.name, i);

                    learningResults.push(result);

                    // Log result
                    if (result.success) {
                        console.log(`‚úÖ [${i}/${generations}] SUCCESS - ${result.errorCount} errors`);
                    } else {
                        console.log(`‚ùå [${i}/${generations}] FAILED - ${result.errorCount} errors`);
                    }
                }

                // Learning complete - analyze results
                updateLearningProgress(generations, generations, 'analyzing');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pause for effect

                analyzeLearningResults();
                displayLearningResults();

            } catch (error) {
                console.error('üî¥ Autonomous learning error:', error);
                alert(`‚ùå Learning mode error: ${error.message}`);
            } finally {
                isLearning = false;
                document.getElementById('chatSendBtn').disabled = false;
                document.getElementById('autoLearnBtn').disabled = false;
            }
        }

        function updateLearningProgress(current, total, phase = 'generating') {
            const percentage = (current / total) * 100;
            document.getElementById('learningProgressBar').style.width = percentage + '%';

            const successful = learningResults.filter(r => r.success).length;
            const failed = learningResults.filter(r => !r.success).length;

            if (phase === 'generating') {
                document.getElementById('learningStatus').textContent =
                    `ü§ñ Autonomous Learning: ${current}/${total} generations complete`;
                document.getElementById('learningDetails').textContent =
                    `‚úÖ ${successful} successful | ‚ùå ${failed} failed | ‚è≥ Testing strategies...`;
            } else if (phase === 'analyzing') {
                document.getElementById('learningStatus').textContent =
                    `üéì Learning Complete - Analyzing Results...`;
                document.getElementById('learningDetails').textContent =
                    `Generated ${total} images, analyzing patterns and displaying best results...`;
            }
        }

        // Silent generation - doesn't update gallery or UI (except progress)
        async function generateImageSilent(message, templateName, generationNumber) {
            try {
                const agentMemory = getAgentMemory();
                const selectedStrategy = selectStrategy(1, agentMemory);
                const learnedLessons = getLearnedLessons(agentMemory);

                // Build the parts array
                const parts = [];
                if (brandLogoData) {
                    parts.push({
                        inline_data: {
                            mime_type: brandLogoData.mimeType,
                            data: brandLogoData.data
                        }
                    });
                }
                if (uploadedImageData) {
                    parts.push({
                        inline_data: {
                            mime_type: uploadedImageData.mimeType,
                            data: uploadedImageData.data
                        }
                    });
                }

                // Build prompt
                let promptText = `${brandLogoData ? 'The first image provided is the LendWise Mortgages brand logo. ' : ''}${uploadedImageData && brandLogoData ? 'The second image is the loan officer photo. ' : uploadedImageData ? 'The image is the loan officer photo. ' : ''}

${message}

üé® DEFAULT BRAND COLORS:
- Background: Forest green gradient ${LENDWISE_THEME.colors.green.forest} to ${LENDWISE_THEME.colors.green.deep}
- Accent: Metallic gold ${LENDWISE_THEME.colors.gold.metallic}

ü§ñ LEARNING AGENT - STRATEGY: ${selectedStrategy}
${buildStrategyPrompt(selectedStrategy, null)}

${learnedLessons ? `üß† LEARNED PATTERNS:\n${learnedLessons}` : ''}`;

                promptText = reviewPrompt(promptText, {
                    hasLogo: brandLogoData !== null,
                    hasPhoto: uploadedImageData !== null,
                    isRefinement: false,
                    template: selectedTemplate,
                    userRequest: message
                });

                parts.push({ text: promptText });

                // TWO-PASS GENERATION
                const phase1Result = await generateDesignOnly(promptText, templateName, parts);
                const phase2Result = await addTextToDesign(
                    phase1Result.imageData,
                    phase1Result.mimeType,
                    phase1Result.bodyTextContent,
                    agentMemory
                );

                // Verify
                const verification = await verifyImageText(phase2Result.imageData);
                analyzeTextStyling(verification, agentMemory);

                const hasIssues = verification.issues && verification.issues.length > 0;
                const errorCount = verification.issues ? verification.issues.length : 0;

                // Update learning
                if (hasIssues) {
                    updateAgentLearning(agentMemory, `twoPass_${selectedStrategy}`, false, verification.issues);
                } else {
                    updateAgentLearning(agentMemory, `twoPass_${selectedStrategy}`, true);
                }

                return {
                    success: !hasIssues || errorCount < 5,
                    errorCount: errorCount,
                    imageData: phase2Result.imageData,
                    imageUrl: `data:${phase2Result.mimeType};base64,${phase2Result.imageData}`,
                    verification: verification,
                    strategy: selectedStrategy,
                    templateName: templateName,
                    generationNumber: generationNumber
                };

            } catch (error) {
                console.error(`‚ùå Silent generation ${generationNumber} error:`, error);
                return {
                    success: false,
                    errorCount: 999,
                    error: error.message,
                    generationNumber: generationNumber
                };
            }
        }

        function analyzeLearningResults() {
            console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üéì LEARNING ANALYSIS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            const successful = learningResults.filter(r => r.success);
            const failed = learningResults.filter(r => !r.success);
            const perfect = learningResults.filter(r => r.errorCount === 0);

            console.log(`\nüìä GENERATION RESULTS:`);
            console.log(`   Total: ${learningResults.length}`);
            console.log(`   ‚úÖ Successful (< 5 errors): ${successful.length} (${(successful.length / learningResults.length * 100).toFixed(1)}%)`);
            console.log(`   üèÜ Perfect (0 errors): ${perfect.length}`);
            console.log(`   ‚ùå Failed (‚â• 5 errors): ${failed.length}`);

            const agentMemory = getAgentMemory();
            if (agentMemory.stylingPatterns) {
                console.log(`\nüé® STYLING PATTERN DISCOVERIES:`);
                for (const [style, data] of Object.entries(agentMemory.stylingPatterns)) {
                    if (data.totalTextInstances > 5) {
                        console.log(`   ${style}: ${data.successRate.toFixed(1)}% accuracy`);
                    }
                }
            }

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

            // üíæ EXPORT RESULTS TO JSON (for automated retrieval)
            const exportData = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: learningResults.length,
                    successful: successful.length,
                    perfect: perfect.length,
                    failed: failed.length,
                    successRate: (successful.length / learningResults.length * 100).toFixed(1) + '%'
                },
                stylingPatterns: {},
                results: learningResults.map(r => ({
                    generationNumber: r.generationNumber,
                    success: r.success,
                    errorCount: r.errorCount,
                    strategy: r.strategy,
                    templateName: r.templateName,
                    issues: r.verification?.issues || []
                }))
            };

            // Add styling patterns
            if (agentMemory.stylingPatterns) {
                for (const [style, data] of Object.entries(agentMemory.stylingPatterns)) {
                    exportData.stylingPatterns[style] = {
                        successRate: data.successRate.toFixed(1) + '%',
                        accuracy: `${data.totalTextInstances - data.errorCount}/${data.totalTextInstances}`,
                        errorCount: data.errorCount,
                        totalInstances: data.totalTextInstances
                    };
                }
            }

            // Store in localStorage for easy retrieval
            localStorage.setItem('autonomousLearning_lastResults', JSON.stringify(exportData));
            console.log('üíæ Results exported to localStorage (key: "autonomousLearning_lastResults")');
        }

        function displayLearningResults() {
            // Sort by quality (fewest errors first)
            const sortedResults = learningResults
                .filter(r => r.success)
                .sort((a, b) => a.errorCount - b.errorCount);

            console.log(`üèÜ Displaying top ${sortedResults.length} successful images in gallery`);

            // Clear existing gallery
            imageHistory = [];

            // Add successful images to gallery
            sortedResults.forEach((result, index) => {
                imageHistory.push({
                    url: result.imageUrl,
                    data: result.imageData,
                    prompt: `${result.templateName} (Auto-Gen #${result.generationNumber}, ${result.errorCount} errors)`,
                    timestamp: Date.now() + index,
                    verification: result.verification
                });
            });

            updateImageGallery();

            // Show summary
            document.getElementById('learningStatus').textContent =
                `üéì Learning Complete! ${sortedResults.length}/${learningResults.length} successful images`;
            document.getElementById('learningDetails').textContent =
                `Best ${Math.min(5, sortedResults.length)} images displayed below. Check console for full analysis.`;

            // Auto-hide after 10 seconds
            setTimeout(() => {
                document.getElementById('learningProgress').style.display = 'none';
            }, 10000);

            // Show agent stats
            console.log('\nüìä Run showAgentStats() to see detailed learning data');
        }

        // ============================================
        // TWO-PASS GENERATION (Option 3)
        // Separates design from text to improve spelling accuracy
        // ============================================

        // Phase 1: Generate design without body text
        async function generateDesignOnly(message, templateName, parts) {
            console.log('üé® PHASE 1: Generating design-only (no body text)...');

            // Extract expected text content for Phase 2
            const textContentMatch = message.match(/Market Insight[\s\S]*?(?=\n\n(?:David|Include|Design|NOTE)|$)/);
            const bodyTextContent = textContentMatch ? textContentMatch[0] : '';

            // Build design-only prompt
            const designPrompt = `${message}

üö® CRITICAL MODIFICATION FOR THIS PHASE:
- DO NOT include the body text content ("Market Insight" paragraph)
- ONLY create the beautiful design, layout, logo integration, and headshot composition
- Leave a CLEAR, PROMINENT SPACE in the middle/lower area for text to be added in Phase 2
- Focus 100% on design quality, colors, layout, and visual appeal
- Make sure the designated text area is obvious and well-positioned

The text will be added in a separate phase with perfect spelling.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            ...parts,
                            { text: designPrompt }
                        ]
                    }],
                    generationConfig: {
                        temperature: 1.0,
                        topK: 40,
                        topP: 0.95,
                        responseModalities: ["image"]
                    }
                })
            });

            const data = await response.json();
            console.log('üì¶ PHASE 1 API Response:', data);

            if (data.candidates && data.candidates[0]) {
                const content = data.candidates[0].content;

                if (!content || !content.parts) {
                    console.error('‚ùå PHASE 1: Invalid content structure:', content);
                    throw new Error('Phase 1 failed: Invalid response structure');
                }

                const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                if (imagePart) {
                    const inlineData = imagePart.inline_data || imagePart.inlineData;
                    console.log('‚úÖ PHASE 1: Design generated successfully');
                    return {
                        imageData: inlineData.data,
                        mimeType: inlineData.mime_type || inlineData.mimeType,
                        bodyTextContent: bodyTextContent
                    };
                }
            }

            if (data.error) {
                console.error('‚ùå PHASE 1 API Error:', data.error);
                throw new Error(`Phase 1 failed: ${data.error.message || 'API error'}`);
            }

            throw new Error('Phase 1 failed: No image in response');
        }

        // Phase 2: Add text to design with maximum spelling emphasis
        async function addTextToDesign(designImageData, mimeType, bodyTextContent, agentMemory) {
            console.log('‚úçÔ∏è PHASE 2: Adding text with maximum spelling emphasis...');

            // Get learned spelling corrections
            const learnedLessons = getLearnedLessons(agentMemory);

            // Check if agent discovered gold gradient pattern
            const goldRate = agentMemory.stylingPatterns?.gold_gradient?.successRate || 0;
            const plainRate = agentMemory.stylingPatterns?.plain_white?.successRate || 0;
            const useGoldStyling = goldRate > 80 && plainRate < 30;

            if (useGoldStyling) {
                console.log(`üí° AGENT: Forcing gold gradient styling (${goldRate.toFixed(0)}% success vs ${plainRate.toFixed(0)}% for plain)`);
            }

            // Build ultra-focused text addition prompt with header-style formatting + sophisticated layout
            const textPrompt = `ADD THIS EXACT TEXT to the designated text area in this image:

${bodyTextContent}

üö® ABSOLUTE REQUIREMENTS:
1. SPELL EVERY WORD PERFECTLY - this is your ONLY job in this phase
2. The design is already perfect - DO NOT change colors, layout, logo, or headshot

3. üéØ CRITICAL TEXT FORMATTING (for 100% spelling accuracy):
   - Format ALL text as HEADER-STYLE LABELS (like "David Young", "Loan Officer", "NMLS #62043")
   - Use SHORT phrases (2-4 words)
   - NO paragraph sentences - ONLY header-style label text
   - Use "Label: Value" format (e.g., "Status: Steady | Trend: Favorable")

4. üé® LAYOUT INSTRUCTION:
   - Arrange as flowing horizontal text with | dividers (e.g., "Status: Steady | Trend: Favorable")
   - NO vertical bullet lists in boxes
   - Use elegant spacing, no borders

${learnedLessons}

üîç SPELL CHECK - Common mistakes to AVOID:
- "borrowers" NOT "bombwires", "borowers", or "borrwers"
- "remained" NOT "remaned" or "remanned"
- "unchanged" NOT "unhanged"
- "anticipate" NOT "anticpate"
- Double-check EVERY word before finalizing

‚ö†Ô∏è REMEMBER: Format like headers (David Young style), NOT like paragraphs. This is CRITICAL for accuracy.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { inline_data: { mime_type: mimeType, data: designImageData } },
                            { text: textPrompt }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.3, // Lower temperature for accuracy
                        topK: 20,
                        topP: 0.8,
                        responseModalities: ["image"]
                    }
                })
            });

            const data = await response.json();
            console.log('üì¶ PHASE 2 API Response:', data);

            if (data.candidates && data.candidates[0]) {
                const content = data.candidates[0].content;

                if (!content || !content.parts) {
                    console.error('‚ùå PHASE 2: Invalid content structure:', content);
                    throw new Error('Phase 2 failed: Invalid response structure');
                }

                const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                if (imagePart) {
                    const inlineData = imagePart.inline_data || imagePart.inlineData;
                    console.log('‚úÖ PHASE 2: Text added successfully');
                    return {
                        imageData: inlineData.data,
                        mimeType: inlineData.mime_type || inlineData.mimeType
                    };
                }
            }

            if (data.error) {
                console.error('‚ùå PHASE 2 API Error:', data.error);
                throw new Error(`Phase 2 failed: ${data.error.message || 'API error'}`);
            }

            throw new Error('Phase 2 failed: No image in response');
        }

        // ============================================
        // PHASE 3: TARGETED ERROR CORRECTION
        // Fixes specific errors without full regeneration
        // ============================================
        async function correctSpecificErrors(imageData, mimeType, issues, agentMemory, correctionAttempt = 1) {
            const maxCorrections = 3;

            if (correctionAttempt > maxCorrections) {
                console.log(`‚ö†Ô∏è PHASE 3: Max correction attempts (${maxCorrections}) reached`);
                return { imageData, mimeType, corrected: false };
            }

            console.log(`üîß PHASE 3 (Attempt ${correctionAttempt}/${maxCorrections}): Correcting ${issues.length} specific errors...`);
            console.log(`   Errors to fix: ${issues.join(', ')}`);

            // Build learned lessons string
            const learnedLessons = getLearnedLessons(agentMemory);

            // Extract the specific wrong words and what they should be
            const corrections = issues.map(issue => {
                const match = issue.match(/word '(.+?)' should be '(.+?)'/);
                if (match) {
                    return { wrong: match[1], correct: match[2] };
                }
                return null;
            }).filter(c => c !== null);

            // Build ultra-focused correction prompt
            const correctionPrompt = `üîß TEXT CORRECTION TASK - TARGETED FIX ONLY

This image has ${issues.length} spelling error(s) that need correction.

üö® DO NOT REGENERATE OR REDESIGN - ONLY FIX THE ERRORS BELOW:

ERRORS TO FIX:
${issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n')}

SPECIFIC CORRECTIONS NEEDED:
${corrections.map(c => `‚ùå Change "${c.wrong}" ‚Üí ‚úÖ "${c.correct}"`).join('\n')}

üéØ CRITICAL INSTRUCTIONS:
1. Keep 100% of the existing design, layout, colors, logo, headshot, and other text
2. ONLY modify the incorrect words listed above - nothing else
3. Maintain the same text styling (gradient, size, position) as the original
4. Make the corrections look natural and seamless
5. DO NOT change, remove, or regenerate any other elements

${learnedLessons ? `üß† SPELLING PATTERNS TO REMEMBER:\n${learnedLessons}\n` : ''}

This is correction attempt ${correctionAttempt} of ${maxCorrections}. Be precise and careful.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: mimeType, data: imageData } },
                                { text: correctionPrompt }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3, // Lower temperature for precise corrections
                            topK: 20,
                            topP: 0.8,
                            responseModalities: ["image"]
                        }
                    })
                });

                const data = await response.json();
                console.log('üì¶ PHASE 3 API Response:', data);

                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content;
                    const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                    if (imagePart) {
                        const inlineData = imagePart.inline_data || imagePart.inlineData;
                        const correctedImageData = inlineData.data;
                        const correctedMimeType = inlineData.mime_type || inlineData.mimeType;

                        console.log('‚úÖ PHASE 3: Corrections applied');

                        // Verify if corrections worked
                        const verification = await verifyImageText(correctedImageData);
                        const stillHasIssues = verification.issues && verification.issues.length > 0;

                        if (!stillHasIssues) {
                            console.log(`üéâ PHASE 3: All errors corrected successfully!`);

                            // Track correction success
                            if (!agentMemory.correctionStats) {
                                agentMemory.correctionStats = {
                                    totalAttempts: 0,
                                    successful: 0,
                                    failed: 0
                                };
                            }
                            agentMemory.correctionStats.totalAttempts++;
                            agentMemory.correctionStats.successful++;
                            saveAgentMemory(agentMemory);

                            return {
                                imageData: correctedImageData,
                                mimeType: correctedMimeType,
                                corrected: true,
                                attemptsNeeded: correctionAttempt
                            };
                        } else {
                            console.log(`‚ö†Ô∏è PHASE 3: Still ${verification.issues.length} errors remaining`);
                            console.log(`   Remaining errors: ${verification.issues.join(', ')}`);

                            // Recursive correction - try again with remaining errors
                            return await correctSpecificErrors(
                                correctedImageData,
                                correctedMimeType,
                                verification.issues,
                                agentMemory,
                                correctionAttempt + 1
                            );
                        }
                    }
                }

                throw new Error('Phase 3 correction failed: No image in response');

            } catch (error) {
                console.error('‚ùå PHASE 3 error:', error);

                // Track correction failure
                if (!agentMemory.correctionStats) {
                    agentMemory.correctionStats = {
                        totalAttempts: 0,
                        successful: 0,
                        failed: 0
                    };
                }
                agentMemory.correctionStats.totalAttempts++;
                agentMemory.correctionStats.failed++;
                saveAgentMemory(agentMemory);

                return { imageData, mimeType, corrected: false, error: error.message };
            }
        }

        // ============================================
        // FABRIC.JS TEXT OVERLAY SYSTEM
        // Renders perfect text with 100% accuracy
        // ============================================

        async function renderTextWithFabric(designImageData, textData) {
            console.log('üé® FABRIC.JS: Starting text overlay rendering...');

            return new Promise((resolve, reject) => {
                // Create canvas element
                const canvasEl = document.createElement('canvas');
                canvasEl.width = 1080;
                canvasEl.height = 1350;

                // Initialize Fabric canvas
                const fabricCanvas = new fabric.Canvas(canvasEl);

                // Load the design image
                const img = new Image();
                img.onload = () => {
                    // Add design as background
                    fabric.Image.fromURL(img.src, (fabricImg) => {
                        fabricImg.scaleToWidth(1080);
                        fabricImg.scaleToHeight(1350);
                        fabricCanvas.setBackgroundImage(fabricImg, fabricCanvas.renderAll.bind(fabricCanvas));

                        // Create gold gradient for headers
                        const goldGradient = new fabric.Gradient({
                            type: 'linear',
                            coords: { x1: 0, y1: 0, x2: 400, y2: 0 },
                            colorStops: [
                                { offset: 0, color: '#B8860B' },      // Dark gold
                                { offset: 0.5, color: '#DAA520' },    // Golden
                                { offset: 0.7, color: '#FFD700' },    // Bright gold
                                { offset: 1, color: '#FFA500' }       // Orange gold
                            ]
                        });

                        // Add header text
                        const header = new fabric.Text(textData.header || 'ECONOMIC OUTLOOK', {
                            left: 100,
                            top: 80,
                            fontSize: 48,
                            fontFamily: 'Playfair Display',
                            fontWeight: 900,
                            fill: goldGradient,
                            shadow: {
                                color: 'rgba(218, 165, 32, 0.6)',
                                blur: 25,
                                offsetX: 0,
                                offsetY: 0
                            },
                            stroke: 'rgba(0, 0, 0, 0.2)',
                            strokeWidth: 0.5
                        });
                        fabricCanvas.add(header);

                        // Track vertical position
                        let currentY = 250;

                        // Add rates section if available
                        if (textData.rates) {
                            const rate30 = new fabric.Text(`${textData.rates.rate30Year}`, {
                                left: 150,
                                top: currentY,
                                fontSize: 64,
                                fontFamily: 'Playfair Display',
                                fontWeight: 900,
                                fill: goldGradient,
                                shadow: {
                                    color: 'rgba(218, 165, 32, 0.5)',
                                    blur: 20,
                                    offsetX: 0,
                                    offsetY: 0
                                }
                            });
                            fabricCanvas.add(rate30);

                            const rate30Label = new fabric.Text('30-YEAR FIXED', {
                                left: 150,
                                top: currentY + 75,
                                fontSize: 22,
                                fontFamily: 'Open Sans',
                                fontWeight: 600,
                                fill: '#FFFFFF',
                                letterSpacing: 100
                            });
                            fabricCanvas.add(rate30Label);
                            currentY += 180;

                            // Additional rates
                            const ratesText = `${textData.rates.rate15Year}  15-YEAR FIXED\n${textData.rates.rateARM}  5/1 ARM`;
                            const additionalRates = new fabric.Text(ratesText, {
                                left: 150,
                                top: currentY,
                                fontSize: 28,
                                fontFamily: 'Open Sans',
                                fontWeight: 600,
                                fill: goldGradient,
                                lineHeight: 1.5
                            });
                            fabricCanvas.add(additionalRates);
                            currentY += 140;
                        }

                        // Add bullet points if available
                        if (textData.bullets && textData.bullets.length > 0) {
                            const bulletsText = textData.bullets.join('\n');
                            const bullets = new fabric.Text(bulletsText, {
                                left: 150,
                                top: currentY,
                                fontSize: 18,
                                fontFamily: 'Open Sans',
                                fontWeight: 600,
                                fill: '#FFFFFF',
                                lineHeight: 1.8,
                                shadow: {
                                    color: 'rgba(0, 0, 0, 0.3)',
                                    blur: 5,
                                    offsetX: 0,
                                    offsetY: 2
                                }
                            });
                            fabricCanvas.add(bullets);
                            currentY += (textData.bullets.length * 40) + 50;
                        }

                        // Add body text sections if available
                        if (textData.body) {
                            const bodyText = new fabric.Text(textData.body, {
                                left: 150,
                                top: currentY,
                                fontSize: 18,
                                fontFamily: 'Open Sans',
                                fontWeight: 400,
                                fill: '#FFFFFF',
                                shadow: {
                                    color: 'rgba(0, 0, 0, 0.3)',
                                    blur: 8,
                                    offsetX: 0,
                                    offsetY: 2
                                },
                                lineHeight: 1.6,
                                width: 800
                            });
                            fabricCanvas.add(bodyText);
                        }

                        // Add footer with name
                        const footerName = new fabric.Text(textData.name || 'DAVID YOUNG', {
                            left: 150,
                            top: 1150,
                            fontSize: 32,
                            fontFamily: 'Playfair Display',
                            fontWeight: 700,
                            fill: goldGradient,
                            shadow: {
                                color: 'rgba(218, 165, 32, 0.4)',
                                blur: 15,
                                offsetX: 0,
                                offsetY: 0
                            }
                        });
                        fabricCanvas.add(footerName);

                        // Add NMLS and contact info
                        const contact = new fabric.Text(
                            `NMLS #${textData.nmls || '62043'}  |  Phone: ${textData.phone || '310-954-7771'}`,
                            {
                                left: 150,
                                top: 1195,
                                fontSize: 16,
                                fontFamily: 'Open Sans',
                                fontWeight: 400,
                                fill: '#FFFFFF',
                                shadow: {
                                    color: 'rgba(0, 0, 0, 0.2)',
                                    blur: 5,
                                    offsetX: 0,
                                    offsetY: 1
                                }
                            }
                        );
                        fabricCanvas.add(contact);

                        // Render and export
                        fabricCanvas.renderAll();

                        // Convert to base64
                        const dataURL = canvasEl.toDataURL('image/png');
                        const base64Data = dataURL.split(',')[1];

                        console.log('‚úÖ FABRIC.JS: Text overlay rendering complete');

                        resolve({
                            imageData: base64Data,
                            mimeType: 'image/png',
                            method: 'fabric.js'
                        });
                    });
                };

                img.onerror = (error) => {
                    console.error('‚ùå FABRIC.JS: Error loading image:', error);
                    reject(error);
                };

                img.src = `data:image/png;base64,${designImageData}`;
            });
        }

        /**
         * HYBRID APPROACH: Extract detailed text styling from Gemini image
         * This allows us to recreate Gemini's beautiful text with correct spelling
         */
        async function extractTextStyling(imageBase64) {
            console.log('üé® HYBRID: Extracting detailed text styling from Gemini image...');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: imageBase64 } },
                                { text: `Analyze EVERY piece of text in this image with EXTREME detail for styling recreation.

For EACH text element, provide:
1. **Exact text content** (word-for-word)
2. **Position** - Pixel coordinates if possible, or % from edges (top/left)
3. **Size** - Actual font size in pixels (estimate)
4. **Color** - Exact hex color or RGB
5. **Effects** - List ALL: gradient (colors), shadow (color, blur, offset), glow, outline, stroke
6. **Font** - Font family (serif/sans-serif, bold/regular)
7. **Bounding box** - Approximate x, y, width, height in pixels or % of 1080x1350 image

Be EXTREMELY precise about styling - we need to recreate this EXACTLY.

Respond ONLY with valid JSON:
{
  "imageSize": {"width": 1080, "height": 1350},
  "textElements": [
    {
      "content": "ECONOMIC OUTLOOK",
      "position": {"x": 100, "y": 80, "xPercent": 9.3, "yPercent": 5.9},
      "boundingBox": {"x": 100, "y": 80, "width": 880, "height": 60},
      "fontSize": 48,
      "fontFamily": "serif",
      "fontWeight": "900",
      "color": "#DAA520",
      "effects": {
        "gradient": {
          "type": "linear",
          "colors": ["#B8860B", "#DAA520", "#FFD700", "#FFA500"],
          "angle": 0
        },
        "shadow": {
          "color": "rgba(218, 165, 32, 0.6)",
          "blur": 25,
          "offsetX": 0,
          "offsetY": 0
        },
        "stroke": {
          "color": "rgba(0, 0, 0, 0.2)",
          "width": 0.5
        }
      },
      "type": "header"
    }
  ]
}` }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    const styling = JSON.parse(text.replace(/```json|```/g, '').trim());
                    console.log(`üé® HYBRID: Extracted styling for ${styling.textElements.length} text elements`);
                    return styling;
                }
            } catch (error) {
                console.error('‚ùå HYBRID: Style extraction failed:', error);
                throw error;
            }
        }

        /**
         * HYBRID APPROACH: Recreate text on Canvas using extracted Gemini styling
         */
        async function recreateTextWithStyling(baseImageData, textElements, correctText) {
            console.log('üé® HYBRID: Recreating text with correct spelling using Gemini styling...');

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // Create canvas
                    const canvasEl = document.createElement('canvas');
                    canvasEl.width = 1080;
                    canvasEl.height = 1350;
                    const fabricCanvas = new fabric.Canvas(canvasEl);

                    // Add base image
                    fabric.Image.fromURL(`data:image/png;base64,${baseImageData}`, (fabricImg) => {
                        fabricImg.scaleToWidth(1080);
                        fabricImg.scaleToHeight(1350);
                        fabricCanvas.setBackgroundImage(fabricImg, fabricCanvas.renderAll.bind(fabricCanvas));

                        // Recreate each text element with Gemini's styling
                        textElements.forEach(element => {
                            // Create gradient if specified
                            let fillStyle = element.color;
                            if (element.effects && element.effects.gradient) {
                                const grad = element.effects.gradient;
                                const gradient = new fabric.Gradient({
                                    type: grad.type || 'linear',
                                    coords: {
                                        x1: 0, y1: 0,
                                        x2: element.boundingBox.width, y2: 0
                                    },
                                    colorStops: grad.colors.map((color, i) => ({
                                        offset: i / (grad.colors.length - 1),
                                        color: color
                                    }))
                                });
                                fillStyle = gradient;
                            }

                            // Create shadow if specified
                            let shadow = null;
                            if (element.effects && element.effects.shadow) {
                                const s = element.effects.shadow;
                                shadow = {
                                    color: s.color,
                                    blur: s.blur,
                                    offsetX: s.offsetX || 0,
                                    offsetY: s.offsetY || 0
                                };
                            }

                            // Get correct text content (replace misspellings)
                            let textContent = element.content;
                            if (correctText[element.content]) {
                                textContent = correctText[element.content];
                                console.log(`  ‚úèÔ∏è Correcting: "${element.content}" ‚Üí "${textContent}"`);
                            }

                            // Create text with extracted styling
                            const textObj = new fabric.Text(textContent, {
                                left: element.position.x,
                                top: element.position.y,
                                fontSize: element.fontSize,
                                fontFamily: element.fontFamily === 'serif' ? 'Playfair Display' : 'Open Sans',
                                fontWeight: element.fontWeight,
                                fill: fillStyle,
                                shadow: shadow
                            });

                            // Add stroke if specified
                            if (element.effects && element.effects.stroke) {
                                textObj.stroke = element.effects.stroke.color;
                                textObj.strokeWidth = element.effects.stroke.width;
                            }

                            fabricCanvas.add(textObj);
                        });

                        // Render and export
                        fabricCanvas.renderAll();
                        const dataURL = canvasEl.toDataURL('image/png');
                        const base64Data = dataURL.split(',')[1];

                        console.log('‚úÖ HYBRID: Text recreation complete');
                        resolve(base64Data);
                    });
                };

                img.onerror = reject;
                img.src = `data:image/png;base64,${baseImageData}`;
            });
        }

        /**
         * üé® PROACTIVE HYBRID MODE: Vision-Driven Typography
         * Step 1: Gemini generates background only (NO TEXT)
         * Step 2: Vision AI analyzes background and recommends perfect fonts
         * Step 3: Canvas overlays 100% accurate text with recommended styling
         */
        async function generateWithVisionTypography(promptText, textContent) {
            console.log('üé® VISION-DRIVEN TYPOGRAPHY: Starting proactive hybrid generation...');

            try {
                // STEP 1: Generate background only (no text)
                console.log('üé® STEP 1: Generating background with Gemini (NO TEXT)...');

                // Extract only the visual/design elements from the prompt, not the data
                const backgroundPrompt = `Create an ELEGANT, SOPHISTICATED mortgage market insights background - think high-end financial magazine aesthetic.

üé® VISUAL DESIGN (1080x1350 Instagram portrait format):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ú® OVERALL AESTHETIC:
‚Ä¢ Forbes, Fortune, Bloomberg Businessweek - premium financial publication style
‚Ä¢ Elegant, clean, sophisticated - high-end financial advisory feel
‚Ä¢ Professional confidence and trust
‚Ä¢ Magazine quality, not spreadsheet quality

üé® COLOR PALETTE:
‚Ä¢ Background: Rich GRADIENT forest green from #1B4D3E to #2D5F4F
  - Smooth, dimensional gradient with depth and lighting effects
  - Luxurious, rich forest green that commands attention
  - Add subtle shine and dimensional effects

‚Ä¢ Gold Accents: METALLIC, HYPER-REALISTIC gold that looks 3D and reflective
  - Metallic base: #B8860B with bright highlights #FFD700
  - Bronze shadows for depth: #8B6914
  - Add reflections, shine, and dimension - like REAL polished gold
  - Think: Luxury watch, gold jewelry - reflective, catches light
  - Use gradients within gold elements for metallic shine

üìê LAYOUT STRUCTURE (Create zones for text placement later):

[TOP SECTION - 30%] (Y: 0-400px)
‚Ä¢ Top-left corner: Space for small logo (100x100px area at 50,50)
‚Ä¢ Rest: Clean gradient with subtle geometric patterns
‚Ä¢ Light gold accent lines or shapes (5-10% opacity)

[MIDDLE SECTION - 40%] (Y: 400-950px)
‚Ä¢ Main content area with strongest visual interest
‚Ä¢ Elegant diagonal elements or flowing shapes
‚Ä¢ Soft gold glow effects
‚Ä¢ Professional depth with subtle shadows
‚Ä¢ Clear, uncluttered space for key information

[BOTTOM SECTION - 30%] (Y: 950-1350px)
‚Ä¢ Elegant footer zone with refined aesthetic
‚Ä¢ Thin gold divider line at top
‚Ä¢ Subtle geometric patterns or gold accents
‚Ä¢ Professional, polished completion

‚ú® VISUAL ENHANCEMENTS:
‚Ä¢ Subtle geometric patterns in background (5-10% opacity triangles/hexagons in gold)
‚Ä¢ Soft gold glow effects and gradient overlays
‚Ä¢ Professional drop shadows (very subtle, not harsh)
‚Ä¢ Use LOTS of whitespace and breathing room
‚Ä¢ Thin accent lines in gold to create visual sections
‚Ä¢ Sophisticated depth with layered gradients

üö® CRITICAL: Generate ONLY the background design - ABSOLUTELY NO TEXT, NUMBERS, LETTERS, OR WORDS.
- Create the visual style, colors, gradients, and structured layout zones
- DO NOT include any text, rates, labels, titles, or written content
- This will be a base for perfect programmatic text overlay later
- Focus on beautiful, structured design with clear zones for content placement
- Think: Magazine cover background before the text is added`;


                const bgResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: backgroundPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            responseModalities: ["image"]
                        }
                    })
                });

                const bgData = await bgResponse.json();
                console.log('üì¶ VISION MODE PHASE 1 API Response:', bgData);

                // Handle both inline_data and inlineData formats
                const imagePart = bgData.candidates?.[0]?.content?.parts?.find(p => p.inline_data || p.inlineData);
                const backgroundImage = imagePart ? (imagePart.inline_data?.data || imagePart.inlineData?.data) : null;

                if (!backgroundImage) {
                    console.error('‚ùå No background image in response:', bgData);
                    if (bgData.error) {
                        throw new Error(`API Error: ${bgData.error.message || JSON.stringify(bgData.error)}`);
                    }
                    throw new Error('Failed to generate background - no image in response');
                }

                console.log('‚úÖ STEP 1 COMPLETE: Background generated');

                // STEP 2: Analyze background with Vision AI
                console.log('üëÅÔ∏è STEP 2: Analyzing background for typography recommendations...');

                const analysisResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'image/png', data: backgroundImage } },
                                { text: `Analyze this background image for typography and layout design.

IMAGE SPECS: 1080px wide x 1350px tall (Instagram portrait format)

CRITICAL: Provide SPECIFIC PIXEL COORDINATES for text placement.

Your Analysis Tasks:
1. Identify where existing elements are (logo, headshot, design features)
2. Find safe zones where text will be clearly readable
3. Recommend typography that matches the background
4. Provide exact pixel coordinates for text placement

Respond ONLY with valid JSON (no markdown, no explanation):
{
  "backgroundAnalysis": {
    "primaryColors": ["#color1", "#color2"],
    "mood": "professional|luxury|modern|elegant",
    "complexity": "simple|moderate|busy"
  },
  "avoidZones": [
    {"type": "logo", "x": 50, "y": 50, "width": 200, "height": 150, "reason": "brand logo present"},
    {"type": "headshot", "x": 800, "y": 300, "width": 250, "height": 350, "reason": "person photo"}
  ],
  "textZones": [
    {
      "section": "header",
      "x": 540,
      "y": 150,
      "width": 900,
      "height": 150,
      "align": "center",
      "priority": 1,
      "reason": "clear space at top center"
    },
    {
      "section": "body",
      "x": 100,
      "y": 600,
      "width": 880,
      "height": 500,
      "align": "left",
      "priority": 2,
      "reason": "main content area with good contrast"
    },
    {
      "section": "footer",
      "x": 540,
      "y": 1200,
      "width": 900,
      "height": 100,
      "align": "center",
      "priority": 3,
      "reason": "contact info at bottom"
    }
  ],
  "typography": {
    "heading": {
      "fontFamily": "Playfair Display",
      "fontWeight": "700",
      "fontSize": 64,
      "color": "#DAA520",
      "shadow": "0 4px 12px rgba(0,0,0,0.6)",
      "textAlign": "center"
    },
    "subheading": {
      "fontFamily": "Open Sans",
      "fontWeight": "600",
      "fontSize": 36,
      "color": "#FFD700",
      "shadow": "0 2px 8px rgba(0,0,0,0.5)",
      "textAlign": "center"
    },
    "body": {
      "fontFamily": "Open Sans",
      "fontWeight": "400",
      "fontSize": 24,
      "color": "#FFFFFF",
      "shadow": "0 2px 6px rgba(0,0,0,0.7)",
      "textAlign": "left"
    }
  },
  "reasoning": "Brief explanation of layout recommendations"
}` }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.4
                        }
                    })
                });

                const analysisData = await analysisResponse.json();
                console.log('üì¶ VISION MODE PHASE 2 API Response:', analysisData);

                if (analysisData.error) {
                    throw new Error(`Vision analysis failed: ${analysisData.error.message || JSON.stringify(analysisData.error)}`);
                }

                const analysisText = analysisData.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!analysisText) {
                    throw new Error('No analysis text in response');
                }

                const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    console.error('‚ùå Could not extract JSON from analysis:', analysisText);
                    throw new Error('Failed to parse typography recommendations');
                }

                const recommendations = JSON.parse(jsonMatch[0]);
                console.log('‚úÖ STEP 2 COMPLETE: Typography recommendations received');
                console.log('üìä Recommendations:', recommendations);

                // STEP 3: Overlay perfect text using Canvas with spatial awareness
                console.log('‚úçÔ∏è STEP 3: Overlaying perfect text with recommended typography and spatial coordinates...');

                const finalImage = await overlayTextOnBackground(backgroundImage, textContent, recommendations);

                console.log('‚úÖ STEP 3 COMPLETE: Final image created with 100% accurate text');

                return {
                    image: finalImage,
                    background: backgroundImage,
                    recommendations: recommendations
                };

            } catch (error) {
                console.error('‚ùå VISION-DRIVEN TYPOGRAPHY ERROR:', error);
                throw error;
            }
        }

        /**
         * Wrapper function to integrate Vision Mode with existing template system
         */
        async function generateImageWithVisionMode(promptText, templateName) {
            console.log('üé® VISION MODE: Starting generation for', templateName);

            try {
                // Extract text content from prompt (simplified - you may want to enhance this)
                // For Economic Outlook and similar templates, extract the key text elements
                const textContent = extractTextFromPrompt(promptText, templateName);

                // Call the vision typography generator
                const result = await generateWithVisionTypography(promptText, textContent);

                // Add to image history
                const imageUrl = `data:image/png;base64,${result.image}`;
                imageHistory.push({
                    url: imageUrl,
                    data: result.image,
                    prompt: templateName,
                    timestamp: Date.now(),
                    method: 'Vision Typography Mode',
                    background: result.background,
                    recommendations: result.recommendations
                });

                updateImageGallery();
                console.log('‚úÖ VISION MODE: Generation complete');

            } catch (error) {
                console.error('‚ùå VISION MODE ERROR:', error);
                document.getElementById('emptyMessage').innerHTML = `<div style="color: #dc3545;">‚ùå Vision Mode Error: ${error.message}</div>`;
            } finally {
                // Ensure cleanup happens
                isGenerating = false;
                document.getElementById('chatSendBtn').disabled = false;
            }
        }

        /**
         * Extract text content from template prompt
         * This is a simplified version - can be enhanced based on your template structure
         */
        function extractTextFromPrompt(promptText, templateName) {
            // For Economic Outlook template (example)
            if (templateName.includes('Economic') || templateName.includes('Outlook')) {
                return `ECONOMIC OUTLOOK

FORECASTED RATES
6.75% - 30-YEAR FIXED APR
7.12% - 15-YEAR FIXED APR

MARKET INDICATORS
BORROWER DEMAND: STRONG
COMPETITIVE CLIMATE: HIGH
INVESTMENT OUTLOOK: FAVORABLE
REFINANCE OPPORTUNITY: AVAILABLE

HOUSING MARKET
HOME VALUES: APPRECIATING
INFLATION: MODERATING
INVENTORY: UNCHANGED

DAVID YOUNG - NMLS #62043
PHONE: 310-954-7771
LENDWISE MORTGAGES`;
            }

            // For other templates, return a simplified version
            // You can expand this based on your template types
            return promptText.substring(0, 500); // Fallback
        }

        /**
         * üíé ADVANCED TEXT RENDERING with Fabric.js 6.0
         * Creates stunning metallic gold text with 3D effects matching Gemini 2.5 quality
         */
        async function overlayTextOnBackground(backgroundBase64, textContent, recommendations) {
            // Check if Fabric.js is loaded
            if (typeof fabric === 'undefined') {
                console.error('‚ùå Fabric.js is not loaded!');
                // Fallback: return the background without overlay
                return backgroundBase64;
            }

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // Create Fabric canvas
                    const fabricCanvas = new fabric.Canvas(null, {
                        width: 1080,
                        height: 1350,
                        backgroundColor: null
                    });

                    // Set background image
                    fabric.Image.fromURL(`data:image/png;base64,${backgroundBase64}`, (bgImg) => {
                        bgImg.set({
                            scaleX: 1080 / bgImg.width,
                            scaleY: 1350 / bgImg.height,
                            selectable: false
                        });
                        fabricCanvas.setBackgroundImage(bgImg, fabricCanvas.renderAll.bind(fabricCanvas));

                        // Extract typography and zones from recommendations
                        const typography = recommendations.typography || {};
                        const textZones = recommendations.textZones || [];
                        const avoidZones = recommendations.avoidZones || [];

                        console.log('üìç Text Zones:', textZones);
                        console.log('üö´ Avoid Zones:', avoidZones);

                        // Parse text content into logical sections
                        const lines = textContent.split('\n').filter(l => l.trim());

                        // Categorize lines by content type
                        const sections = {
                            header: [],
                            body: [],
                            footer: []
                        };

                        lines.forEach((line, index) => {
                            if (index === 0 || (line.toUpperCase() === line && line.length < 30)) {
                                sections.header.push(line);
                            } else if (index >= lines.length - 2) {
                                sections.footer.push(line);
                            } else {
                                sections.body.push(line);
                            }
                        });

                        // Function to check if position overlaps with avoid zones
                        const isOverlapping = (x, y, width, height) => {
                            return avoidZones.some(zone => {
                                return !(x + width < zone.x || x > zone.x + zone.width ||
                                        y + height < zone.y || y > zone.y + zone.height);
                            });
                        };

                        // Function to find safe Y position in zone
                        const findSafeYPosition = (zone, textHeight) => {
                            let testY = zone.y;
                            const maxY = zone.y + zone.height - textHeight;
                            const step = 20;

                            while (testY <= maxY) {
                                if (!isOverlapping(zone.x, testY, zone.width, textHeight)) {
                                    return testY;
                                }
                                testY += step;
                            }
                            return zone.y; // Fallback to zone start
                        };

                        // Render text for each section
                        const renderSection = (sectionLines, sectionName) => {
                            // Find zone for this section (prioritized by section name match)
                            let zone = textZones.find(z => z.section === sectionName);

                            // Fallback zones if specific section not found
                            if (!zone && textZones.length > 0) {
                                if (sectionName === 'header') {
                                    zone = textZones.find(z => z.y < 400) || textZones[0];
                                } else if (sectionName === 'footer') {
                                    zone = textZones.find(z => z.y > 950) || textZones[textZones.length - 1];
                                } else {
                                    zone = textZones.find(z => z.y >= 400 && z.y <= 950) || textZones[Math.floor(textZones.length / 2)];
                                }
                            }

                            // Ultimate fallback - safe default zones
                            if (!zone) {
                                console.warn(`‚ö†Ô∏è No zone found for ${sectionName}, using safe defaults`);
                                if (sectionName === 'header') {
                                    zone = { x: 540, y: 400, width: 900, height: 200, align: 'center' };
                                } else if (sectionName === 'footer') {
                                    zone = { x: 540, y: 1150, width: 900, height: 150, align: 'center' };
                                } else {
                                    zone = { x: 540, y: 600, width: 900, height: 400, align: 'center' };
                                }
                            }

                            console.log(`üìç Rendering ${sectionName} in zone:`, zone);

                            let currentY = zone.y;

                            sectionLines.forEach((line, index) => {
                                if (!line.trim()) return;

                                // Determine text style
                                let style;
                                if (sectionName === 'header' || (line.toUpperCase() === line && line.length < 30)) {
                                    style = typography.heading || { fontSize: 48, fontWeight: 700, textAlign: 'center' };
                                } else if (line.includes('%') || line.includes(':')) {
                                    style = typography.subheading || { fontSize: 32, fontWeight: 600, textAlign: 'center' };
                                } else {
                                    style = typography.body || { fontSize: 24, fontWeight: 400, textAlign: 'center' };
                                }

                                // Check if we need to adjust Y position to avoid overlaps
                                const textHeight = style.fontSize * 1.5;
                                const safeY = findSafeYPosition(zone, textHeight);

                                // Use zone-based X position with alignment
                                let textX;
                                const align = zone.align || style.textAlign || 'center';
                                if (align === 'center') {
                                    textX = zone.x || 540;
                                } else if (align === 'right') {
                                    textX = (zone.x || 0) + (zone.width || 1080) - 100;
                                } else {
                                    textX = zone.x || 100;
                                }

                                // Create METALLIC GOLD GRADIENT
                                const goldGradient = new fabric.Gradient({
                                    type: 'linear',
                                    coords: {
                                        x1: 0,
                                        y1: 0,
                                        x2: 0,
                                        y2: style.fontSize
                                    },
                                    colorStops: [
                                        { offset: 0, color: '#B8860B' },      // Dark gold
                                        { offset: 0.25, color: '#DAA520' },   // Goldenrod
                                        { offset: 0.5, color: '#FFD700' },    // Bright gold
                                        { offset: 0.75, color: '#FFA500' },   // Orange gold
                                        { offset: 1, color: '#B8860B' }       // Dark gold (bottom)
                                    ]
                                });

                                // Create text object with ADVANCED EFFECTS using zone positioning
                                const text = new fabric.Text(line, {
                                    left: textX,
                                    top: currentY,
                                    fontSize: style.fontSize,
                                    fontFamily: style.fontFamily || 'Playfair Display',
                                    fontWeight: style.fontWeight || 700,
                                    fill: goldGradient,
                                    textAlign: align,
                                    originX: align,
                                    originY: 'top',
                                    selectable: false,
                                    // 3D EMBOSS EFFECT - Multiple shadows
                                    shadow: new fabric.Shadow({
                                        color: 'rgba(0, 0, 0, 0.8)',
                                        blur: 25,
                                        offsetX: 0,
                                        offsetY: 6
                                    }),
                                    // Text stroke for definition
                                    stroke: 'rgba(0, 0, 0, 0.3)',
                                    strokeWidth: 1,
                                    strokeLineJoin: 'round'
                                });

                                fabricCanvas.add(text);

                                // Add GLOW LAYER (second text behind with blur)
                                const glowText = new fabric.Text(line, {
                                    left: text.left,
                                    top: text.top,
                                    fontSize: style.fontSize,
                                    fontFamily: style.fontFamily || 'Playfair Display',
                                    fontWeight: style.fontWeight || 700,
                                    fill: '#FFD700',
                                    textAlign: align,
                                    originX: align,
                                    originY: 'top',
                                    selectable: false,
                                    opacity: 0.4,
                                    shadow: new fabric.Shadow({
                                        color: 'rgba(255, 215, 0, 0.8)',
                                        blur: 40,
                                        offsetX: 0,
                                        offsetY: 0
                                    })
                                });

                                fabricCanvas.insertAt(glowText, fabricCanvas.getObjects().length - 1);

                                // Add HIGHLIGHT LAYER (subtle white highlight on top edge)
                                const highlightText = new fabric.Text(line, {
                                    left: text.left,
                                    top: text.top - 2,
                                    fontSize: style.fontSize,
                                    fontFamily: style.fontFamily || 'Playfair Display',
                                    fontWeight: style.fontWeight || 700,
                                    fill: 'rgba(255, 255, 255, 0.3)',
                                    textAlign: align,
                                    originX: align,
                                    originY: 'top',
                                    selectable: false,
                                    opacity: 0.6
                                });

                                fabricCanvas.add(highlightText);

                                // Increment Y for next line within zone boundaries
                                currentY += textHeight;

                                // Check if we're approaching zone boundary
                                if (currentY + textHeight > zone.y + zone.height) {
                                    console.warn(`‚ö†Ô∏è Zone ${sectionName} running out of space`);
                                }
                            });
                        };

                        // Render all sections
                        renderSection(sections.header, 'header');
                        renderSection(sections.body, 'body');
                        renderSection(sections.footer, 'footer');

                        // Render and export
                        fabricCanvas.renderAll();

                        // Convert to base64
                        const dataURL = fabricCanvas.toDataURL({
                            format: 'png',
                            quality: 1.0,
                            multiplier: 1
                        });
                        const base64Data = dataURL.split(',')[1];

                        resolve(base64Data);
                    });
                };

                img.onerror = reject;
                img.src = `data:image/png;base64,${backgroundBase64}`;
            });
        }

        /**
         * üì¶ GROUP TEXT BLOCKS INTO SECTIONS
         * Groups related error text blocks into logical sections for elegant bubble overlays
         *
         * @param {Array} textBlocks - All text blocks from Vision AI
         * @returns {Array} - Sections with grouped blocks and combined bounding boxes
         */
        function groupTextBlocksIntoSections(textBlocks) {
            console.log('üì¶ Grouping text blocks into sections...');

            // Filter only blocks with errors
            const errorBlocks = textBlocks.filter(block => block.hasErrors);

            if (errorBlocks.length === 0) {
                return [];
            }

            // Sort blocks by Y position (top to bottom)
            errorBlocks.sort((a, b) => a.boundingBox.y - b.boundingBox.y);

            const sections = [];
            let currentSection = null;

            errorBlocks.forEach(block => {
                const bbox = block.boundingBox;

                // Check if this block should join the current section
                // Criteria: Within 100px vertically and similar X positioning
                if (currentSection) {
                    const lastBlock = currentSection.blocks[currentSection.blocks.length - 1];
                    const verticalGap = bbox.y - (lastBlock.boundingBox.y + lastBlock.boundingBox.height);
                    const horizontalOverlap = Math.abs(bbox.x - lastBlock.boundingBox.x) < 200;

                    // If close vertically and horizontally aligned, add to current section
                    if (verticalGap < 100 && horizontalOverlap) {
                        currentSection.blocks.push(block);

                        // Expand section bounding box to encompass this block
                        const sectionBox = currentSection.boundingBox;
                        sectionBox.width = Math.max(
                            sectionBox.width,
                            bbox.x + bbox.width - sectionBox.x
                        );
                        sectionBox.height = (bbox.y + bbox.height) - sectionBox.y;
                    } else {
                        // Start new section
                        sections.push(currentSection);
                        currentSection = {
                            blocks: [block],
                            boundingBox: {
                                x: bbox.x,
                                y: bbox.y,
                                width: bbox.width,
                                height: bbox.height
                            }
                        };
                    }
                } else {
                    // Start first section
                    currentSection = {
                        blocks: [block],
                        boundingBox: {
                            x: bbox.x,
                            y: bbox.y,
                            width: bbox.width,
                            height: bbox.height
                        }
                    };
                }
            });

            // Add final section
            if (currentSection) {
                sections.push(currentSection);
            }

            console.log(`üì¶ Grouped ${errorBlocks.length} error blocks into ${sections.length} sections`);
            sections.forEach((section, i) => {
                console.log(`   Section ${i + 1}: ${section.blocks.length} blocks, bbox(${section.boundingBox.x}, ${section.boundingBox.y}, ${section.boundingBox.width}x${section.boundingBox.height})`);
            });

            return sections;
        }

        /**
         * üîß SURGICAL TEXT REPLACEMENT with Gradient Bubble Overlays
         * Creates elegant gradient bubbles over error sections while preserving Gemini's design
         *
         * @param {string} imageBase64 - Original Gemini-generated image (base64)
         * @param {object} verificationResult - Result from verifyImageText() with textBlocks
         * @returns {Promise<string>} - Corrected image (base64)
         */
        async function surgicallyReplaceTextBlocks(imageBase64, verificationResult) {
            console.log('üîß SURGICAL REPLACEMENT: Starting text correction...');

            // Check if Fabric.js is loaded
            if (typeof fabric === 'undefined') {
                console.error('‚ùå Fabric.js is not loaded! Cannot perform surgical replacement.');
                return imageBase64;
            }

            // If no errors, return original
            if (verificationResult.valid || !verificationResult.textBlocks) {
                console.log('‚úÖ No errors detected - returning original image');
                return imageBase64;
            }

            // Group error blocks into sections
            const sections = groupTextBlocksIntoSections(verificationResult.textBlocks);

            if (sections.length === 0) {
                console.log('‚úÖ No text blocks need replacement');
                return imageBase64;
            }

            console.log(`üîß Found ${sections.length} sections with errors to overlay`);

            return new Promise((resolve, reject) => {
                const img = new Image();

                img.onload = () => {
                    try {
                        // Get actual image dimensions from verification result
                        const actualWidth = verificationResult.imageSize?.width || img.width || 1080;
                        const actualHeight = verificationResult.imageSize?.height || img.height || 1350;

                        console.log(`üé® Creating canvas with actual image dimensions: ${actualWidth}x${actualHeight}`);

                        // Create Fabric canvas with ACTUAL image dimensions (not hardcoded)
                        const canvas = new fabric.Canvas(null, {
                            width: actualWidth,
                            height: actualHeight,
                            backgroundColor: null
                        });

                        // Load original image as background (NO SCALING - use original size)
                        fabric.Image.fromURL(`data:image/png;base64,${imageBase64}`, (bgImg) => {
                            bgImg.set({
                                scaleX: 1,  // No scaling - use original dimensions
                                scaleY: 1,  // No scaling - use original dimensions
                                selectable: false
                            });
                            canvas.setBackgroundImage(bgImg, canvas.renderAll.bind(canvas));

                            // Process each SECTION (not individual blocks)
                            sections.forEach((section, sectionIndex) => {
                                console.log(`üîß Creating gradient bubble overlay for section ${sectionIndex + 1}/${sections.length} (${section.blocks.length} blocks)`);

                                const bbox = section.boundingBox;

                                // Add padding for breathing room
                                const paddingH = 20; // Horizontal padding
                                const paddingV = 15; // Vertical padding

                                // STEP 1: Create sophisticated gradient bubble overlay matching Gemini's design
                                const bubbleWidth = bbox.width + (paddingH * 2);
                                const bubbleHeight = bbox.height + (paddingV * 2);

                                // Get background color from first block's styling (Vision AI detected)
                                const firstBlock = section.blocks[0];
                                const bgColor = firstBlock.styling.backgroundColor || 'rgba(25, 60, 50, 0.95)';

                                // Create bubble overlay that matches background
                                let bubbleFill;

                                // Check if text has gold gradient (metallic gold = needs matching gold bubble)
                                const hasGoldGradient = firstBlock.styling.color.type === 'gradient' &&
                                    firstBlock.styling.color.stops?.some(stop =>
                                        stop.color.toLowerCase().includes('ffd700') ||
                                        stop.color.toLowerCase().includes('b8860b')
                                    );

                                if (hasGoldGradient) {
                                    // üé® MATCH GEMINI'S GOLD GRADIENT: Metallic gold bubble for gold text
                                    console.log(`   ‚ú® Creating GOLD gradient bubble to match metallic gold text`);
                                    bubbleFill = new fabric.Gradient({
                                        type: 'linear',
                                        coords: {
                                            x1: 0,
                                            y1: 0,
                                            x2: 0,
                                            y2: bubbleHeight
                                        },
                                        colorStops: [
                                            { offset: 0, color: 'rgba(184, 134, 11, 0.95)' },    // Dark gold top
                                            { offset: 0.5, color: 'rgba(255, 215, 0, 0.95)' },   // Bright gold middle
                                            { offset: 1, color: 'rgba(184, 134, 11, 0.95)' }     // Dark gold bottom
                                        ]
                                    });
                                } else {
                                    // üå≤ Standard design: Use background color from Vision AI
                                    console.log(`   üé® Creating bubble with background color: ${bgColor}`);
                                    bubbleFill = bgColor;
                                }

                                const gradientBubble = new fabric.Rect({
                                    left: bbox.x - paddingH,
                                    top: bbox.y - paddingV,
                                    width: bubbleWidth,
                                    height: bubbleHeight,
                                    fill: bubbleFill,
                                    rx: 12,  // Rounded corners
                                    ry: 12,
                                    stroke: hasGoldGradient ? 'rgba(255, 215, 0, 0.5)' : 'rgba(184, 134, 11, 0.35)',  // Gold border for gold text
                                    strokeWidth: 2,
                                    shadow: new fabric.Shadow({
                                        color: 'rgba(0, 0, 0, 0.5)',
                                        blur: 20,
                                        offsetX: 0,
                                        offsetY: 6
                                    }),
                                    selectable: false
                                });
                                canvas.add(gradientBubble);

                                // STEP 2: Overlay corrected text for ALL blocks in this section
                                section.blocks.forEach((block, blockIndex) => {
                                    console.log(`   üìù Adding corrected text ${blockIndex + 1}/${section.blocks.length}: "${block.correctedContent}"`);

                                    const blockBbox = block.boundingBox;
                                    const style = block.styling;

                                    // Create text fill (gradient or solid)
                                    let textFill;
                                    if (style.color.type === 'gradient') {
                                        // Create gradient matching Gemini's gold
                                        const stops = style.color.stops || [
                                            { offset: 0, color: '#B8860B' },
                                            { offset: 0.5, color: '#FFD700' },
                                            { offset: 1, color: '#B8860B' }
                                        ];

                                        textFill = new fabric.Gradient({
                                            type: 'linear',
                                            coords: {
                                                x1: 0,
                                                y1: 0,
                                                x2: 0,
                                                y2: style.fontSize || 24
                                            },
                                            colorStops: stops
                                        });
                                    } else {
                                        // Solid color
                                        textFill = style.color.value || '#FFD700';
                                    }

                                    // Determine text positioning
                                    const align = style.align || 'left';
                                    let textX;
                                    if (align === 'center') {
                                        textX = blockBbox.x + (blockBbox.width / 2);
                                    } else if (align === 'right') {
                                        textX = blockBbox.x + blockBbox.width;
                                    } else {
                                        textX = blockBbox.x;
                                    }

                                    // Create corrected text
                                    const correctedText = new fabric.Text(block.correctedContent, {
                                        left: textX,
                                        top: blockBbox.y,
                                        fontSize: style.fontSize || 24,
                                        fontFamily: style.fontFamily || 'Arial',
                                        fontWeight: style.fontWeight || '400',
                                        fill: textFill,
                                        textAlign: align,
                                        originX: align,
                                        originY: 'top',
                                        selectable: false,
                                        charSpacing: parseInt(style.letterSpacing) || 0
                                    });

                                    // Add shadow if specified
                                    if (style.shadow) {
                                        correctedText.shadow = new fabric.Shadow({
                                            color: style.shadow.color,
                                            blur: style.shadow.blur,
                                            offsetX: style.shadow.offsetX || 0,
                                            offsetY: style.shadow.offsetY || 0
                                        });
                                    }

                                    // Add stroke if the text has borders
                                    if (style.stroke) {
                                        correctedText.stroke = style.stroke.color || 'rgba(0, 0, 0, 0.3)';
                                        correctedText.strokeWidth = style.stroke.width || 1;
                                    }

                                    canvas.add(correctedText);

                                    // Add glow layer if gold text (matching Gemini's style)
                                    if (style.color.value?.includes('FFD700') || style.color.value?.includes('D4AF37') || style.color.type === 'gradient') {
                                        const glowText = new fabric.Text(block.correctedContent, {
                                            left: correctedText.left,
                                            top: correctedText.top,
                                            fontSize: style.fontSize || 24,
                                            fontFamily: style.fontFamily || 'Arial',
                                            fontWeight: style.fontWeight || '400',
                                            fill: '#FFD700',
                                            textAlign: align,
                                            originX: align,
                                            originY: 'top',
                                            selectable: false,
                                            opacity: 0.25,
                                            shadow: new fabric.Shadow({
                                                color: 'rgba(255, 215, 0, 0.7)',
                                                blur: 25,
                                                offsetX: 0,
                                                offsetY: 0
                                            })
                                        });

                                        // Insert glow behind text
                                        canvas.insertAt(glowText, canvas.getObjects().length - 1);
                                    }
                                });

                                console.log(`‚úÖ Section ${sectionIndex + 1} complete - gradient bubble overlay applied`);
                            });

                            // Render final image
                            canvas.renderAll();

                            // Export as base64
                            const dataURL = canvas.toDataURL({
                                format: 'png',
                                quality: 1.0,
                                multiplier: 1
                            });
                            const correctedBase64 = dataURL.split(',')[1];

                            console.log('‚úÖ SURGICAL REPLACEMENT: Complete - all errors corrected!');
                            resolve(correctedBase64);
                        });
                    } catch (error) {
                        console.error('‚ùå SURGICAL REPLACEMENT ERROR:', error);
                        reject(error);
                    }
                };

                img.onerror = () => {
                    console.error('‚ùå Failed to load original image');
                    reject(new Error('Failed to load image'));
                };

                img.src = `data:image/png;base64,${imageBase64}`;
            });
        }

        /**
         * Comparison Test: Gemini vs Fabric.js
         * Demonstrates Fabric.js text overlay with 100% spelling accuracy
         */
        async function runComparisonTest() {
            console.log('‚öñÔ∏è COMPARISON TEST: Starting Fabric.js demonstration...');

            const comparisonBtn = document.getElementById('compareBtn');
            const originalBtnText = comparisonBtn.innerHTML;
            comparisonBtn.disabled = true;
            comparisonBtn.innerHTML = '<span>‚è≥</span><span>Generating Demo...</span>';

            try {
                // Test data - Economic Outlook template
                const testData = {
                    header: 'ECONOMIC OUTLOOK',
                    rates: {
                        rate30Year: '6.87%',
                        rate15Year: '6.125%',
                        rateARM: '5.88%'
                    },
                    bullets: [
                        'MARKET OUTLOOK: STABILIZING',
                        'RATES: COMPETITIVE',
                        'DEMAND: STRONG',
                        'INVENTORY: LOW'
                    ],
                    name: 'DAVID YOUNG',
                    nmls: '62043',
                    phone: '310-954-7771'
                };

                // Step 1: Create a simple canvas background design (no text)
                console.log('üìê STEP 1: Creating design foundation (no text)...');

                // Create a canvas with gradient background and geometric patterns
                const designCanvas = document.createElement('canvas');
                designCanvas.width = 1080;
                designCanvas.height = 1350;
                const ctx = designCanvas.getContext('2d');

                // Create forest green gradient background
                const gradient = ctx.createLinearGradient(0, 0, 0, 1350);
                gradient.addColorStop(0, '#1a4d2e');
                gradient.addColorStop(1, '#0f2818');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1350);

                // Add subtle geometric patterns
                ctx.strokeStyle = 'rgba(218, 165, 32, 0.1)';
                ctx.lineWidth = 2;

                // Draw diagonal lines
                for (let i = 0; i < 20; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * 100, 0);
                    ctx.lineTo(i * 100 + 400, 1350);
                    ctx.stroke();
                }

                // Draw some hexagons
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 5; col++) {
                        const x = col * 200 + (row % 2) * 100 + 100;
                        const y = row * 200 + 200;
                        drawHexagon(ctx, x, y, 50);
                    }
                }

                // Add gold accent bars
                ctx.fillStyle = 'rgba(218, 165, 32, 0.15)';
                ctx.fillRect(0, 150, 1080, 4);
                ctx.fillRect(0, 550, 1080, 4);
                ctx.fillRect(0, 1100, 1080, 4);

                // Convert to base64
                const designDataURL = designCanvas.toDataURL('image/png');
                const designImageData = designDataURL.split(',')[1];

                console.log('‚úÖ STEP 1 COMPLETE: Design foundation created');

                // Helper function to draw hexagon
                function drawHexagon(ctx, x, y, size) {
                    ctx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i;
                        const xPos = x + size * Math.cos(angle);
                        const yPos = y + size * Math.sin(angle);
                        if (i === 0) {
                            ctx.moveTo(xPos, yPos);
                        } else {
                            ctx.lineTo(xPos, yPos);
                        }
                    }
                    ctx.closePath();
                    ctx.stroke();
                }

                // Step 2: Add text with Fabric.js
                console.log('üé® STEP 2: Adding text with Fabric.js...');

                const fabricResult = await renderTextWithFabric(designImageData, testData);
                const fabricImageData = fabricResult.imageData;

                console.log('‚úÖ STEP 2 COMPLETE: Fabric.js text added');

                // Step 3: Verify spelling accuracy
                console.log('üîç STEP 3: Verifying spelling accuracy with Gemini Vision...');

                const fabricVerification = await verifyImageText(fabricImageData);

                console.log('‚úÖ STEP 3 COMPLETE: Image verified');

                // Step 4: Display demo results
                console.log('üìä STEP 4: Displaying demo results...');

                displayFabricDemo({
                    design: designImageData,
                    fabric: {
                        image: fabricImageData,
                        verification: fabricVerification,
                        cost: 0.00315,
                        method: 'Fabric.js Canvas Overlay'
                    }
                });

                console.log('‚úÖ FABRIC.JS DEMO COMPLETE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä RESULTS:');
                console.log(`   Spelling Accuracy: ${fabricVerification.issues.length === 0 ? '‚úÖ 100% PERFECT' : `‚ùå ${fabricVerification.issues.length} errors`}`);
                console.log(`   Cost per Image: $${0.00315.toFixed(5)}`);
                console.log(`   vs Current Gemini Method: $${0.02.toFixed(5)} (84% savings)`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå COMPARISON TEST FAILED:', error);
                alert(`Comparison test failed: ${error.message}`);
            } finally {
                comparisonBtn.disabled = false;
                comparisonBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * HYBRID TEST: Generate with Gemini, extract styling, recreate with correct spelling
         * This is the BEST of both worlds - Gemini's beautiful design + 100% accuracy
         */
        async function runHybridTest() {
            console.log('‚ú® HYBRID TEST: Starting Gemini + Canvas hybrid approach...');

            const hybridBtn = document.getElementById('hybridBtn');
            const originalBtnText = hybridBtn.innerHTML;
            hybridBtn.disabled = true;
            hybridBtn.innerHTML = '<span>‚è≥</span><span>Running Hybrid Test...</span>';

            try {
                // Step 1: Generate with current method (will likely have spelling errors)
                console.log('üîµ STEP 1: Generating image with Gemini (current method)...');

                const geminiImage = await generateImageForTest();
                console.log('‚úÖ STEP 1 COMPLETE: Gemini image generated');

                // Step 2: Verify and identify errors
                console.log('üîç STEP 2: Verifying text and identifying errors...');

                const verification = await verifyImageText(geminiImage);
                console.log(`‚úÖ STEP 2 COMPLETE: Found ${verification.issues.length} spelling errors`);

                if (verification.issues.length === 0) {
                    console.log('üéâ Perfect! No errors to fix. Gemini nailed it this time!');
                    alert('Gemini generated perfect spelling! No hybrid correction needed.');
                    return;
                }

                // Step 3: Extract detailed styling from Gemini's image
                console.log('üé® STEP 3: Extracting text styling from Gemini image...');

                const styling = await extractTextStyling(geminiImage);
                console.log(`‚úÖ STEP 3 COMPLETE: Extracted styling for ${styling.textElements.length} text elements`);

                // Step 4: Build correction map
                console.log('üìù STEP 4: Building correction map...');

                const corrections = {};
                verification.issues.forEach(issue => {
                    const match = issue.match(/word '(.+?)' should be '(.+?)'/);
                    if (match) {
                        const [, wrong, correct] = match;
                        corrections[wrong] = correct;
                        console.log(`  Will correct: "${wrong}" ‚Üí "${correct}"`);
                    }
                });

                // Step 5: Recreate text with correct spelling using Gemini's styling
                console.log('‚ú® STEP 5: Recreating text with Gemini styling + correct spelling...');

                const hybridImage = await recreateTextWithStyling(geminiImage, styling.textElements, corrections);
                console.log('‚úÖ STEP 5 COMPLETE: Hybrid image created');

                // Step 6: Verify the hybrid result
                console.log('üîç STEP 6: Verifying hybrid result...');

                const hybridVerification = await verifyImageText(hybridImage);
                console.log(`‚úÖ STEP 6 COMPLETE: Hybrid has ${hybridVerification.issues.length} errors`);

                // Step 7: Display comparison
                console.log('üìä STEP 7: Displaying comparison...');

                displayHybridComparison({
                    gemini: {
                        image: geminiImage,
                        verification: verification,
                        method: 'Gemini Flash 2.5 (Original)',
                        cost: 0.02
                    },
                    hybrid: {
                        image: hybridImage,
                        verification: hybridVerification,
                        method: 'Hybrid (Gemini Style + Canvas Text)',
                        cost: 0.02315 // Gemini + Vision analysis + minimal canvas
                    }
                });

                console.log('‚úÖ HYBRID TEST COMPLETE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä RESULTS COMPARISON:');
                console.log(`   Original Gemini: ${verification.issues.length} errors`);
                console.log(`   Hybrid Result: ${hybridVerification.issues.length} errors`);
                console.log(`   Improvement: ${verification.issues.length - hybridVerification.issues.length} errors fixed`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå HYBRID TEST FAILED:', error);
                alert(`Hybrid test failed: ${error.message}`);
            } finally {
                hybridBtn.disabled = false;
                hybridBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * Test DALL-E 3 image generation
         * Uses OpenAI API to generate Economic Outlook image
         */
        async function testDallE3() {
            console.log('üéØ DALL-E 3 TEST: Starting generation...');

            const dalleBtn = document.getElementById('dalleBtn');
            const originalBtnText = dalleBtn.innerHTML;
            dalleBtn.disabled = true;
            dalleBtn.innerHTML = '<span>‚è≥</span><span>Generating with DALL-E 3...</span>';

            // Check if API key is set
            if (OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                alert('Please set your OpenAI API key first!\n\n1. Get free credits at https://platform.openai.com/signup\n2. Generate API key at https://platform.openai.com/api-keys\n3. Replace OPENAI_API_KEY in the code (line 1071)');
                dalleBtn.disabled = false;
                dalleBtn.innerHTML = originalBtnText;
                return;
            }

            try {
                // Economic Outlook prompt
                const prompt = `Create a professional mortgage marketing image in 1024x1792 portrait format.

TITLE: "ECONOMIC OUTLOOK"

MAIN CONTENT:
FORECASTED RATES
6.75% - 30-YEAR FIXED APR
7.12% - 15-YEAR FIXED APR

MARKET INDICATORS:
‚Ä¢ BORROWER DEMAND: STRONG
‚Ä¢ LENDER COMPETITIVE CLIMATE: HIGH
‚Ä¢ INVESTMENT OUTLOOK: FAVORABLE
‚Ä¢ REFINANCE OPPORTUNITY: AVAILABLE

HOUSING MARKET:
‚Ä¢ HOME VALUES: APPRECIATING
‚Ä¢ INFLATION: MODERATING
‚Ä¢ INVENTORY: UNCHANGED

CONTACT:
DAVID YOUNG
NMLS #62043
PHONE: 310-954-7771

DESIGN REQUIREMENTS:
- Rich forest green gradient background (#1a4d2e to #0f2818)
- Metallic gold gradient text for headers and rates (#B8860B to #FFD700)
- White text for body content
- Professional, modern, clean layout
- LendWise Mortgages branding aesthetic
- CRITICAL: Perfect spelling - double-check every word`;

                console.log('üì§ Sending request to DALL-E 3 API...');

                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'dall-e-3',
                        prompt: prompt,
                        n: 1,
                        size: '1024x1792',
                        quality: 'standard', // or 'hd' for higher quality ($0.12)
                        response_format: 'url'
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`DALL-E API Error: ${data.error?.message || response.statusText}`);
                }

                console.log('‚úÖ DALL-E 3 response received');

                // Get the image URL
                const imageUrl = data.data[0].url;
                const revisedPrompt = data.data[0].revised_prompt;

                console.log('üìù DALL-E revised prompt:', revisedPrompt);

                // Download the image and convert to base64
                console.log('üì• Downloading image...');
                const imageResponse = await fetch(imageUrl);
                const imageBlob = await imageResponse.blob();
                const imageBase64 = await blobToBase64(imageBlob);

                console.log('‚úÖ Image downloaded and converted');

                // Verify spelling
                console.log('üîç Verifying spelling with Gemini Vision...');
                const verification = await verifyImageText(imageBase64);

                console.log(`‚úÖ Verification complete: ${verification.issues.length} errors found`);

                // Display result
                displayDallEResult({
                    image: imageBase64,
                    verification: verification,
                    revisedPrompt: revisedPrompt,
                    cost: 0.08 // $0.08 for standard quality 1024x1792
                });

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üéØ DALL-E 3 TEST COMPLETE');
                console.log(`   Spelling Accuracy: ${verification.issues.length === 0 ? '‚úÖ 100% PERFECT!' : `‚ùå ${verification.issues.length} errors`}`);
                console.log(`   Cost: $0.08`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå DALL-E 3 TEST FAILED:', error);
                alert(`DALL-E 3 test failed: ${error.message}\n\nMake sure your API key is correct and you have credits available.`);
            } finally {
                dalleBtn.disabled = false;
                dalleBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * Convert Blob to base64
         */
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        /**
         * Display DALL-E 3 test results
         */
        function displayDallEResult(result) {
            const gallery = document.getElementById('imageGallery');

            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'width: 100%; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); border-radius: 12px;';

            resultDiv.innerHTML = `
                <h3 style="color: #2c3e50; margin: 0 0 20px 0; text-align: center;">üéØ DALL-E 3 Test Results</h3>

                <div style="display: flex; gap: 20px;">
                    <!-- Generated Image -->
                    <div style="flex: 2; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px;">
                        <img src="data:image/png;base64,${result.image}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    </div>

                    <!-- Results Info -->
                    <div style="flex: 1; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin: 0 0 15px 0;">üìä Results</h4>
                        <div style="color: #2c3e50; font-size: 14px; line-height: 1.8;">
                            <p><strong>Spelling Accuracy:</strong><br>
                            ${result.verification.issues.length === 0 ?
                                '<span style="color: #27ae60; font-size: 18px; font-weight: 700;">‚úÖ 100% PERFECT!</span>' :
                                `<span style="color: #e74c3c; font-weight: 700;">‚ùå ${result.verification.issues.length} errors</span>`}
                            </p>

                            <p><strong>Cost per Image:</strong><br>
                            $${result.cost.toFixed(3)}
                            </p>

                            <p><strong>vs Gemini:</strong><br>
                            ${(result.cost / 0.02).toFixed(1)}√ó more expensive
                            </p>

                            ${result.verification.issues.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #e74c3c;">Spelling Errors (${result.verification.issues.length})</summary>
                                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                                        ${result.verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}

                            ${result.verification.issues.length === 0 ? `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(39, 174, 96, 0.2); border-radius: 8px; border: 2px solid #27ae60;">
                                    <p style="margin: 0; font-weight: 700; color: #27ae60;">
                                        üéâ SUCCESS!<br>
                                        DALL-E 3 achieved perfect spelling!
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-size: 12px; color: #666;">Show DALL-E's Revised Prompt</summary>
                            <p style="font-size: 11px; color: #666; margin: 10px 0; line-height: 1.4;">
                                ${result.revisedPrompt}
                            </p>
                        </details>
                    </div>
                </div>
            `;

            gallery.insertBefore(resultDiv, gallery.firstChild);
        }

        /**
         * SIMPLIFIED All-Gold Generation - Bypasses all complex systems
         * Theory: Large gold 3D text = 100% accuracy (proven by data)
         * This function makes ONE clean API call with no corrections or retries
         */
        async function testAllGoldStyle() {
            console.log('‚ú® SIMPLIFIED ALL-GOLD TEST: One clean generation, no interference...');

            const btn = document.getElementById('allGoldBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Generating...</span>';

            // Ultra-simple prompt that forces ALL text to IDENTICAL large gold gradient style
            const prompt = `Create a professional mortgage marketing image in 9:16 portrait format (1024x1792).

üé® VISUAL STYLE - ABSOLUTE REQUIREMENTS:
‚Ä¢ Background: Deep forest green gradient (#1a4d2e to #0f2818)
‚Ä¢ TEXT STYLE: ALL text must use IDENTICAL large, bold, metallic GOLD GRADIENT (#B8860B to #FFD700)
‚Ä¢ TEXT SIZE: ALL text must be LARGE and PROMINENT - same size throughout
‚Ä¢ TEXT EFFECT: ALL text must have 3D embossed effect with depth and shadow
‚Ä¢ NO BULLETS: Do not use bullet points (‚Ä¢) - just plain text
‚Ä¢ NO STYLE VARIATIONS: Every single word must look IDENTICAL in style, size, and color
‚Ä¢ This is a LUXURY design - make ALL text vibrant and eye-catching

üìù EXACT TEXT TO INCLUDE (spell each word PERFECTLY):

ECONOMIC OUTLOOK

FORECASTED RATES
6.75% - 30-YEAR FIXED APR
7.12% - 15-YEAR FIXED APR

MARKET INDICATORS
BORROWER DEMAND: STRONG
COMPETITIVE CLIMATE: HIGH
INVESTMENT OUTLOOK: FAVORABLE
REFINANCE OPPORTUNITY: AVAILABLE

HOUSING MARKET
HOME VALUES: APPRECIATING
INFLATION: MODERATING
INVENTORY: UNCHANGED

DAVID YOUNG - NMLS #62043
PHONE: 310-954-7771

LENDWISE MORTGAGES

‚ö†Ô∏è CRITICAL INSTRUCTIONS:
1. Spell EVERY WORD PERFECTLY - double check: APPRECIATING, AVAILABLE, COMPETITIVE, OUTLOOK, UNCHANGED
2. Use the SAME vibrant gold gradient for ALL TEXT - no smaller text, no different colors
3. Make ALL TEXT the SAME LARGE SIZE with 3D embossed effect
4. NO bullet points (‚Ä¢) - use plain text only
5. Every line should look IDENTICAL in style - same size, same color, same 3D effect`;

            try {
                // DIRECT API CALL - No Prompt Architect, no two-pass, no corrections
                console.log('üì§ Sending SINGLE direct API call to Gemini 2.5 Flash Image...');

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.4,
                            topK: 40,
                            topP: 0.95,
                            responseModalities: ["image"]
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå API Error Response:', errorData);
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ API Response received');
                console.log('üì¶ Response structure:', JSON.stringify(data, null, 2));

                // Extract image from response (note: property is inlineData, not inline_data)
                const imagePart = data.candidates[0].content.parts.find(p => p.inlineData);
                if (!imagePart) {
                    console.error('‚ùå No inlineData found in parts:', data.candidates[0].content.parts);
                    throw new Error('No image in response');
                }
                const imageBase64 = imagePart.inlineData.data;

                // Verify spelling
                console.log('üîç Verifying spelling...');
                const verification = await verifyImageText(imageBase64);

                // Display result in gallery
                const imageUrl = 'data:image/jpeg;base64,' + imageBase64;
                displaySimplifiedResult(imageUrl, imageBase64, verification);

                btn.disabled = false;
                btn.innerHTML = originalText;

                console.log('‚úÖ Simplified All-Gold test complete!');
                console.log(`üìä Result: ${verification.issues.length} spelling errors`);
                if (verification.issues.length === 0) {
                    console.log('üéâ SUCCESS! All-gold gradient achieved 100% spelling accuracy!');
                }
            } catch (error) {
                console.error('‚ùå Simplified test failed:', error);
                alert('Test failed: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        /**
         * Display simplified test results
         */
        function displaySimplifiedResult(imageUrl, imageBase64, verification) {
            const gallery = document.getElementById('imageGallery');

            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 12px;';

            const errorCount = verification.issues.length;
            const isSuccess = errorCount === 0;

            resultDiv.innerHTML = `
                <h3 style="color: white; margin: 0 0 15px 0; text-align: center;">
                    ‚ú® SIMPLIFIED ALL-GOLD TEST RESULTS
                </h3>

                <div style="display: flex; gap: 20px; align-items: start;">
                    <div style="flex: 2;">
                        <img src="${imageUrl}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    </div>

                    <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <h4 style="color: white; margin: 0 0 15px 0;">üìä Results</h4>

                        <div style="color: white; font-size: 14px; line-height: 1.8;">
                            <p><strong>Spelling Accuracy:</strong><br>
                            ${isSuccess ?
                                '<span style="color: #fff; font-size: 20px; font-weight: 700;">‚úÖ 100% PERFECT!</span>' :
                                `<span style="color: #ffeb3b; font-weight: 700;">‚ö†Ô∏è ${errorCount} errors</span>`}
                            </p>

                            <p><strong>Generation Method:</strong><br>
                            Single direct API call<br>
                            No corrections, no retries
                            </p>

                            <p><strong>API Calls Used:</strong><br>
                            1 generation + 1 verification = 2 total
                            </p>

                            ${errorCount > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #ffeb3b;">
                                        View ${errorCount} Errors
                                    </summary>
                                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                                        ${verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.3); border-radius: 8px; border: 2px solid white;">
                                    <p style="margin: 0; font-weight: 700; text-align: center;">
                                        üéâ BREAKTHROUGH!<br><br>
                                        All-gold gradient achieved<br>
                                        PERFECT SPELLING with<br>
                                        ONE SIMPLE API CALL!<br><br>
                                        Theory CONFIRMED! ‚ú®
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            gallery.insertBefore(resultDiv, gallery.firstChild);
        }

        /**
         * Test Ideogram AI - Specialized text-in-image generation
         * Ideogram 3.0 is specifically designed for accurate text rendering
         */
        async function testIdeogram() {
            console.log('üéØ IDEOGRAM AI TEST: Starting generation...');

            const btn = document.getElementById('ideogramBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Generating with Ideogram...</span>';

            // Simplified prompt optimized for Ideogram V3 text accuracy
            const prompt = `Professional mortgage marketing poster, 9:16 portrait format.

DESIGN: Deep forest green gradient background (#1a4d2e to #0f2818), luxury financial theme.

TEXT STYLING: All text in large bold metallic gold (#FFD700), 3D embossed effect, centered layout.

EXACT TEXT (spell perfectly):

ECONOMIC OUTLOOK

FORECASTED RATES
6.75% - 30-YEAR FIXED APR
7.12% - 15-YEAR FIXED APR

MARKET INDICATORS
BORROWER DEMAND: STRONG
COMPETITIVE CLIMATE: HIGH
INVESTMENT OUTLOOK: FAVORABLE
REFINANCE OPPORTUNITY: AVAILABLE

HOUSING MARKET
HOME VALUES: APPRECIATING
INFLATION: MODERATING
INVENTORY: UNCHANGED

DAVID YOUNG - NMLS #62043
PHONE: 310-954-7771

LENDWISE MORTGAGES

Render all text clearly and accurately.`;

            try {
                console.log('üì§ Sending request to Ideogram AI V3 (upgraded) via proxy...');

                // Use local proxy server to avoid CORS issues
                const response = await fetch('http://localhost:3001/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        aspect_ratio: "ASPECT_9_16",
                        model: "V_3",  // Upgraded to V3 for better text rendering
                        magic_prompt: false  // Disable to preserve exact text
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Ideogram API Error:', errorData);
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Ideogram API Response received');
                console.log('üì¶ Response structure:', JSON.stringify(data, null, 2));

                // Extract image from Ideogram response
                // Ideogram V3 returns synchronous response with image URL or base64
                let imageUrl, imageBase64;

                if (data.data && data.data[0]) {
                    const imageData = data.data[0];

                    if (imageData.url) {
                        // If Ideogram returns a URL, fetch the image and convert to base64
                        console.log('üì• Fetching image from URL:', imageData.url);
                        const imgResponse = await fetch(imageData.url);
                        const blob = await imgResponse.blob();
                        imageBase64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(blob);
                        });
                        imageUrl = 'data:image/jpeg;base64,' + imageBase64;
                    } else if (imageData.base64) {
                        // If base64 is directly provided
                        imageBase64 = imageData.base64;
                        imageUrl = 'data:image/jpeg;base64,' + imageBase64;
                    } else {
                        throw new Error('No image URL or base64 in response');
                    }
                } else {
                    throw new Error('Unexpected response format from Ideogram');
                }

                // Verify spelling
                console.log('üîç Verifying spelling...');
                const verification = await verifyImageText(imageBase64);

                // Display result in gallery
                displayIdeogramResult(imageUrl, imageBase64, verification);

                btn.disabled = false;
                btn.innerHTML = originalText;

                console.log('‚úÖ Ideogram AI test complete!');
                console.log(`üìä Result: ${verification.issues.length} spelling errors`);
                if (verification.issues.length === 0) {
                    console.log('üéâ SUCCESS! Ideogram AI achieved 100% spelling accuracy!');
                } else {
                    console.log(`‚ö†Ô∏è Ideogram had ${verification.issues.length} errors - still better than Gemini?`);
                }

            } catch (error) {
                console.error('‚ùå Ideogram test failed:', error);
                alert('Ideogram test failed: ' + error.message + '\n\nCheck console for details.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        /**
         * Display Ideogram test results
         */
        function displayIdeogramResult(imageUrl, imageBase64, verification) {
            const gallery = document.getElementById('imageGallery');

            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); border-radius: 12px;';

            const errorCount = verification.issues.length;
            const isSuccess = errorCount === 0;

            resultDiv.innerHTML = `
                <h3 style="color: white; margin: 0 0 15px 0; text-align: center;">
                    üéØ IDEOGRAM AI TEST RESULTS
                </h3>

                <div style="display: flex; gap: 20px; align-items: start;">
                    <div style="flex: 2;">
                        <img src="${imageUrl}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    </div>

                    <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <h4 style="color: white; margin: 0 0 15px 0;">üìä Results</h4>

                        <div style="color: white; font-size: 14px; line-height: 1.8;">
                            <p><strong>Spelling Accuracy:</strong><br>
                            ${isSuccess ?
                                '<span style="color: #fff; font-size: 20px; font-weight: 700;">‚úÖ 100% PERFECT!</span>' :
                                `<span style="color: #ffeb3b; font-weight: 700;">‚ö†Ô∏è ${errorCount} errors</span>`}
                            </p>

                            <p><strong>AI Model:</strong><br>
                            Ideogram 3.0 (text specialist)
                            </p>

                            <p><strong>Cost:</strong><br>
                            $0.04 per image<br>
                            (2√ó Gemini cost)
                            </p>

                            <p><strong>API Calls Used:</strong><br>
                            1 generation + 1 verification = 2 total
                            </p>

                            ${errorCount > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #ffeb3b;">
                                        View ${errorCount} Errors
                                    </summary>
                                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                                        ${verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.3); border-radius: 8px; border: 2px solid white;">
                                    <p style="margin: 0; font-weight: 700; text-align: center;">
                                        üéâ SOLUTION FOUND!<br><br>
                                        Ideogram AI achieved<br>
                                        PERFECT SPELLING!<br><br>
                                        Production ready! ‚ú®
                                    </p>
                                </div>
                            `}

                            ${errorCount > 0 && errorCount < 5 ? `
                                <div style="margin-top: 15px; padding: 10px; background: rgba(255,235,59,0.2); border-radius: 8px; border-left: 3px solid #ffeb3b;">
                                    <p style="margin: 0; font-size: 12px;">
                                        ‚ÑπÔ∏è Better than Gemini (5-7 errors), but not perfect yet.
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            gallery.insertBefore(resultDiv, gallery.firstChild);
        }

        /**
         * Test Imagen 4 Fast - Google's latest model with perfect text rendering
         */
        async function testImagen4Fast() {
            console.log('‚ö° IMAGEN 4 FAST TEST: Starting generation...');

            const imagen4Btn = document.getElementById('imagen4Btn');
            const originalBtnText = imagen4Btn.innerHTML;
            imagen4Btn.disabled = true;
            imagen4Btn.innerHTML = '<span>‚è≥</span><span>Generating with Imagen 4 Fast...</span>';

            try {
                // Economic Outlook prompt
                const prompt = `Create a professional mortgage marketing image in 1024x1792 portrait format.

TITLE: "ECONOMIC OUTLOOK"

MAIN CONTENT:
FORECASTED RATES
6.75% - 30-YEAR FIXED APR
7.12% - 15-YEAR FIXED APR

MARKET INDICATORS:
‚Ä¢ BORROWER DEMAND: STRONG
‚Ä¢ LENDER COMPETITIVE CLIMATE: HIGH
‚Ä¢ INVESTMENT OUTLOOK: FAVORABLE
‚Ä¢ REFINANCE OPPORTUNITY: AVAILABLE

HOUSING MARKET:
‚Ä¢ HOME VALUES: APPRECIATING
‚Ä¢ INFLATION: MODERATING
‚Ä¢ INVENTORY: UNCHANGED

CONTACT:
DAVID YOUNG
NMLS #62043
PHONE: 310-954-7771

DESIGN REQUIREMENTS:
- Rich forest green gradient background (#1a4d2e to #0f2818)
- Metallic gold gradient text for headers and rates (#B8860B to #FFD700)
- White text for body content
- Professional, modern, clean layout
- LendWise Mortgages branding aesthetic
- CRITICAL: Perfect spelling - double-check every word`;

                console.log('üì§ Sending request to Imagen 4 Fast API...');

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-fast-generate-001:generateImage?key=' + API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        number_of_images: 1,
                        aspect_ratio: '9:16', // Portrait format for 1024x1792
                        safety_filter_level: 'block_low_and_above',
                        person_generation: 'allow_all'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Imagen API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Imagen 4 Fast generation complete');

                // Extract base64 image
                const imageBase64 = data.images[0].image;

                // Verify spelling with Gemini Vision
                console.log('üîç Verifying text accuracy...');
                const verification = await verifyImageText(imageBase64);

                // Display result
                displayImagen4Result({
                    image: imageBase64,
                    verification: verification,
                    cost: 0.02,
                    model: 'Imagen 4 Fast'
                });

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚ö° IMAGEN 4 FAST TEST COMPLETE');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå IMAGEN 4 FAST TEST FAILED:', error);
                alert(`Imagen 4 Fast test failed: ${error.message}`);
            } finally {
                imagen4Btn.disabled = false;
                imagen4Btn.innerHTML = originalBtnText;
            }
        }

        /**
         * Display Imagen 4 test results
         */
        function displayImagen4Result(result) {
            const gallery = document.getElementById('imageGallery');

            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'width: 100%; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); border-radius: 12px;';

            resultDiv.innerHTML = `
                <h3 style="color: white; margin: 0 0 20px 0; text-align: center;">‚ö° ${result.model} Test Results</h3>

                <div style="display: flex; gap: 20px;">
                    <!-- Generated Image -->
                    <div style="flex: 2; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <img src="data:image/png;base64,${result.image}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    </div>

                    <!-- Results Info -->
                    <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <h4 style="color: white; margin: 0 0 15px 0;">üìä Results</h4>
                        <div style="color: white; font-size: 14px; line-height: 1.8;">
                            <p><strong>Spelling Accuracy:</strong><br>
                            ${result.verification.issues.length === 0 ?
                                '<span style="color: #fff; font-size: 18px; font-weight: 700; text-shadow: 0 0 10px rgba(255,255,255,0.5);">‚úÖ 100% PERFECT!</span>' :
                                `<span style="color: #ffeb3b; font-weight: 700;">‚ö†Ô∏è ${result.verification.issues.length} errors</span>`}
                            </p>

                            <p><strong>Cost per Image:</strong><br>
                            $${result.cost.toFixed(3)}
                            </p>

                            <p><strong>vs Gemini Flash:</strong><br>
                            ${result.cost === 0.02 ?
                                '<span style="color: #fff; font-weight: 700;">üéâ SAME PRICE!</span>' :
                                `${(result.cost / 0.02).toFixed(1)}√ó more expensive`}
                            </p>

                            ${result.verification.issues.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #ffeb3b;">Spelling Errors (${result.verification.issues.length})</summary>
                                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                                        ${result.verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}

                            ${result.verification.issues.length === 0 ? `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.3); border-radius: 8px; border: 2px solid white;">
                                    <p style="margin: 0; font-weight: 700; color: white; text-align: center;">
                                        üéâ SUCCESS!<br>
                                        ${result.model} achieved perfect spelling<br>
                                        at the same price as Gemini!
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            gallery.insertBefore(resultDiv, gallery.firstChild);
        }

        /**
         * Generate a test image using current Gemini method
         * For hybrid testing, we'll use the Initialize button's existing generation
         */
        async function generateImageForTest() {
            console.log('üì∏ Using last generated image from gallery for hybrid test...');

            // Check if there's a recently generated image in the gallery
            const gallery = document.getElementById('imageGallery');
            const firstImage = gallery.querySelector('img');

            if (firstImage && firstImage.src.startsWith('data:image')) {
                // Extract base64 from the data URL
                const base64Data = firstImage.src.split(',')[1];
                console.log('‚úÖ Found existing image in gallery to test');
                return base64Data;
            }

            // If no image exists, tell user to generate one first
            throw new Error('No image found! Please click "Initialize" button first to generate an image, then try the Hybrid test.');
        }

        /**
         * Display Fabric.js demo results in the gallery
         */
        function displayFabricDemo(results) {
            const gallery = document.getElementById('imageGallery');

            // Create comparison container
            const comparisonDiv = document.createElement('div');
            comparisonDiv.style.cssText = 'width: 100%; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;';

            comparisonDiv.innerHTML = `
                <h3 style="color: white; margin: 0 0 20px 0; text-align: center;">üé® Fabric.js Canvas Overlay Demo</h3>

                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <!-- Fabric.js Result -->
                    <div style="flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <h4 style="color: #FFD700; margin: 0 0 10px 0;">‚ú® ${results.fabric.method}</h4>
                        <img src="data:image/png;base64,${results.fabric.image}" style="width: 100%; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="color: white; font-size: 14px;">
                            <p style="margin: 5px 0;"><strong>Spelling Accuracy:</strong> ${results.fabric.verification.issues.length === 0 ? '‚úÖ 100% Perfect!' : `‚ùå ${results.fabric.verification.issues.length} errors`}</p>
                            <p style="margin: 5px 0;"><strong>Cost per Image:</strong> $${results.fabric.cost.toFixed(5)}</p>
                            <p style="margin: 5px 0;"><strong>Method:</strong> Programmatic Canvas rendering</p>
                            ${results.fabric.verification.issues.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #FFD700;">Show Issues (${results.fabric.verification.issues.length})</summary>
                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                        ${results.fabric.verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Benefits List -->
                    <div style="flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <h4 style="color: #FFD700; margin: 0 0 10px 0;">üìä Key Benefits</h4>
                        <div style="color: white; font-size: 14px; line-height: 1.8;">
                            <p style="margin: 10px 0;">
                                <strong style="color: #4ADE80;">‚úÖ 100% Spelling Accuracy</strong><br>
                                Text is programmatically controlled - no AI spelling mistakes
                            </p>
                            <p style="margin: 10px 0;">
                                <strong style="color: #4ADE80;">üí∞ 84% Cost Reduction</strong><br>
                                $0.00315 vs $0.02 per image<br>
                                <span style="font-size: 12px; color: #A0A0A0;">Saves $16.85 per 1,000 images</span>
                            </p>
                            <p style="margin: 10px 0;">
                                <strong style="color: #FFD700;">üé® Professional Styling</strong><br>
                                Gold gradients, custom fonts, shadows & effects
                            </p>
                            <p style="margin: 10px 0;">
                                <strong style="color: #60A5FA;">‚ö° Instant Generation</strong><br>
                                No Phase 3 corrections needed - always perfect
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Cost Comparison -->
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center;">
                    <h4 style="color: #FFD700; margin: 0 0 10px 0;">üí∞ Cost vs Current Method</h4>
                    <p style="color: white; margin: 5px 0; font-size: 20px;">
                        <strong style="color: #4ADE80;">Saves 84%</strong> per image
                    </p>
                    <p style="color: white; margin: 5px 0; font-size: 14px;">
                        Current Gemini: $0.02000 ‚Üí Fabric.js: $0.00315
                    </p>
                    <p style="color: #A0A0A0; margin: 5px 0; font-size: 12px;">
                        At 1,000 images: $20.00 ‚Üí $3.15 (saves $16.85)
                    </p>
                </div>
            `;

            // Add to top of gallery
            gallery.insertBefore(comparisonDiv, gallery.firstChild);
        }

        /**
         * Display hybrid comparison results
         */
        function displayHybridComparison(results) {
            const gallery = document.getElementById('imageGallery');

            const comparisonDiv = document.createElement('div');
            comparisonDiv.style.cssText = 'width: 100%; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); border-radius: 12px;';

            comparisonDiv.innerHTML = `
                <h3 style="color: white; margin: 0 0 20px 0; text-align: center;">‚ú® Hybrid Approach Results</h3>
                <p style="color: white; text-align: center; margin-bottom: 20px; font-size: 14px;">
                    Gemini's Beautiful Design + Canvas's Perfect Spelling
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Original Gemini -->
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1a4d2e; margin: 0 0 10px 0; font-weight: 700;">üîµ ${results.gemini.method}</h4>
                        <img src="data:image/png;base64,${results.gemini.image}" style="width: 100%; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="color: #1a4d2e; font-size: 14px;">
                            <p style="margin: 5px 0;"><strong>Spelling:</strong> ${results.gemini.verification.issues.length === 0 ? '‚úÖ Perfect!' : `‚ùå ${results.gemini.verification.issues.length} errors`}</p>
                            <p style="margin: 5px 0;"><strong>Visual Quality:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê AI-generated</p>
                            <p style="margin: 5px 0;"><strong>Cost:</strong> $${results.gemini.cost.toFixed(5)}</p>
                            ${results.gemini.verification.issues.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600;">Spelling Errors (${results.gemini.verification.issues.length})</summary>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${results.gemini.verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Hybrid Result -->
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border: 3px solid #FFD700;">
                        <h4 style="color: #1a4d2e; margin: 0 0 10px 0; font-weight: 700;">‚ú® ${results.hybrid.method}</h4>
                        <img src="data:image/png;base64,${results.hybrid.image}" style="width: 100%; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(255,215,0,0.4);">
                        <div style="color: #1a4d2e; font-size: 14px;">
                            <p style="margin: 5px 0;"><strong>Spelling:</strong> ${results.hybrid.verification.issues.length === 0 ? '‚úÖ 100% Perfect!' : `‚ö†Ô∏è ${results.hybrid.verification.issues.length} errors`}</p>
                            <p style="margin: 5px 0;"><strong>Visual Quality:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Gemini styling</p>
                            <p style="margin: 5px 0;"><strong>Cost:</strong> $${results.hybrid.cost.toFixed(5)}</p>
                            ${results.hybrid.verification.issues.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600;">Remaining Issues (${results.hybrid.verification.issues.length})</summary>
                                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        ${results.hybrid.verification.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Results Summary -->
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <h4 style="color: #1a4d2e; margin: 0 0 10px 0;">üìä Comparison Summary</h4>
                    <div style="display: flex; justify-content: space-around; color: #1a4d2e;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700;">${results.gemini.verification.issues.length}</div>
                            <div style="font-size: 12px;">Original Errors</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700;">‚Üí</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #4ADE80;">${results.hybrid.verification.issues.length}</div>
                            <div style="font-size: 12px;">Hybrid Errors</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #FFD700;">${results.gemini.verification.issues.length - results.hybrid.verification.issues.length}</div>
                            <div style="font-size: 12px;">Errors Fixed</div>
                        </div>
                    </div>
                    <p style="margin: 15px 0 5px 0; font-weight: 600; color: #1a4d2e;">
                        ${results.hybrid.verification.issues.length === 0 ?
                            'üéâ Perfect! Hybrid approach achieved 100% spelling accuracy while maintaining Gemini\'s beautiful design!' :
                            `‚ö†Ô∏è Improved from ${results.gemini.verification.issues.length} to ${results.hybrid.verification.issues.length} errors`}
                    </p>
                </div>
            `;

            gallery.insertBefore(comparisonDiv, gallery.firstChild);
        }

        async function generateImage(message, templateName) {
            isGenerating = true;
            document.getElementById('chatSendBtn').disabled = true;

            try {
                console.log(`üîµ Starting API call for: ${templateName}`);

                // Update loading message
                const loadingMsg = document.querySelector('.loading-msg');
                if (loadingMsg) {
                    loadingMsg.textContent = `üé® Generating image...`;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutes for quality retries

                // Log what we're sending to backend
                console.log('üìã Prompt sent to Quality Backend:', message.substring(0, 100) + '...');
                if (brandLogoData) {
                    console.log('üé® Brand logo included (base64 length:', brandLogoData.data.length, 'chars)');
                } else {
                    console.warn('‚ö†Ô∏è Brand logo NOT included - brandLogoData is null/undefined');
                }
                if (uploadedImageData) {
                    console.log('üì∏ Uploaded photo included (base64 length:', uploadedImageData.data.length, 'chars)');
                } else {
                    console.log('‚ÑπÔ∏è No uploaded photo - will generate without person');
                }

                // ‚≠ê Send request to Quality-Guaranteed Backend
                // This ensures 100% perfect images (or best attempt with warning)
                console.log('üéØ Using Quality-Guaranteed Backend (max 5 attempts for 100%)');

                const backendResponse = await fetch('http://localhost:3001/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: message,
                        templateName: templateName,
                        maxAttempts: 5,
                        logo: brandLogoData ? { data: brandLogoData.data, mimeType: brandLogoData.mimeType } : null,
                        photo: uploadedImageData ? { data: uploadedImageData.data, mimeType: uploadedImageData.mimeType } : null
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!backendResponse.ok) {
                    throw new Error(`Backend request failed: ${backendResponse.status} ${backendResponse.statusText}`);
                }

                const data = await backendResponse.json();
                console.log('üì¶ Backend Response:', data);

                // Check quality guarantee
                if (data.success) {
                    console.log(`‚úÖ 100% PERFECT QUALITY achieved on attempt ${data.attempts}!`);

                    // Update loading message with success
                    if (loadingMsg) {
                        loadingMsg.textContent = `‚úÖ Perfect quality on attempt ${data.attempts}!`;
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Best quality: ${data.score}% (${data.errors?.length || 0} issues found)`);
                    console.warn('Issues:', data.errors);

                    // Show warning to user
                    if (loadingMsg) {
                        loadingMsg.innerHTML = `‚ö†Ô∏è Best quality: ${data.score}%<br><small>${data.message}</small>`;
                    }
                }

                // Extract image data from backend response
                let imageData = data.imageBase64;
                let imageUrl = `data:image/png;base64,${imageData}`;

                console.log(`‚úÖ Image generated with ${data.score}% quality (${data.attempts} attempts)`);

                // üé® CLEAN MODE: Show original Gemini output without modifications
                // Automatic verification and surgical replacement DISABLED
                // User can manually fix spelling errors if needed

                // Add to image history - show original Gemini output
                imageHistory.push({
                    url: imageUrl,
                    data: imageData,
                    prompt: templateName,
                    timestamp: Date.now()
                });

                updateImageGallery();
                console.log('‚úÖ Image generated successfully!');

            } catch (error) {
                console.error('üî¥ Full error:', error);
                document.getElementById('emptyMessage').innerHTML = `<div style="color: #dc3545;">‚ùå Error: ${error.message}</div>`;
            }

            isGenerating = false;
            document.getElementById('chatSendBtn').disabled = false;
        }

        // Initialize generation from selected template or custom prompt
        async function initializeGeneration() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || isGenerating) return;

            console.log('‚ö° Initializing generation...');

            // START OWL WORKING STATE - Activate particles
            if (particleSystem) {
                particleSystem.start();
                console.log('ü¶â Owl entering working mode with swirling particles...');
            }

            try {
                // IMPORTANT: Check template FIRST before refinement mode
                // This ensures clicking a template always generates fresh content
                if (selectedTemplate) {
                    // Template generation with user modifications
                    await generateFromTemplate(selectedTemplate, message);
                } else if (imageHistory.length > 0) {
                    // This is a refinement/edit request
                    await refineImage(message);
                } else {
                    // Custom prompt - freeform generation
                    console.log('üí¨ Custom prompt (freeform):', message);
                    await generateImage(message, 'Custom Prompt');
                }
            } finally {
                // STOP OWL WORKING STATE - Deactivate particles (always runs)
                if (particleSystem) {
                    particleSystem.stop();
                    console.log('ü¶â Owl returning to idle mode...');
                }
            }
        }

        // Refine/edit the last generated image
        async function refineImage(userRequest) {
            if (imageHistory.length === 0) return;

            const input = document.getElementById('chatInput');
            isGenerating = true;
            document.getElementById('chatSendBtn').disabled = true;

            // Show loading state
            const emptyMessage = document.getElementById('emptyMessage');
            const previewArea = document.getElementById('previewArea');

            const loadingMsg = document.createElement('div');
            loadingMsg.style.cssText = 'color: #DAA520; font-size: 1rem; padding: 20px; text-align: center;';
            loadingMsg.innerHTML = `üé® Refining image...`;
            previewArea.insertBefore(loadingMsg, previewArea.firstChild);

            try {
                console.log(`üîµ Refining image with user request: ${userRequest}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutes for quality retries

                // Build the parts array for the API request (CLEAN MODE - like Nano)
                const parts = [];

                // Add brand logo if available (no instruction text)
                if (brandLogoData) {
                    parts.push({
                        inline_data: {
                            mime_type: brandLogoData.mimeType,
                            data: brandLogoData.data
                        }
                    });
                    console.log('üé® Brand logo included in refinement request');
                }

                // Add uploaded photo if available (no instruction text)
                if (uploadedImageData) {
                    parts.push({
                        inline_data: {
                            mime_type: uploadedImageData.mimeType,
                            data: uploadedImageData.data
                        }
                    });
                    console.log('üì∏ Uploaded photo included in refinement request');
                }

                // üîë KEY: Add the PREVIOUS IMAGE so Gemini knows what to refine
                const lastImage = imageHistory[imageHistory.length - 1];
                if (lastImage && lastImage.data) {
                    parts.push({
                        inline_data: {
                            mime_type: 'image/png',
                            data: lastImage.data
                        }
                    });
                    console.log('üñºÔ∏è Previous image included for refinement context');
                }

                // Add user's refinement request ONLY (no modifications, no strategies, no instructions)
                parts.push({text: userRequest});

                console.log('üìã Refinement request sent to Gemini:', userRequest);
                console.log('üì¶ Total parts in refinement request:', parts.length);

                console.log('üì§ Sending refinement request to API...');

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            responseModalities: ["image"]
                        }
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('üü¢ Response received, status:', response.status);

                const data = await response.json();
                console.log('üì¶ Data received:', data);

                // Remove loading message
                loadingMsg.remove();

                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content;
                    const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                    if (imagePart) {
                        const inlineData = imagePart.inline_data || imagePart.inlineData;
                        let imageData = inlineData.data;
                        const mimeType = inlineData.mimeType || inlineData.mime_type || 'image/png';
                        let imageUrl = `data:${mimeType};base64,${imageData}`;

                        console.log('‚úÖ Gemini refined image successfully');

                        // üé® CLEAN MODE: Show original Gemini output without verification
                        // No automatic verification, no retry logic, no modifications
                        // User can manually fix spelling errors if needed using masking tools

                        // Get the last image for context
                        const lastImage = imageHistory[imageHistory.length - 1];
                        const lastPrompt = lastImage.prompt;

                        // Add to image history
                        imageHistory.push({
                            url: imageUrl,
                            data: imageData,
                            prompt: `${lastPrompt} (refined: ${userRequest})`,
                            timestamp: Date.now()
                        });

                        updateImageGallery();
                        input.value = '';
                        console.log('‚úÖ Image refined successfully!');
                    } else {
                        alert('‚ùå No image was generated');
                    }
                } else if (data.error) {
                    alert(`‚ùå API Error: ${data.error.message}`);
                } else {
                    alert('‚ùå Unexpected response');
                }

            } catch (error) {
                console.error('üî¥ Full error:', error);
                if (loadingMsg && loadingMsg.parentNode) {
                    loadingMsg.remove();
                }
                alert(`‚ùå Error: ${error.message}`);
            }

            isGenerating = false;
            document.getElementById('chatSendBtn').disabled = false;
        }

        async function sendMessage() {
            // This function is for the old chat-based mode, not used in template mode
            return;
            const input = document.getElementById('messageInput');
            let message = input.value.trim();

            if (!message || isGenerating) return;

            // Ensure user info is loaded
            if (!userInfo) {
                alert('Please enter your information first');
                return;
            }

            // Check if this is a market update request
            let marketData = null;
            let isMarketUpdate = false;
            if (isMarketUpdateRequest(message)) {
                isMarketUpdate = true;
                console.log('üìä Market update requested, fetching live data...');
                marketData = await fetchMarketData();

                // Enhance the message with market data AND LendWise design theme
                // Create a sophisticated, magazine-style layout (NOT a rate sheet)
                message = `Create an ELEGANT, SOPHISTICATED mortgage market insights graphic - think high-end financial magazine, NOT a boring rate sheet.

üé® VISUAL STYLE: ${LENDWISE_THEME.name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä CURRENT MARKET DATA (${marketData.date}):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ 30-Year Fixed: ${marketData.rates['30yr']} (${marketData.changes['30yr']})
‚Ä¢ 15-Year Fixed: ${marketData.rates['15yr']} (${marketData.changes['15yr']})
‚Ä¢ 10-Year Treasury: ${marketData.treasuries?.['10yr'] || 'N/A'}

MARKET INSIGHT: "${marketData.trend}"

üé® DESIGN REQUIREMENTS - SOPHISTICATED & MAGAZINE-STYLE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ú® OVERALL AESTHETIC:
‚Ä¢ Think: Forbes, Fortune, Bloomberg Businessweek - premium financial publication
‚Ä¢ Elegant, clean, sophisticated - NO cluttered rate sheet look
‚Ä¢ Visual storytelling with data - NOT just numbers in boxes
‚Ä¢ Professional confidence and trust - high-end financial advisory feel

üé® COLOR PALETTE (STRICTLY THESE ONLY):
‚Ä¢ Background: Deep navy gradient (${LENDWISE_THEME.colors.background.primary} ‚Üí ${LENDWISE_THEME.colors.background.secondary})
‚Ä¢ Primary accent: Metallic gold ${LENDWISE_THEME.colors.gold.metallic}
‚Ä¢ Highlight accent: Bright gold ${LENDWISE_THEME.colors.gold.bright}
‚Ä¢ Secondary accent: Forest green ${LENDWISE_THEME.colors.green.forest} and ${LENDWISE_THEME.colors.green.deep}
‚Ä¢ Text: Cream ${LENDWISE_THEME.colors.text.primary} for body, white for headlines

üìê LAYOUT APPROACH (1080x1350 Instagram portrait):

[TOP SECTION - HERO] (30% of space)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ LendWise gold owl logo (top-left, 100px, subtle gold glow)
‚Ä¢ Large, bold headline: "CURRENT MORTGAGE RATES" in bright gold ${LENDWISE_THEME.colors.gold.bright}
‚Ä¢ Subhead: "${marketData.date}" in elegant cream text
‚Ä¢ Subtle diagonal gold accent lines or geometric shapes in background

[MIDDLE SECTION - KEY RATE SPOTLIGHT] (40% of space)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Feature the 30-YEAR FIXED rate as the STAR:
  - Display "${marketData.rates['30yr']}" in HUGE metallic gold numbers (80pt+)
  - Below it: "30-Year Fixed" in elegant small caps
  - Change indicator "${marketData.changes['30yr']}" with subtle arrow (green if up, bronze if down)
‚Ä¢ Side panel or elegant card showing other popular rate:
  - 15-Year: ${marketData.rates['15yr']}
  - Make this smaller but still prominent (30-40pt gold)
‚Ä¢ Elegant separators (thin gold lines or subtle forest green dividers)
‚Ä¢ NO boxes, NO borders - use whitespace and typography to separate

[BOTTOM SECTION - INSIGHT & CONTACT] (30% of space)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Market insight in an elegant text block:
  - Small gold header: "Market Insight"
  - 2-3 lines of cream text explaining the trend in SIMPLE, CLEAR language
  - Example: "Rates remain stable this week, creating excellent opportunities for homebuyers and refinancers."
‚Ä¢ Thin gold divider line
‚Ä¢ Contact footer with ${userInfo.name}'s information:
  - Name in gold: "${userInfo.name}"
  - Title in cream: "Senior Loan Officer | NMLS #${userInfo.nmls}"
  - Phone in gold: "${userInfo.phone}"
  - Small LendWise owl icon next to company name

‚ú® VISUAL ENHANCEMENTS FOR SOPHISTICATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Subtle geometric patterns in background (5-10% opacity gold triangles or hexagons)
‚Ä¢ Soft gold glow effects behind major elements
‚Ä¢ Professional drop shadows (very subtle, not harsh)
‚Ä¢ Use LOTS of whitespace - don't cram everything
‚Ä¢ Elegant typography hierarchy - large/small contrast
‚Ä¢ Thin accent lines in gold to guide the eye
‚Ä¢ NO rate "boxes" or "cards" with borders - use typography and spacing instead

üéØ CRITICAL DESIGN PRINCIPLES:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úì SIMPLICITY: Don't show every rate - highlight the most important ones
‚úì CLARITY: All text perfectly legible, easy to read at a glance
‚úì ELEGANCE: Magazine quality, not spreadsheet quality
‚úì HIERARCHY: Clear visual flow - what's most important should be largest
‚úì BREATHING ROOM: Generous spacing, not cramped
‚úì TRUST: Professional, authoritative, sophisticated aesthetic
‚úì STORYTELLING: Rates tell a story - make it visual and engaging

üö´ AVOID THESE (RATE SHEET MISTAKES):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úó NO rate tables or grids
‚úó NO cluttered layouts with every possible loan type
‚úó NO heavy borders or boxes around everything
‚úó NO boring, corporate spreadsheet look
‚úó NO small, hard-to-read text
‚úó NO overwhelming amount of data

Think: "What would Apple or a luxury brand do with mortgage rates?" Make it beautiful, simple, and sophisticated.`;
            }

            // Store the original simple message for display
            const originalMessage = input.value.trim();

            addMessage('user', originalMessage, null, null, false, '', isMarketUpdate);
            conversationHistory.push({role: 'user', text: originalMessage});
            input.value = '';

            isGenerating = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('sendBtn').textContent = 'Generating...';

            const loadingMsgIndex = document.getElementById('chatContainer').children.length;
            addMessage('assistant', '<span class="loading">ü¶â Nano Banana is generating your content...</span>');

            try {
                console.log('üîµ Starting API call...');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutes for quality retries // 60 second timeout

                // Build the parts array for the API request
                const parts = [];
                let promptText = '';

                // Always add brand logo first if available
                if (brandLogoData) {
                    parts.push({
                        inline_data: {
                            mime_type: brandLogoData.mimeType,
                            data: brandLogoData.data
                        }
                    });
                }

                // Add uploaded image if available
                if (uploadedImageData) {
                    console.log('üì∏ Including uploaded person photo in generation request');
                    parts.push({
                        inline_data: {
                            mime_type: uploadedImageData.mimeType,
                            data: uploadedImageData.data
                        }
                    });
                } else {
                    console.log('‚ÑπÔ∏è No uploaded photo - will generate without person');
                }

                // Check if this is a refinement request
                if (lastGeneratedPrompt && conversationHistory.length > 1) {
                    promptText = `${brandLogoData ? 'The first image is the LendWise Mortgages brand logo (gold owl). ' : ''}${uploadedImageData && brandLogoData ? 'The second image is the person\'s photo. ' : uploadedImageData ? 'The image is the person\'s photo. ' : ''}

Previous request: "${lastGeneratedPrompt}"

User wants to adjust the image: ${message}

CRITICAL REQUIREMENTS:
${brandLogoData ? '- USE THE EXACT LENDWISE LOGO from the first image - place it prominently in the design\n' : '- Include LendWise Mortgages branding with a gold owl logo\n'}${uploadedImageData ? '- USE THE EXACT PERSON FROM THE UPLOADED PHOTO - Do NOT generate a different person\n- Keep the person\'s face, features, and likeness IDENTICAL to the uploaded photo\n- Only modify elements specifically requested (clothing, background, etc.)\n' : ''}- Make ALL text crystal clear and perfectly readable
- Professional, high-quality design
- Ensure phone numbers, NMLS numbers, and rates are exact and legible
- Use appropriate aspect ratio for the content type
- Apply the requested changes while keeping everything else consistent`;
                } else {
                    // New image request
                    lastGeneratedPrompt = message;
                    promptText = `${brandLogoData ? 'The first image is the LendWise Mortgages brand logo (gold owl with "LENDWISE MORTGAGE" text). ' : ''}${uploadedImageData && brandLogoData ? 'The second image is the person\'s photo. ' : uploadedImageData ? 'The image is the person\'s photo. ' : ''}

${uploadedImageData ? 'IMPORTANT: Use the EXACT person from the uploaded photo. Do NOT generate a different person or change their appearance. ' : ''}Create a professional mortgage marketing image: ${message}

CRITICAL REQUIREMENTS:
${brandLogoData ? '- USE THE EXACT LENDWISE LOGO from the first image provided - place it prominently and clearly in the design\n' : '- Include LendWise Mortgages branding with a gold owl logo\n'}${uploadedImageData ? '- USE THE EXACT PERSON\'S FACE AND LIKENESS from the uploaded photo\n- Do NOT alter the person\'s facial features, identity, or appearance\n- Keep the person recognizable and identical to the source photo\n' : ''}- Make ALL text crystal clear and perfectly readable
- Professional, high-quality design
- Ensure phone numbers, NMLS numbers, and rates are exact and legible
- Use appropriate aspect ratio for the content type`;
                }

                parts.push({text: promptText});

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            responseModalities: ["image"]
                        }
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('üü¢ Response received, status:', response.status);

                const data = await response.json();
                console.log('üì¶ Data received:', data);

                // Remove loading message
                const container = document.getElementById('chatContainer');
                container.removeChild(container.children[loadingMsgIndex]);

                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content;
                    // Check both inline_data (snake_case) and inlineData (camelCase)
                    const imagePart = content.parts.find(part => part.inline_data || part.inlineData);

                    if (imagePart) {
                        const inlineData = imagePart.inline_data || imagePart.inlineData;
                        let imageData = inlineData.data;
                        const mimeType = inlineData.mimeType || inlineData.mime_type || 'image/png';
                        let imageUrl = `data:${mimeType};base64,${imageData}`;

                        addMessage('assistant', '‚úÖ Here\'s your generated content:', imageUrl, imageData, true, originalMessage, isMarketUpdate);
                        conversationHistory.push({role: 'assistant', hasImage: true});
                    } else {
                        addMessage('assistant', '‚ùå No image was generated. Response: ' + JSON.stringify(data, null, 2));
                    }
                } else if (data.error) {
                    addMessage('assistant', `‚ùå API Error: ${data.error.message}`);
                } else {
                    addMessage('assistant', '‚ùå Unexpected response: ' + JSON.stringify(data, null, 2));
                }

            } catch (error) {
                // Remove loading message if it exists
                const container = document.getElementById('chatContainer');
                if (container.children[loadingMsgIndex]) {
                    container.removeChild(container.children[loadingMsgIndex]);
                }

                console.error('üî¥ Full error:', error);

                if (error.name === 'AbortError') {
                    addMessage('assistant', `‚ùå Request timed out after 60 seconds. The API might be slow or experiencing issues.`);
                } else {
                    addMessage('assistant', `‚ùå Error: ${error.message}`);
                }
            }

            isGenerating = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('sendBtn').textContent = 'Generate';
        }

        function downloadImage(base64Data, timestamp) {
            const link = document.createElement('a');
            link.href = `data:image/png;base64,${base64Data}`;
            link.download = `wisr-ai-${timestamp}.png`;
            link.click();
        }

        // Auto-focus input
        document.getElementById('chatInput').focus();
    </script>
</body>
</html>
